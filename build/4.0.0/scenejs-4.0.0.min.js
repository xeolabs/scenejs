/*
 * SceneJS V4.0.0
 *
 * A WebGL-based 3D scene graph from xeographics
 * http://scenejs.org/
 *
 * Built on 2015-03-26
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeographics.com/
 *
 */

if(void 0===require){var requirejs,require,define;!function(ba){function J(e){return"[object Function]"===N.call(e)}function K(e){return"[object Array]"===N.call(e)}function z(e,t){if(e){var r;for(r=0;r<e.length&&(!e[r]||!t(e[r],r,e));r+=1);}}function O(e,t){if(e){var r;for(r=e.length-1;r>-1&&(!e[r]||!t(e[r],r,e));r-=1);}}function t(e,t){return ha.call(e,t)}function m(e,r){return t(e,r)&&e[r]}function H(e,r){for(var n in e)if(t(e,n)&&r(e[n],n))break}function S(e,r,n,i){return r&&H(r,function(r,o){(n||!t(e,o))&&(i&&"string"!=typeof r?(e[o]||(e[o]={}),S(e[o],r,n,i)):e[o]=r)}),e}function v(e,t){return function(){return t.apply(e,arguments)}}function ca(e){throw e}function da(e){if(!e)return e;var t=ba;return z(e.split("."),function(e){t=t[e]}),t}function B(e,t,r,n){return t=Error(t+"\nhttp://requirejs.org/docs/errors.html#"+e),t.requireType=e,t.requireModules=n,r&&(t.originalError=r),t}function ia(e){function r(e,t,r){var n,i,o,a,s,c,h,u=t&&t.split("/");n=u;var l=w.map,S=l&&l["*"];if(e&&"."===e.charAt(0))if(t){for(n=m(w.pkgs,t)?u=[t]:u.slice(0,u.length-1),t=e=n.concat(e.split("/")),n=0;t[n];n+=1)if(i=t[n],"."===i)t.splice(n,1),n-=1;else if(".."===i){if(1===n&&(".."===t[2]||".."===t[0]))break;n>0&&(t.splice(n-1,2),n-=2)}n=m(w.pkgs,t=e[0]),e=e.join("/"),n&&e===t+"/"+n.main&&(e=t)}else 0===e.indexOf("./")&&(e=e.substring(2));if(r&&l&&(u||S)){for(t=e.split("/"),n=t.length;n>0;n-=1){if(o=t.slice(0,n).join("/"),u)for(i=u.length;i>0;i-=1)if((r=m(l,u.slice(0,i).join("/")))&&(r=m(r,o))){a=r,s=n;break}if(a)break;!c&&S&&m(S,o)&&(c=m(S,o),h=n)}!a&&c&&(a=c,s=h),a&&(t.splice(0,s,a),e=t.join("/"))}return e}function n(e){A&&z(document.getElementsByTagName("script"),function(t){return t.getAttribute("data-requiremodule")===e&&t.getAttribute("data-requirecontext")===C.contextName?(t.parentNode.removeChild(t),!0):void 0})}function i(e){var t=m(w.paths,e);return t&&K(t)&&1<t.length?(n(e),t.shift(),C.require.undef(e),C.require([e]),!0):void 0}function o(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function a(e,t,n,i){var a,s,c=null,h=t?t.name:null,u=e,l=!0,S="";return e||(l=!1,e="_@r"+(O+=1)),e=o(e),c=e[0],e=e[1],c&&(c=r(c,h,i),s=m(D,c)),e&&(c?S=s&&s.normalize?s.normalize(e,function(e){return r(e,h,i)}):r(e,h,i):(S=r(e,h,i),e=o(S),c=e[0],S=e[1],n=!0,a=C.nameToUrl(S))),n=!c||s||n?"":"_unnormalized"+(P+=1),{prefix:c,name:S,parentMap:t,unnormalized:!!n,url:a,originalName:u,isDefine:l,id:(c?c+"!"+S:S)+n}}function s(e){var t=e.id,r=m(T,t);return r||(r=T[t]=new C.Module(e)),r}function c(e,r,n){var i=e.id,o=m(T,i);!t(D,i)||o&&!o.defineEmitComplete?(o=s(e),o.error&&"error"===r?n(o.error):o.on(r,n)):"defined"===r&&n(D[i])}function u(e,t){var r=e.requireModules,n=!1;t?t(e):(z(r,function(t){(t=m(T,t))&&(t.error=e,t.events.error&&(n=!0,t.emit("error",e)))}),n||h.onError(e))}function l(){U.length&&(ja.apply(F,[F.length-1,0].concat(U)),U=[])}function p(e){delete T[e],delete L[e]}function _(e,t,r){var n=e.map.id;e.error?e.emit("error",e.error):(t[n]=!0,z(e.depMaps,function(n,i){var o=n.id,a=m(T,o);a&&!e.depMatched[i]&&!r[o]&&(m(t,o)?(e.defineDep(i,D[o]),e.check()):_(a,t,r))}),r[n]=!0)}function d(){var e,t,r,o,a=(r=1e3*w.waitSeconds)&&C.startTime+r<(new Date).getTime(),s=[],c=[],h=!1,l=!0;if(!E){if(E=!0,H(L,function(r){if(e=r.map,t=e.id,r.enabled&&(e.isDefine||c.push(r),!r.error))if(!r.inited&&a)i(t)?h=o=!0:(s.push(t),n(t));else if(!r.inited&&r.fetched&&e.isDefine&&(h=!0,!e.prefix))return l=!1}),a&&s.length)return r=B("timeout","Load timeout for modules: "+s,null,s),r.contextName=C.contextName,u(r);l&&z(c,function(e){_(e,{},{})}),a&&!o||!h||!A&&!ea||x||(x=setTimeout(function(){x=0,d()},50)),E=!1}}function f(e){t(D,e[0])||s(a(e[0],null,!0)).init(e[1],e[2])}function g(e){var e=e.currentTarget||e.srcElement,t=C.onScriptLoad;return e.detachEvent&&!Z?e.detachEvent("onreadystatechange",t):e.removeEventListener("load",t,!1),t=C.onScriptError,(!e.detachEvent||Z)&&e.removeEventListener("error",t,!1),{node:e,id:e&&e.getAttribute("data-requiremodule")}}function y(){var e;for(l();F.length;){if(e=F.shift(),null===e[0])return u(B("mismatch","Mismatched anonymous define() module: "+e[e.length-1]));f(e)}}var E,b,C,N,x,w={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},shim:{},config:{}},T={},L={},M={},F=[],D={},k={},O=1,P=1;return N={require:function(e){return e.require?e.require:e.require=C.makeRequire(e.map)},exports:function(e){return e.usingExports=!0,e.map.isDefine?e.exports?e.exports:e.exports=D[e.map.id]={}:void 0},module:function(e){return e.module?e.module:e.module={id:e.map.id,uri:e.map.url,config:function(){var t=m(w.pkgs,e.map.id);return(t?m(w.config,e.map.id+"/"+t.main):m(w.config,e.map.id))||{}},exports:D[e.map.id]}}},b=function(e){this.events=m(M,e.id)||{},this.map=e,this.shim=m(w.shim,e.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},b.prototype={init:function(e,t,r,n){n=n||{},this.inited||(this.factory=t,r?this.on("error",r):this.events.error&&(r=v(this,function(e){this.emit("error",e)})),this.depMaps=e&&e.slice(0),this.errback=r,this.inited=!0,this.ignore=n.ignore,n.enabled||this.enabled?this.enable():this.check())},defineDep:function(e,t){this.depMatched[e]||(this.depMatched[e]=!0,this.depCount-=1,this.depExports[e]=t)},fetch:function(){if(!this.fetched){this.fetched=!0,C.startTime=(new Date).getTime();var e=this.map;if(!this.shim)return e.prefix?this.callPlugin():this.load();C.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],v(this,function(){return e.prefix?this.callPlugin():this.load()}))}},load:function(){var e=this.map.url;k[e]||(k[e]=!0,C.load(this.map.id,e))},check:function(){if(this.enabled&&!this.enabling){var e,t,r=this.map.id;t=this.depExports;var n=this.exports,i=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,1>this.depCount&&!this.defined){if(J(i)){if(this.events.error&&this.map.isDefine||h.onError!==ca)try{n=C.execCb(r,i,t,n)}catch(o){e=o}else n=C.execCb(r,i,t,n);if(this.map.isDefine&&((t=this.module)&&void 0!==t.exports&&t.exports!==this.exports?n=t.exports:void 0===n&&this.usingExports&&(n=this.exports)),e)return e.requireMap=this.map,e.requireModules=this.map.isDefine?[this.map.id]:null,e.requireType=this.map.isDefine?"define":"require",u(this.error=e)}else n=i;this.exports=n,this.map.isDefine&&!this.ignore&&(D[r]=n,h.onResourceLoad)&&h.onResourceLoad(C,this.map,this.depMaps),p(r),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else this.fetch()}},callPlugin:function(){var e=this.map,n=e.id,i=a(e.prefix);this.depMaps.push(i),c(i,"defined",v(this,function(i){var o,l;l=this.map.name;var S=this.map.parentMap?this.map.parentMap.name:null,_=C.makeRequire(e.parentMap,{enableBuildCallback:!0});this.map.unnormalized?(i.normalize&&(l=i.normalize(l,function(e){return r(e,S,!0)})||""),i=a(e.prefix+"!"+l,this.map.parentMap),c(i,"defined",v(this,function(e){this.init([],function(){return e},null,{enabled:!0,ignore:!0})})),(l=m(T,i.id))&&(this.depMaps.push(i),this.events.error&&l.on("error",v(this,function(e){this.emit("error",e)})),l.enable())):(o=v(this,function(e){this.init([],function(){return e},null,{enabled:!0})}),o.error=v(this,function(e){this.inited=!0,this.error=e,e.requireModules=[n],H(T,function(e){0===e.map.id.indexOf(n+"_unnormalized")&&p(e.map.id)}),u(e)}),o.fromText=v(this,function(r,i){var c=e.name,l=a(c),S=Q;i&&(r=i),S&&(Q=!1),s(l),t(w.config,n)&&(w.config[c]=w.config[n]);try{h.exec(r)}catch(p){return u(B("fromtexteval","fromText eval for "+n+" failed: "+p,p,[n]))}S&&(Q=!0),this.depMaps.push(l),C.completeLoad(c),_([c],o)}),i.load(e.name,_,o,w))})),C.enable(i,this),this.pluginMaps[i.id]=i},enable:function(){L[this.map.id]=this,this.enabling=this.enabled=!0,z(this.depMaps,v(this,function(e,r){var n,i;if("string"==typeof e){if(e=a(e,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[r]=e,n=m(N,e.id))return void(this.depExports[r]=n(this));this.depCount+=1,c(e,"defined",v(this,function(e){this.defineDep(r,e),this.check()})),this.errback&&c(e,"error",v(this,this.errback))}n=e.id,i=T[n],!t(N,n)&&i&&!i.enabled&&C.enable(e,this)})),H(this.pluginMaps,v(this,function(e){var t=m(T,e.id);t&&!t.enabled&&C.enable(e,this)})),this.enabling=!1,this.check()},on:function(e,t){var r=this.events[e];r||(r=this.events[e]=[]),r.push(t)},emit:function(e,t){z(this.events[e],function(e){e(t)}),"error"===e&&delete this.events[e]}},C={config:w,contextName:e,registry:T,defined:D,urlFetched:k,defQueue:F,Module:b,makeModuleMap:a,nextTick:h.nextTick,onError:u,configure:function(e){e.baseUrl&&"/"!==e.baseUrl.charAt(e.baseUrl.length-1)&&(e.baseUrl+="/");var t=w.pkgs,r=w.shim,n={paths:!0,config:!0,map:!0};H(e,function(e,t){n[t]?"map"===t?(w.map||(w.map={}),S(w[t],e,!0,!0)):S(w[t],e,!0):w[t]=e}),e.shim&&(H(e.shim,function(e,t){K(e)&&(e={deps:e}),!e.exports&&!e.init||e.exportsFn||(e.exportsFn=C.makeShimExports(e)),r[t]=e}),w.shim=r),e.packages&&(z(e.packages,function(e){e="string"==typeof e?{name:e}:e,t[e.name]={name:e.name,location:e.location||e.name,main:(e.main||"main").replace(ka,"").replace(fa,"")}}),w.pkgs=t),H(T,function(e,t){!e.inited&&!e.map.unnormalized&&(e.map=a(t))}),(e.deps||e.callback)&&C.require(e.deps||[],e.callback)},makeShimExports:function(e){return function(){var t;return e.init&&(t=e.init.apply(ba,arguments)),t||e.exports&&da(e.exports)}},makeRequire:function(n,i){function o(r,c,l){var S,p;return i.enableBuildCallback&&c&&J(c)&&(c.__requireJsBuild=!0),"string"==typeof r?J(c)?u(B("requireargs","Invalid require call"),l):n&&t(N,r)?N[r](T[n.id]):h.get?h.get(C,r,n,o):(S=a(r,n,!1,!0),S=S.id,t(D,S)?D[S]:u(B("notloaded",'Module name "'+S+'" has not been loaded yet for context: '+e+(n?"":". Use require([])")))):(y(),C.nextTick(function(){y(),p=s(a(null,n)),p.skipMap=i.skipMap,p.init(r,c,l,{enabled:!0}),d()}),o)}return i=i||{},S(o,{isBrowser:A,toUrl:function(e){var t,i=e.lastIndexOf("."),o=e.split("/")[0];return-1!==i&&("."!==o&&".."!==o||i>1)&&(t=e.substring(i,e.length),e=e.substring(0,i)),C.nameToUrl(r(e,n&&n.id,!0),t,!0)},defined:function(e){return t(D,a(e,n,!1,!0).id)},specified:function(e){return e=a(e,n,!1,!0).id,t(D,e)||t(T,e)}}),n||(o.undef=function(e){l();var t=a(e,n,!0),r=m(T,e);delete D[e],delete k[t.url],delete M[e],r&&(r.events.defined&&(M[e]=r.events),p(e))}),o},enable:function(e){m(T,e.id)&&s(e).enable()},completeLoad:function(e){var r,n,o=m(w.shim,e)||{},a=o.exports;for(l();F.length;){if(n=F.shift(),null===n[0]){if(n[0]=e,r)break;r=!0}else n[0]===e&&(r=!0);f(n)}if(n=m(T,e),!r&&!t(D,e)&&n&&!n.inited){if(w.enforceDefine&&(!a||!da(a)))return i(e)?void 0:u(B("nodefine","No define call for "+e,null,[e]));f([e,o.deps||[],o.exportsFn])}d()},nameToUrl:function(e,t,r){var n,i,o,a,s,c;if(h.jsExtRegExp.test(e))a=e+(t||"");else{for(n=w.paths,i=w.pkgs,a=e.split("/"),s=a.length;s>0;s-=1){if(c=a.slice(0,s).join("/"),o=m(i,c),c=m(n,c)){K(c)&&(c=c[0]),a.splice(0,s,c);break}if(o){e=e===o.name?o.location+"/"+o.main:o.location,a.splice(0,s,e);break}}a=a.join("/"),a+=t||(/\?/.test(a)||r?"":".js"),a=("/"===a.charAt(0)||a.match(/^[\w\+\.\-]+:/)?"":w.baseUrl)+a}return w.urlArgs?a+((-1===a.indexOf("?")?"?":"&")+w.urlArgs):a},load:function(e,t){h.load(C,e,t)},execCb:function(e,t,r,n){return t.apply(n,r)},onScriptLoad:function(e){("load"===e.type||la.test((e.currentTarget||e.srcElement).readyState))&&(R=null,e=g(e),C.completeLoad(e.id))},onScriptError:function(e){var t=g(e);return i(t.id)?void 0:u(B("scripterror","Script error for: "+t.id,e,[t.id]))}},C.require=C.makeRequire(),C}var h,x,y,E,L,F,R,M,s,ga,ma=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,na=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,fa=/\.js$/,ka=/^\.\//;x=Object.prototype;var N=x.toString,ha=x.hasOwnProperty,ja=Array.prototype.splice,A=!("undefined"==typeof window||!navigator||!window.document),ea=!A&&"undefined"!=typeof importScripts,la=A&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,Z="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),G={},u={},U=[],Q=!1;if("undefined"==typeof define){if("undefined"!=typeof requirejs){if(J(requirejs))return;u=requirejs,requirejs=void 0}"undefined"!=typeof require&&!J(require)&&(u=require,require=void 0),h=requirejs=function(e,t,r,n){var i,o="_";return!K(e)&&"string"!=typeof e&&(i=e,K(t)?(e=t,t=r,r=n):e=[]),i&&i.context&&(o=i.context),(n=m(G,o))||(n=G[o]=h.s.newContext(o)),i&&n.configure(i),n.require(e,t,r)},h.config=function(e){return h(e)},h.nextTick="undefined"!=typeof setTimeout?function(e){setTimeout(e,4)}:function(e){e()},require||(require=h),h.version="2.1.6",h.jsExtRegExp=/^\/|:|\?|\.js$/,h.isBrowser=A,x=h.s={contexts:G,newContext:ia},h({}),z(["toUrl","undef","defined","specified"],function(e){h[e]=function(){var t=G._;return t.require[e].apply(t,arguments)}}),A&&(y=x.head=document.getElementsByTagName("head")[0],E=document.getElementsByTagName("base")[0])&&(y=x.head=E.parentNode),h.onError=ca,h.load=function(e,t,r){var n,i=e&&e.config||{};if(A)return n=i.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),n.type=i.scriptType||"text/javascript",n.charset="utf-8",n.async=!0,n.setAttribute("data-requirecontext",e.contextName),n.setAttribute("data-requiremodule",t),!n.attachEvent||n.attachEvent.toString&&0>n.attachEvent.toString().indexOf("[native code")||Z?(n.addEventListener("load",e.onScriptLoad,!1),n.addEventListener("error",e.onScriptError,!1)):(Q=!0,n.attachEvent("onreadystatechange",e.onScriptLoad)),n.src=r,M=n,E?y.insertBefore(n,E):y.appendChild(n),M=null,n;if(ea)try{importScripts(r),e.completeLoad(t)}catch(o){e.onError(B("importscripts","importScripts failed for "+t+" at "+r,o,[t]))}},A&&O(document.getElementsByTagName("script"),function(e){return y||(y=e.parentNode),(L=e.getAttribute("data-main"))?(s=L,u.baseUrl||(F=s.split("/"),s=F.pop(),ga=F.length?F.join("/")+"/":"./",u.baseUrl=ga),s=s.replace(fa,""),h.jsExtRegExp.test(s)&&(s=L),u.deps=u.deps?u.deps.concat(s):[s],!0):void 0}),define=function(e,t,r){var n,i;"string"!=typeof e&&(r=t,t=e,e=null),K(t)||(r=t,t=null),!t&&J(r)&&(t=[],r.length&&(r.toString().replace(ma,"").replace(na,function(e,r){t.push(r)}),t=(1===r.length?["require"]:["require","exports","module"]).concat(t))),Q&&((n=M)||(R&&"interactive"===R.readyState||O(document.getElementsByTagName("script"),function(e){return"interactive"===e.readyState?R=e:void 0}),n=R),n&&(e||(e=n.getAttribute("data-requiremodule")),i=G[n.getAttribute("data-requirecontext")])),(i?i.defQueue:U).push([e,t,r])},define.amd={jQuery:!0},h.exec=function(b){return eval(b)},h(u)}}(this)}WebGLDebugUtils=function(){function e(e){if(null==S){S={};for(var t in e)"number"==typeof e[t]&&(S[e[t]]=t)}}function t(){if(null==S)throw"WebGLDebugUtils.init(ctx) not called"}function r(e){return t(),void 0!==S[e]}function n(e){t();var r=S[e];return void 0!==r?r:"*UNKNOWN WebGL ENUM (0x"+e.toString(16)+")"}function i(e,t,r){var i=l[e];return void 0!==i&&i[t]?n(r):null===r?"null":void 0===r?"undefined":r.toString()}function o(e,t){for(var r="",n=0;n<t.length;++n)r+=(0==n?"":", ")+i(e,n,t[n]);return r}function a(e,t,r){e.__defineGetter__(r,function(){return t[r]}),e.__defineSetter__(r,function(e){t[r]=e})}function s(t,r,o){function s(e,t){return function(){o&&o(t,arguments);var n=e[t].apply(e,arguments),i=e.getError();return 0!=i&&(c[i]=!0,r(i,t,arguments)),n}}e(t),r=r||function(e,t,r){for(var o="",a=0;a<r.length;++a)o+=(0==a?"":", ")+i(t,a,r[a]);u("WebGL error "+n(e)+" in "+t+"("+o+")")};var c={},h={};for(var l in t)"function"==typeof t[l]?h[l]=s(t,l):a(h,t,l);return h.getError=function(){for(var e in c)if(c.hasOwnProperty(e)&&c[e])return c[e]=!1,e;return t.NO_ERROR},h}function c(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);for(var n=0;t>n;++n)e.disableVertexAttribArray(n),e.vertexAttribPointer(n,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(n,0);e.deleteBuffer(r);for(var i=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),n=0;i>n;++n)e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);for(e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),e.colorMask(!0,!0,!0,!0),e.cullFace(e.BACK),e.depthFunc(e.LESS),e.depthMask(!0),e.depthRange(0,1),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.UNPACK_COLORSPACE_CONVERSION_WEBGL&&e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.polygonOffset(0,0),e.sampleCoverage(1,!1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilMask(4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.getError(););}function h(e){function t(e){return"function"==typeof e?e:function(t){e.handleEvent(t)}}function r(e){var t=e.addEventListener;e.addEventListener=function(r,n){switch(r){case"webglcontextlost":b(n);break;case"webglcontextrestored":C(n);break;default:t.apply(e,arguments)}}}function n(){for(var e=Object.keys(E),t=0;t<e.length;++t)delete E[e]}function i(){++y,f||g==y&&e.loseContext()}function o(e,t){var r=e[t];return function(){if(i(),!f){var t=r.apply(e,arguments);return t}}}function s(){for(var e=0;e<m.length;++e){var t=m[e];t instanceof WebGLBuffer?l.deleteBuffer(t):t instanceof WebGLFramebuffer?l.deleteFramebuffer(t):t instanceof WebGLProgram?l.deleteProgram(t):t instanceof WebGLRenderbuffer?l.deleteRenderbuffer(t):t instanceof WebGLShader?l.deleteShader(t):t instanceof WebGLTexture&&l.deleteTexture(t)}}function h(e){return{statusMessage:e,preventDefault:function(){v=!0}}}function u(e){for(var t in e)"function"==typeof e[t]?S[t]=o(e,t):a(S,e,t);S.getError=function(){if(i(),!f)for(var e;e=l.getError();)E[e]=!0;for(var e in E)if(E[e])return delete E[e],e;return S.NO_ERROR};for(var r=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],n=0;n<r.length;++n){var s=r[n];S[s]=function(t){return function(){if(i(),f)return null;var r=t.apply(e,arguments);return r.__webglDebugContextLostId__=d,m.push(r),r}}(e[s])}for(var c=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"],n=0;n<c.length;++n){var s=c[n];S[s]=function(t){return function(){return i(),f?null:t.apply(e,arguments)}}(S[s])}for(var h=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"],n=0;n<h.length;++n){var s=h[n];S[s]=function(t){return function(){return i(),f?!1:t.apply(e,arguments)}}(S[s])}return S.checkFramebufferStatus=function(t){return function(){return i(),f?S.FRAMEBUFFER_UNSUPPORTED:t.apply(e,arguments)}}(S.checkFramebufferStatus),S.getAttribLocation=function(t){return function(){return i(),f?-1:t.apply(e,arguments)}}(S.getAttribLocation),S.getVertexAttribOffset=function(t){return function(){return i(),f?0:t.apply(e,arguments)}}(S.getVertexAttribOffset),S.isContextLost=function(){return f},S}var l,S,p=[],_=[],S={},d=1,f=!1,m=[],g=0,y=0,v=!1,J=0,E={};e.getContext=function(t){return function(){var r=t.apply(e,arguments);if(r instanceof WebGLRenderingContext){if(r!=l){if(l)throw"got different context";l=r,S=u(l)}return S}return r}}(e.getContext);var b=function(e){p.push(t(e))},C=function(e){_.push(t(e))};return r(e),e.loseContext=function(){if(!f){for(f=!0,g=0,++d;l.getError(););n(),E[l.CONTEXT_LOST_WEBGL]=!0;var t=h("context lost"),r=p.slice();setTimeout(function(){for(var n=0;n<r.length;++n)r[n](t);J>=0&&setTimeout(function(){e.restoreContext()},J)},0)}},e.restoreContext=function(){f&&_.length&&setTimeout(function(){if(!v)throw"can not restore. webglcontestlost listener did not call event.preventDefault";s(),c(l),f=!1,y=0,v=!1;for(var e=_.slice(),t=h("context restored"),r=0;r<e.length;++r)e[r](t)},0)},e.loseContextInNCalls=function(e){if(f)throw"You can not ask a lost contet to be lost";g=y+e},e.getNumCalls=function(){return y},e.setRestoreTimeout=function(e){J=e},e}var u=function(e){window.console&&window.console.log&&window.console.log(e)},l={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},S=null;return{init:e,mightBeEnum:r,glEnumToString:n,glFunctionArgToString:i,glFunctionArgsToString:o,makeDebugContext:s,makeLostContextSimulatingCanvas:h,resetToInitialState:c}}();var SceneJS_Map=function(e,t){this.items=e||[];var r=t||0,n=r+1;this.addItem=function(){var e;if(2==arguments.length){var t=arguments[0];if(e=arguments[1],this.items[t])throw SceneJS_error.fatalError(SceneJS.errors.ID_CLASH,"ID clash: '"+t+"'");return this.items[t]=e,t}for(;;){e=arguments[0];var r=n++;if(!this.items[r])return this.items[r]=e,r}},this.removeItem=function(e){delete this.items[e]}},SceneJS=new function(){this.VERSION="3.2",this._baseStateId=0,this._handleMap=new SceneJS_Map,this._topicSubs={},this._handleTopics={},this._topicPubs={},this._engines={},this._engineIds=new SceneJS_Map,this.publish=function(e,t,r){r||(this._topicPubs[e]=t);var n=this._topicSubs[e];if(n)for(var i in n)n.hasOwnProperty(i)&&n[i].call(this,t)},this.unpublish=function(e){var t=this._topicSubs[e];if(t)for(var r in t)t.hasOwnProperty(r)&&t[r].call(this,null);delete this._topicPubs[e]},this.on=function(e,t){var r=this._topicSubs[e];r||(r={},this._topicSubs[e]=r);var n=this._handleMap.addItem();r[n]=t,this._handleTopics[n]=e;var i=this._topicPubs[e];return i&&t.call(this,i),n},this.off=function(e){var t=this._handleTopics[e];if(t){delete this._handleTopics[e];var r=this._topicSubs[t];r&&delete r[e],this._handleMap.removeItem(e),"rendered"==t&&this._engine.branchDirty(this)}},this.once=function(e,t){var r=this,n=this.on(e,function(e){r.off(n),t(e)})},this.createScene=function(e,t){if(e=e||{},e.id){if(this._engines[e.id])throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Scene already exists with this ID: '"+e.id+"'");this._engineIds.addItem(e.id,{})}else e.id=this._engineIds.addItem({});var r=new SceneJS_Engine(e,t);return this._engines[e.id]=r,SceneJS_events.fireEvent(SceneJS_events.SCENE_CREATED,{engine:r}),r.scene.start(t),r.scene},this.scene=function(e){var t=this._engines[e];return t?t.scene:null},this.getScene=function(e){if(!e)for(var e in this._engines)if(this._engines.hasOwnProperty(e))return this._engines[e].scene;var t=this._engines[e];return t?t.scene:null},this.getScenes=function(){var e={};for(var t in this._engines)this._engines.hasOwnProperty(t)&&(e[t]=this._engines[t].scene);return e},this._isArray=function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},this._shallowClone=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},this._applyIf=function(e,t){for(var r in e)e.hasOwnProperty(r)&&(void 0==t[r]||null==t[r])&&(t[r]=e[r]);return t},this._apply=function(e,t,r){var n;if(r)for(n in t)t.hasOwnProperty(n)&&delete t[n];for(n in e)e.hasOwnProperty(n)&&void 0!=e[n]&&(t[n]=e[n]);return t};var e=Object.prototype.hasOwnProperty;this._isEmpty=function(t){if(null==t)return!0;if(t.length>0)return!1;if(0===t.length)return!0;for(var r in t)if(e.call(t,r))return!1;return!0},this.reset=function(){var e=[];for(var t in this._engines)this._engines.hasOwnProperty(t)&&(e.push(this._engines[t]),delete this._engines[t],this._engineIds.removeItem(t));for(;e.length>0;)e.pop().destroy();SceneJS_events.fireEvent(SceneJS_events.RESET)}};!function(){var e;SceneJS.on("configs",function(t){if(t.pluginPath!=e){e=t.pluginPath;var r=e+"/lib";require.config({paths:{scenejsPluginDeps:r}})}})}();var SceneJS_eventManager=function(){this._handlerIds=new SceneJS_Map,this.typeHandlers={}};SceneJS_eventManager.prototype.createEvent=function(e){this.typeHandlers[e]||(this.typeHandlers[e]={handlers:{},numSubs:0})},SceneJS_eventManager.prototype.onEvent=function(e,t){var r=this.typeHandlers[e]||(this.typeHandlers[e]={handlers:{},numSubs:0}),n=this._handlerIds.addItem(e),i=r.handlers;return i[n]=t,r.numSubs++,n},SceneJS_eventManager.prototype.fireEvent=function(e,t){var r=this.typeHandlers[e]||(this.typeHandlers[e]={handlers:{},numSubs:0});if(r.numSubs>0){var n=r.handlers;for(var i in n)n.hasOwnProperty(i)&&n[i](t)}},SceneJS_eventManager.prototype.unEvent=function(e){var t=this._handlerIds.items[e];if(t){this._handlerIds.removeItem(e);var r=this.typeHandlers[t];r&&(delete r[e],this.typeHandlers[t].numSubs--)}},SceneJS.Plugins=new function(){function e(e,r,o,a){var s=n[e]||(n[e]={});s[r]=a,t(o,0,function(){for(var t=e+r,n=i[t]||(i[t]=[]);n.length>0;)n.pop()(a);delete i[t]})}function t(e,n,i){if(!e||n>=e.length)return void i();var o=e[n],a=SceneJS_configsModule.configs.pluginPath;if(!a)throw"no pluginPath config";o=a+"/"+o,r(o,function(){t(e,n+1,i)})}function r(e,t){var r=document.createElement("script");r.type="text/javascript",r.readyState?r.onreadystatechange=function(){("loaded"==r.readyState||"complete"==r.readyState)&&(r.onreadystatechange=null,t&&t())}:r.onload=function(){t&&t()},r.src=e,document.getElementsByTagName("head")[0].appendChild(r)}var n={},i={};this.addPlugin=function(){var t,r,n=arguments[0],i=arguments[1];4==arguments.length?(t=arguments[2],r=arguments[3]):r=arguments[2],e(n,i,t,r)},this.hasPlugin=function(e,t){var r=n[e];return r&&!!r[t]},this.getPlugin=function(e,t,o){var a=n[e];if(a){var s=a[t];if(s)return void o(s)}var c=e+t,h=i[c]||(i[c]=[]);if(h.push(o),!(h.length>1)){var u=SceneJS_configsModule.configs.pluginPath;if(!u)throw"no pluginPath config";var l=u+"/"+e+"/"+t+".js";r(l)}}};var SceneJS_events=new function(){this.ERROR=0,this.RESET=1,this.NODE_CREATED=2,this.SCENE_CREATED=3,this.SCENE_COMPILING=4,this.SCENE_DESTROYED=5,this.OBJECT_COMPILING=6,this.WEBGL_CONTEXT_LOST=7,this.WEBGL_CONTEXT_RESTORED=8;var e=[];this.addListener=function(t,r,n){var i=e[t];i||(i=[],e[t]=i);for(var o={command:r,priority:void 0==n?i.length:n},a=-1,s=0,c=i.length;c>s;s++)if(!i[s]){a=s;break}0>a&&(i.push(o),a=i.length-1);var h=t+"."+a;return h},this.removeListener=function(t){var r=t.lastIndexOf("."),n=parseInt(t.substr(0,r)),i=parseInt(t.substr(r+1)),o=e[n];o&&delete o[i]},this.fireEvent=function(t,r){var n=e[t];if(n){r=r||{};for(var i=0;i<n.length;i++)n[i]&&n[i].command(r)}}};SceneJS.bind=function(e,t){switch(e){case"error":return SceneJS_events.addListener(SceneJS_events.ERROR,t);case"reset":return SceneJS_events.addListener(SceneJS_events.RESET,function(){t()});case"webglcontextlost":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_LOST,function(e){t(e)});case"webglcontextrestored":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(e){t(e)});default:throw SceneJS_error.fatalError("SceneJS.bind - this event type not supported: '"+e+"'")}},SceneJS.onEvent=SceneJS.bind,SceneJS.unEvent=function(e){return SceneJS_events.removeListener(e)},SceneJS.subscribe=SceneJS.addListener=SceneJS.onEvent=SceneJS.bind,SceneJS.unsubscribe=SceneJS.unEvent,SceneJS.on=SceneJS.onEvent,SceneJS.off=SceneJS.unEvent;var SceneJS_Canvas=function(e,t,r,n){if(this.canvasId,!t){t="canvas-"+e;var i=document.getElementsByTagName("body")[0],o=document.createElement("div"),a=o.style;a.height="100%",a.width="100%",a.padding="0",a.margin="0",a.left="0",a.top="0",a.position="absolute",o.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>',i.appendChild(o)}var s=document.getElementById(t);if(!s)throw SceneJS_error.fatalError(SceneJS.errors.CANVAS_NOT_FOUND,"SceneJS.Scene attribute 'canvasId' does not match any elements in the page");this.canvasId=t,this.options=n||{},this.canvas=this.options.simulateWebGLContextLost?WebGLDebugUtils.makeLostContextSimulatingCanvas(s):s,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.contextAttr=r,this.gl=null,this.initWebGL()};SceneJS_Canvas.prototype._WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],SceneJS_Canvas.prototype.initWebGL=function(){for(var e=0;!this.gl&&e<this._WEBGL_CONTEXT_NAMES.length;e++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[e],this.contextAttr)}catch(t){}if(!this.gl)throw SceneJS_error.fatalError(SceneJS.errors.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")},SceneJS_Canvas.prototype.loseWebGLContext=function(){this.options.simulateWebGLContextLost&&this.canvas.loseContext()};var SceneJS_Engine=function(e,t){e.type="scene",this.id=e.id,this._numPasses=e.numPasses||1,this.canvas=new SceneJS_Canvas(this.id,e.canvasId,e.contextAttr,t),this.events=new SceneJS_eventManager,this._coreFactory=new SceneJS_CoreFactory,this._nodeFactory=new SceneJS_NodeFactory,this.display=new SceneJS_Display({canvas:this.canvas,transparent:e.transparent,dof:e.dof}),this.sceneDirty=!1,this._sceneBranchesDirty=!1,this._nodesToDestroy=[],this._numNodesToDestroy=0,this.running=!1,this.paused=!1,this.destroyed=!1,this.sceneStatus={nodes:{},numTasks:0};var r=this,n=e.nodes;e.nodes=null,this.scene=this.createNode(e),n&&(e.nodes=n,this.scene.addNodes(n)),this.canvas.canvas.addEventListener("webglcontextlost",function(e){e.preventDefault(),r.stop(),SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_LOST,{scene:r.scene})},!1),this.canvas.canvas.addEventListener("webglcontextrestored",function(){r.canvas.initWebGL(),r._coreFactory.webglRestored(),r.display.webglRestored(),SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_RESTORED,{scene:r.scene}),r.start()},!1)};SceneJS_Engine.prototype.setNumPasses=function(e){this._numPasses=e},SceneJS_Engine.prototype.loseWebGLContext=function(){this.canvas.loseWebGLContext()},SceneJS_Engine.prototype.getNodeType=function(e,t){SceneJS_NodeFactory.getNodeType(e,t)},SceneJS_Engine.prototype.hasNodeType=function(e){return!!SceneJS_NodeFactory.nodeTypes[e]},SceneJS_Engine.prototype.createNode=function(e,t){this._doDestroyNodes(),e.type=e.type||"node";var r=this._coreFactory.getCore(e.type,e.coreId),n=this;return this._nodeFactory.getNode(this,e,r,function(r){if(!r._fromPlugin&&e.nodes)for(var i=0,o=0,a=e.nodes.length;a>o;o++)n.createNode(e.nodes[o],function(e){r.addNode(e),++i==a&&(t&&t(r),n.scene.publish("nodes/"+r.id,r))
});else t&&(t(r),n.scene.publish("nodes/"+r.id,r))})},SceneJS_Engine.prototype._doDestroyNodes=function(){for(var e;this._numNodesToDestroy>0;)e=this._nodesToDestroy[--this._numNodesToDestroy],e._doDestroy(),this._coreFactory.putCore(e._core),this._nodeFactory.putNode(e)},SceneJS_Engine.prototype.findNode=function(e){return this._nodeFactory.nodes.items[e]},SceneJS_Engine.prototype.findNodes=function(e){var t=new RegExp(e),r=[],n=this._nodeFactory.nodes.items;for(var i in n)n.hasOwnProperty(i)&&t.test(i)&&r.push(n[i]);return r},SceneJS_Engine.prototype.hasCore=function(e,t){return this._coreFactory.hasCore(e,t)},SceneJS_Engine.prototype.branchDirty=function(e){if(!this.sceneDirty&&e!=window){e.branchDirty=!0,e.dirty=!0;for(var t=e.parent;t&&!t.dirty&&!t.branchDirty;t=t.parent)t.dirty=!0;this._sceneBranchesDirty=!0}},SceneJS_Engine.prototype.renderFrame=function(e){var t=!1;if(this._needCompile()||e&&e.force)for(var r=(new Date).getTime(),n=e&&e.force,i=0;i<this._numPasses;i++)this.scene.publish("rendering",{pass:i}),this._doCompile(),this.display.render({clear:0==i,force:n}),this.scene.publish("rendered",{sceneId:this.id,time:r,pass:i}),t=!0;return t},SceneJS_Engine.prototype.start=function(){if(!this.running){this.running=!0,this.paused=!1,this.sceneDirty=!0;var e,t,r=this,n="__scenejs_sceneLoop"+this.id,i=!1,o=(new Date).getTime(),a=o,s=o,c=this.scene,h=!1,u=this.canvas.canvas,l=null,S=null;this.events.fireEvent("started",{sceneId:r.id,startTime:s}),window[n]=function(){if(e=u.width=u.clientWidth,t=u.height=u.clientHeight,(e!=l||t!=S)&&(c.publish("canvasSize",{width:e,height:t,aspect:e/t}),r.display.imageDirty=!0,l=e,S=t),r.running&&!r.paused){if(o=(new Date).getTime(),c.publish("tick",{sceneId:r.id,startTime:s,prevTime:a,time:o}),a=o,!r.running)return;h=!1;for(var p=0;p<r._numPasses;p++)(r._needCompile()||h)&&(i=!1,c.publish("rendering",{pass:p}),r._doCompile(),r.display.render({clear:0==p}),c.publish("rendered",{sceneId:r.id,time:o,pass:p}),h=!0);h||(i||c.publish("sleep",{sceneId:r.id,startTime:s,prevTime:o,time:o}),i=!0)}r.running&&window.requestAnimationFrame(window[n])},window.requestAnimationFrame(window[n])}},SceneJS_Engine.prototype.pick=function(e,t,r){this._needCompile()&&this._doCompile();var n=this.display.pick({canvasX:e,canvasY:t,rayPick:r?r.rayPick:!1});return n},SceneJS_Engine.prototype.readPixels=function(e,t){return this._needCompile()&&this._doCompile(),this.display.readPixels(e,t)},SceneJS_Engine.prototype._needCompile=function(){return this.display.imageDirty||this.display.drawListDirty||this.display.stateSortDirty||this.display.stateOrderDirty||this.display.objectListDirty||this._sceneBranchesDirty||this.sceneDirty},SceneJS_Engine.prototype._doCompile=function(){if(this._sceneBranchesDirty||this.sceneDirty){this._sceneBranchesDirty=!1,SceneJS_events.fireEvent(SceneJS_events.SCENE_COMPILING,{engine:this}),this.pubSubProxy=new SceneJS_PubSubProxy(this.scene,null);var e={pubSubProxy:this.pubSubProxy};this.scene._compileNodes(e),this.sceneDirty=!1}this._doDestroyNodes()},SceneJS_Engine.prototype.pause=function(e){this.paused=e},SceneJS_Engine.prototype.stop=function(){this.running&&(this.running=!1,this.paused=!1,window["__scenejs_sceneLoop"+this.id]=null)},SceneJS_Engine.prototype.destroyNode=function(e){this._nodesToDestroy[this._numNodesToDestroy++]=e;var t=this.sceneStatus.nodes[e.id];t&&(this.sceneStatus.numTasks-=t.numTasks,delete this.sceneStatus.nodes[e.id])},SceneJS_Engine.prototype.destroy=function(){this.destroyed=!0},self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"RequestCancelAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var r=(new Date).getTime(),n=Math.max(0,16-(r-e)),i=window.setTimeout(function(){t(r+n)},n);return e=r+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var SceneJS_error=new function(){var e;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){e=t.engine.id}),SceneJS_events.addListener(SceneJS_events.RESET,function(){e=null},1e5),this.fatalError=function(t,r){"string"==typeof t&&(r=t,t=SceneJS.errors.ERROR);var n={errorName:SceneJS.errors._getErrorName(t)||"ERROR",code:t,exception:r,fatal:!0};return e&&(n.sceneId=e),SceneJS_events.fireEvent(SceneJS_events.ERROR,n),r},this.error=function(t,r){var n={errorName:SceneJS.errors._getErrorName(t)||"ERROR",code:t,exception:r,fatal:!1};e&&(n.sceneId=e),SceneJS_events.fireEvent(SceneJS_events.ERROR,n)}};!function(){SceneJS.errors={};var e=0;SceneJS.errors.ERROR=e++,SceneJS.errors.INVALID_FRAMEBUFFER=e++,SceneJS.errors.WEBGL_NOT_SUPPORTED=e++,SceneJS.errors.WEBGL_CONTEXT_LOST=e++,SceneJS.errors.NODE_CONFIG_EXPECTED=e++,SceneJS.errors.ILLEGAL_NODE_CONFIG=e++,SceneJS.errors.SHADER_COMPILATION_FAILURE=e++,SceneJS.errors.SHADER_LINK_FAILURE=e++,SceneJS.errors.CANVAS_NOT_FOUND=e++,SceneJS.errors.OUT_OF_VRAM=e++,SceneJS.errors.WEBGL_UNSUPPORTED_NODE_CONFIG=e++,SceneJS.errors.NODE_NOT_FOUND=e++,SceneJS.errors.NODE_ILLEGAL_STATE=e++,SceneJS.errors.ID_CLASH=e++,SceneJS.errors.PLUGIN_INVALID=e++}(),SceneJS.errors._getErrorName=function(e){for(var t in SceneJS.errors)if(SceneJS.errors.hasOwnProperty(t)&&SceneJS.errors[t]==e)return t;return null};var SceneJS_configsModule=new function(){this.configs={};var e={};this.setConfigs=function(t,r){if(t){for(var n,i,o=t.split("."),a=this.configs,s=0;s<o.length-1;s++)i=o[s],n=a[i],n||(n=a[i]={}),a=n;a[o.length-1]=r}else this.configs=r;var c=e[t||"_all"];if(c)for(var s=0,h=c.length;h>s;s++)c[s](a);SceneJS.publish("configs",this.configs)},this.getConfigs=function(e){if(e){for(var t=this.configs,r=e.split("."),n=0;t&&n<r.length;n++)t=t[r[n]];return void 0!=t?t:{}}return this.configs},this.on=function(t,r){t=t||"_all",(e[t]||(e[t]=[])).push(r),r(this.getConfigs(t))}};SceneJS.configure=SceneJS.setConfigs=SceneJS.setDebugConfigs=function(){if(1==arguments.length)SceneJS_configsModule.setConfigs(null,arguments[0]);else{if(2!=arguments.length)throw SceneJS_error.fatalError("Illegal arguments given to SceneJS.setDebugs - should be either ({String}:name, {Object}:cfg) or ({Object}:cfg)");SceneJS_configsModule.setConfigs(arguments[0],arguments[1])}},SceneJS.getConfigs=SceneJS.getDebugConfigs=function(e){return SceneJS_configsModule.getConfigs(e)},SceneJS.log=new function(){var e,t=null,r={},n=0,i="";SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){e=t.engine.id}),SceneJS_events.addListener(SceneJS_events.RESET,function(){r={},t=null,e=null},1e5),this._setIndent=function(e){n=e;for(var t=[],r=0;n>r;r++)t.push("----");i=t.join("")},this.error=function(e){this._log("error",e)},this.warn=function(e){this._log("warn",e)},this.info=function(e){this._log("info",e)},this.debug=function(e){this._log("debug",e)},this.setFuncs=function(e){if(e){t=e;for(var n in r)this._flush(n)}},this._flush=function(e){var n=r[e];if(n){var i=t?t[e]:null;if(i){for(var o=0;o<n.length;o++)i(n[o]);r[e]=[]}}},this._log=function(e,t){if(SceneJS._isArray(t))for(var r=0;r<t.length;r++)this.__log(e,t[r]);else this.__log(e,t)},this.__log=function(e,r){r=i+r,t&&t[e]?t[e](r):console&&console[e]&&console[e](r)},this.getFuncs=function(){return t}};var SceneJS_math_divVec3=function(e,t,r){return r||(r=e),r[0]=e[0]/t[0],r[1]=e[1]/t[1],r[2]=e[2]/t[2],r},SceneJS_math_negateVector4=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},SceneJS_math_addVec4=function(e,t,r){return r||(r=e),r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r},SceneJS_math_addVec4s=function(e,t,r){return r||(r=e),r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t,r[3]=e[3]+t,r},SceneJS_math_addVec3=function(e,t,r){return r||(r=e),r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r},SceneJS_math_addVec3s=function(e,t,r){return r||(r=e),r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t,r},SceneJS_math_addScalarVec4=function(e,t,r){return SceneJS_math_addVec4s(t,e,r)},SceneJS_math_subVec4=function(e,t,r){return r||(r=e),r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r[3]=e[3]-t[3],r},SceneJS_math_subVec3=function(e,t,r){return r||(r=e),r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r},SceneJS_math_lerpVec3=function(e,t,r,n,i){var o=(e-t)/(r-t),a=1-o;return{x:n.x*a+i.x*o,y:n.y*a+i.y*o,z:n.z*a+i.z*o}},SceneJS_math_subVec2=function(e,t,r){return r||(r=e),r[0]=e[0]-t[0],r[1]=e[1]-t[1],r},SceneJS_math_subVec4Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]-t,r[1]=e[1]-t,r[2]=e[2]-t,r[3]=e[3]-t,r},SceneJS_math_subScalarVec4=function(e,t,r){return r||(r=e),r[0]=t-e[0],r[1]=t-e[1],r[2]=t-e[2],r[3]=t-e[3],r},SceneJS_math_mulVec4=function(e,t,r){return r||(r=e),r[0]=e[0]*t[0],r[1]=e[1]*t[1],r[2]=e[2]*t[2],r[3]=e[3]*t[3],r},SceneJS_math_mulVec4Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r},SceneJS_math_mulVec3Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r},SceneJS_math_mulVec2Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]*t,r[1]=e[1]*t,r},SceneJS_math_divVec4=function(e,t,r){return r||(r=e),r[0]=e[0]/t[0],r[1]=e[1]/t[1],r[2]=e[2]/t[2],r[3]=e[3]/t[3],r},SceneJS_math_divScalarVec3=function(e,t,r){return r||(r=t),r[0]=e/t[0],r[1]=e/t[1],r[2]=e/t[2],r},SceneJS_math_divVec3s=function(e,t,r){return r||(r=e),r[0]=e[0]/t,r[1]=e[1]/t,r[2]=e[2]/t,r},SceneJS_math_divVec4s=function(e,t,r){return r||(r=e),r[0]=e[0]/t,r[1]=e[1]/t,r[2]=e[2]/t,r[3]=e[3]/t,r},SceneJS_math_divScalarVec4=function(e,t,r){return r||(r=t),r[0]=e/t[0],r[1]=e/t[1],r[2]=e/t[2],r[3]=e/t[3],r},SceneJS_math_dotVector4=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},SceneJS_math_cross3Vec4=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];return[n*s-i*a,i*o-r*s,r*a-n*o,0]},SceneJS_math_cross3Vec3=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=t[0],s=t[1],c=t[2];return r[0]=i*c-o*s,r[1]=o*a-n*c,r[2]=n*s-i*a,r},SceneJS_math_sqLenVec4=function(e){return SceneJS_math_dotVector4(e,e)},SceneJS_math_lenVec4=function(e){return Math.sqrt(SceneJS_math_sqLenVec4(e))},SceneJS_math_dotVector3=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},SceneJS_math_dotVector2=function(e,t){return e[0]*t[0]+e[1]*t[1]},SceneJS_math_sqLenVec3=function(e){return SceneJS_math_dotVector3(e,e)},SceneJS_math_sqLenVec2=function(e){return SceneJS_math_dotVector2(e,e)},SceneJS_math_lenVec3=function(e){return Math.sqrt(SceneJS_math_sqLenVec3(e))},SceneJS_math_lenVec2=function(e){return Math.sqrt(SceneJS_math_sqLenVec2(e))},SceneJS_math_rcpVec3=function(e,t){return SceneJS_math_divScalarVec3(1,e,t)},SceneJS_math_normalizeVec4=function(e,t){var r=1/SceneJS_math_lenVec4(e);return SceneJS_math_mulVec4Scalar(e,r,t)},SceneJS_math_normalizeVec3=function(e,t){var r=1/SceneJS_math_lenVec3(e);return SceneJS_math_mulVec3Scalar(e,r,t)},SceneJS_math_normalizeVec2=function(e,t){var r=1/SceneJS_math_lenVec2(e);return SceneJS_math_mulVec2Scalar(e,r,t)},SceneJS_math_mat4=function(){return new Array(16)},SceneJS_math_dupMat4=function(e){return e.slice(0,16)},SceneJS_math_getCellMat4=function(e,t,r){return e[t+4*r]},SceneJS_math_setCellMat4=function(e,t,r,n){e[t+4*r]=n},SceneJS_math_getRowMat4=function(e,t){return[e[t],e[t+4],e[t+8],e[t+12]]},SceneJS_math_setRowMat4=function(e,t,r){e[t]=r[0],e[t+4]=r[1],e[t+8]=r[2],e[t+12]=r[3]},SceneJS_math_setRowMat4c=function(e,t,r,n,i,o){SceneJS_math_setRowMat4(e,t,[r,n,i,o])},SceneJS_math_setRowMat4s=function(e,t,r){SceneJS_math_setRowMat4c(e,t,r,r,r,r)},SceneJS_math_getColMat4=function(e,t){var r=4*t;return[e[r],e[r+1],e[r+2],e[r+3]]},SceneJS_math_setColMat4v=function(e,t,r){var n=4*t;e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3]},SceneJS_math_setColMat4c=function(e,t,r,n,i,o){SceneJS_math_setColMat4v(e,t,[r,n,i,o])},SceneJS_math_setColMat4Scalar=function(e,t,r){SceneJS_math_setColMat4c(e,t,r,r,r,r)},SceneJS_math_mat4To3=function(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]},SceneJS_math_m4s=function(e){return[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]},SceneJS_math_setMat4ToZeroes=function(){return SceneJS_math_m4s(0)},SceneJS_math_setMat4ToOnes=function(){return SceneJS_math_m4s(1)},SceneJS_math_diagonalMat4v=function(e){return[e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]},SceneJS_math_diagonalMat4c=function(e,t,r,n){return SceneJS_math_diagonalMat4v([e,t,r,n])},SceneJS_math_diagonalMat4s=function(e){return SceneJS_math_diagonalMat4c(e,e,e,e)},SceneJS_math_identityMat4=function(){return SceneJS_math_diagonalMat4v([1,1,1,1])},SceneJS_math_isIdentityMat4=function(e){return 1!==e[0]||0!==e[1]||0!==e[2]||0!==e[3]||0!==e[4]||1!==e[5]||0!==e[6]||0!==e[7]||0!==e[8]||0!==e[9]||1!==e[10]||0!==e[11]||0!==e[12]||0!==e[13]||0!==e[14]||1!==e[15]?!1:!0},SceneJS_math_negateMat4=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},SceneJS_math_addMat4=function(e,t,r){return r||(r=e),r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r[3]=e[3]+t[3],r[4]=e[4]+t[4],r[5]=e[5]+t[5],r[6]=e[6]+t[6],r[7]=e[7]+t[7],r[8]=e[8]+t[8],r[9]=e[9]+t[9],r[10]=e[10]+t[10],r[11]=e[11]+t[11],r[12]=e[12]+t[12],r[13]=e[13]+t[13],r[14]=e[14]+t[14],r[15]=e[15]+t[15],r},SceneJS_math_addMat4Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t,r[3]=e[3]+t,r[4]=e[4]+t,r[5]=e[5]+t,r[6]=e[6]+t,r[7]=e[7]+t,r[8]=e[8]+t,r[9]=e[9]+t,r[10]=e[10]+t,r[11]=e[11]+t,r[12]=e[12]+t,r[13]=e[13]+t,r[14]=e[14]+t,r[15]=e[15]+t,r},SceneJS_math_addScalarMat4=function(e,t,r){return SceneJS_math_addMat4Scalar(t,e,r)},SceneJS_math_subMat4=function(e,t,r){return r||(r=e),r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r[3]=e[3]-t[3],r[4]=e[4]-t[4],r[5]=e[5]-t[5],r[6]=e[6]-t[6],r[7]=e[7]-t[7],r[8]=e[8]-t[8],r[9]=e[9]-t[9],r[10]=e[10]-t[10],r[11]=e[11]-t[11],r[12]=e[12]-t[12],r[13]=e[13]-t[13],r[14]=e[14]-t[14],r[15]=e[15]-t[15],r},SceneJS_math_subMat4Scalar=function(e,t,r){return r||(r=e),r[0]=e[0]-t,r[1]=e[1]-t,r[2]=e[2]-t,r[3]=e[3]-t,r[4]=e[4]-t,r[5]=e[5]-t,r[6]=e[6]-t,r[7]=e[7]-t,r[8]=e[8]-t,r[9]=e[9]-t,r[10]=e[10]-t,r[11]=e[11]-t,r[12]=e[12]-t,r[13]=e[13]-t,r[14]=e[14]-t,r[15]=e[15]-t,r},SceneJS_math_subScalarMat4=function(e,t,r){return r||(r=t),r[0]=e-t[0],r[1]=e-t[1],r[2]=e-t[2],r[3]=e-t[3],r[4]=e-t[4],r[5]=e-t[5],r[6]=e-t[6],r[7]=e-t[7],r[8]=e-t[8],r[9]=e-t[9],r[10]=e-t[10],r[11]=e-t[11],r[12]=e-t[12],r[13]=e-t[13],r[14]=e-t[14],r[15]=e-t[15],r},SceneJS_math_mulMat4=function(e,t,r){r||(r=e);var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],c=e[5],h=e[6],u=e[7],l=e[8],S=e[9],p=e[10],_=e[11],d=e[12],f=e[13],m=e[14],g=e[15],y=t[0],v=t[1],J=t[2],E=t[3],b=t[4],C=t[5],N=t[6],x=t[7],w=t[8],T=t[9],L=t[10],M=t[11],F=t[12],D=t[13],A=t[14],k=t[15];return r[0]=y*n+v*s+J*l+E*d,r[1]=y*i+v*c+J*S+E*f,r[2]=y*o+v*h+J*p+E*m,r[3]=y*a+v*u+J*_+E*g,r[4]=b*n+C*s+N*l+x*d,r[5]=b*i+C*c+N*S+x*f,r[6]=b*o+C*h+N*p+x*m,r[7]=b*a+C*u+N*_+x*g,r[8]=w*n+T*s+L*l+M*d,r[9]=w*i+T*c+L*S+M*f,r[10]=w*o+T*h+L*p+M*m,r[11]=w*a+T*u+L*_+M*g,r[12]=F*n+D*s+A*l+k*d,r[13]=F*i+D*c+A*S+k*f,r[14]=F*o+D*h+A*p+k*m,r[15]=F*a+D*u+A*_+k*g,r},SceneJS_math_mulMat4s=function(e,t,r){return r||(r=e),r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r[3]=e[3]*t,r[4]=e[4]*t,r[5]=e[5]*t,r[6]=e[6]*t,r[7]=e[7]*t,r[8]=e[8]*t,r[9]=e[9]*t,r[10]=e[10]*t,r[11]=e[11]*t,r[12]=e[12]*t,r[13]=e[13]*t,r[14]=e[14]*t,r[15]=e[15]*t,r},SceneJS_math_mulMat4v4=function(e,t){var r=t[0],n=t[1],i=t[2],o=t[3];return[e[0]*r+e[4]*n+e[8]*i+e[12]*o,e[1]*r+e[5]*n+e[9]*i+e[13]*o,e[2]*r+e[6]*n+e[10]*i+e[14]*o,e[3]*r+e[7]*n+e[11]*i+e[15]*o]},SceneJS_math_transposeMat4=function(e,t){var r=e[4],n=e[14],i=e[8],o=e[13],a=e[12],s=e[9];if(!t||e==t){var c=e[1],h=e[2],u=e[3],l=e[6],S=e[7],p=e[11];return e[1]=r,e[2]=i,e[3]=a,e[4]=c,e[6]=s,e[7]=o,e[8]=h,e[9]=l,e[11]=n,e[12]=u,e[13]=S,e[14]=p,e}return t[0]=e[0],t[1]=r,t[2]=i,t[3]=a,t[4]=e[1],t[5]=e[5],t[6]=s,t[7]=o,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=n,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},SceneJS_math_determinantMat4=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],s=e[6],c=e[7],h=e[8],u=e[9],l=e[10],S=e[11],p=e[12],_=e[13],d=e[14],f=e[15];return p*u*s*i-h*_*s*i-p*a*l*i+o*_*l*i+h*a*d*i-o*u*d*i-p*u*n*c+h*_*n*c+p*r*l*c-t*_*l*c-h*r*d*c+t*u*d*c+p*a*n*S-o*_*n*S-p*r*s*S+t*_*s*S+o*r*d*S-t*a*d*S-h*a*n*f+o*u*n*f+h*r*s*f-t*u*s*f-o*r*l*f+t*a*l*f},SceneJS_math_inverseMat4=function(e,t){t||(t=e);var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],c=e[6],h=e[7],u=e[8],l=e[9],S=e[10],p=e[11],_=e[12],d=e[13],f=e[14],m=e[15],g=r*s-n*a,y=r*c-i*a,v=r*h-o*a,J=n*c-i*s,E=n*h-o*s,b=i*h-o*c,C=u*d-l*_,N=u*f-S*_,x=u*m-p*_,w=l*f-S*d,T=l*m-p*d,L=S*m-p*f,M=1/(g*L-y*T+v*w+J*x-E*N+b*C);return t[0]=(s*L-c*T+h*w)*M,t[1]=(-n*L+i*T-o*w)*M,t[2]=(d*b-f*E+m*J)*M,t[3]=(-l*b+S*E-p*J)*M,t[4]=(-a*L+c*x-h*N)*M,t[5]=(r*L-i*x+o*N)*M,t[6]=(-_*b+f*v-m*y)*M,t[7]=(u*b-S*v+p*y)*M,t[8]=(a*T-s*x+h*C)*M,t[9]=(-r*T+n*x-o*C)*M,t[10]=(_*E-d*v+m*g)*M,t[11]=(-u*E+l*v-p*g)*M,t[12]=(-a*w+s*N-c*C)*M,t[13]=(r*w-n*N+i*C)*M,t[14]=(-_*J+d*y-f*g)*M,t[15]=(u*J-l*y+S*g)*M,t},SceneJS_math_traceMat4=function(e){return e[0]+e[5]+e[10]+e[15]},SceneJS_math_translationMat4v=function(e){var t=SceneJS_math_identityMat4();return t[12]=e[0],t[13]=e[1],t[14]=e[2],t},SceneJS_math_translationMat4c=function(e,t,r){return SceneJS_math_translationMat4v([e,t,r])},SceneJS_math_translationMat4s=function(e){return SceneJS_math_translationMat4c(e,e,e)},SceneJS_math_rotationMat4v=function(e,t){var r,n,i,o,a,s,c=SceneJS_math_normalizeVec4([t[0],t[1],t[2],0]),h=Math.sin(e),u=Math.cos(e),l=1-u,S=c[0],p=c[1],_=c[2];r=S*p,n=p*_,i=_*S,o=S*h,a=p*h,s=_*h;var d=SceneJS_math_mat4();return d[0]=l*S*S+u,d[1]=l*r+s,d[2]=l*i-a,d[3]=0,d[4]=l*r-s,d[5]=l*p*p+u,d[6]=l*n+o,d[7]=0,d[8]=l*i+a,d[9]=l*n-o,d[10]=l*_*_+u,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d},SceneJS_math_rotationMat4c=function(e,t,r,n){return SceneJS_math_rotationMat4v(e,[t,r,n])},SceneJS_math_scalingMat4v=function(e){var t=SceneJS_math_identityMat4();return t[0]=e[0],t[5]=e[1],t[10]=e[2],t},SceneJS_math_scalingMat4c=function(e,t,r){return SceneJS_math_scalingMat4v([e,t,r])},SceneJS_math_scalingMat4s=function(e){return SceneJS_math_scalingMat4c(e,e,e)},SceneJS_math_LOOKAT_OBJ={eye:{x:0,y:0,z:10},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0}},SceneJS_math_LOOKAT_ARRAYS={eye:[0,0,10],look:[0,0,0],up:[0,1,0]},SceneJS_math_ORTHO_OBJ={left:-1,right:1,bottom:-1,near:.1,top:1,far:5e3},SceneJS_math_lookAtMat4v=function(e,t,r,n){n||(n=SceneJS_math_mat4());var i=e[0],o=e[1],a=e[2],s=r[0],c=r[1],h=r[2],u=t[0],l=t[1],S=t[2];if(i==u&&o==l&&a==S)return SceneJS_math_identityMat4();var p,_,d,f,m,g,y,v,J,E;return p=i-u,_=o-l,d=a-S,E=1/Math.sqrt(p*p+_*_+d*d),p*=E,_*=E,d*=E,f=c*d-h*_,m=h*p-s*d,g=s*_-c*p,E=Math.sqrt(f*f+m*m+g*g),E?(E=1/E,f*=E,m*=E,g*=E):(f=0,m=0,g=0),y=_*g-d*m,v=d*f-p*g,J=p*m-_*f,E=Math.sqrt(y*y+v*v+J*J),E?(E=1/E,y*=E,v*=E,J*=E):(y=0,v=0,J=0),n[0]=f,n[1]=y,n[2]=p,n[3]=0,n[4]=m,n[5]=v,n[6]=_,n[7]=0,n[8]=g,n[9]=J,n[10]=d,n[11]=0,n[12]=-(f*i+m*o+g*a),n[13]=-(y*i+v*o+J*a),n[14]=-(p*i+_*o+d*a),n[15]=1,n},SceneJS_math_lookAtMat4c=function(e,t,r,n,i,o,a,s,c){return SceneJS_math_lookAtMat4v([e,t,r],[n,i,o],[a,s,c])},SceneJS_math_orthoMat4c=function(e,t,r,n,i,o,a){a||(a=SceneJS_math_mat4());var s=t-e,c=n-r,h=o-i;return a[0]=2/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/c,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/h,a[11]=0,a[12]=-(e+t)/s,a[13]=-(n+r)/c,a[14]=-(o+i)/h,a[15]=1,a},SceneJS_math_frustumMat4v=function(e,t){var r=[e[0],e[1],e[2],0],n=[t[0],t[1],t[2],0],i=SceneJS_math_mat4();SceneJS_math_addVec4(n,r,i);var o=SceneJS_math_mat4();SceneJS_math_subVec4(n,r,o);var a=2*r[2],s=SceneJS_math_mat4(),c=o[0],h=o[1],u=o[2];return s[0]=a/c,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a/h,s[6]=0,s[7]=0,s[8]=i[0]/c,s[9]=i[1]/h,s[10]=-i[2]/u,s[11]=-1,s[12]=0,s[13]=0,s[14]=-a*n[2]/u,s[15]=0,s},SceneJS_math_frustumMatrix4=function(e,t,r,n,i,o,a){a||(a=SceneJS_math_mat4());var s=t-e,c=n-r,h=o-i;return a[0]=2*i/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*i/c,a[6]=0,a[7]=0,a[8]=(t+e)/s,a[9]=(n+r)/c,a[10]=-(o+i)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(o*i*2)/h,a[15]=0,a},SceneJS_math_perspectiveMatrix4=function(e,t,r,n){var i=[],o=[];return i[2]=r,o[2]=n,o[1]=i[2]*Math.tan(e/2),i[1]=-o[1],o[0]=o[1]*t,i[0]=-o[0],SceneJS_math_frustumMat4v(i,o)},SceneJS_math_transformPoint3=function(e,t){var r=t[0],n=t[1],i=t[2];return[e[0]*r+e[4]*n+e[8]*i+e[12],e[1]*r+e[5]*n+e[9]*i+e[13],e[2]*r+e[6]*n+e[10]*i+e[14],e[3]*r+e[7]*n+e[11]*i+e[15]]},SceneJS_math_transformPoints3=function(e,t){for(var r,n,i,o,a=new Array(t.length),s=t.length,c=e[0],h=e[1],u=e[2],l=e[3],S=e[4],p=e[5],_=e[6],d=e[7],f=e[8],m=e[9],g=e[10],y=e[11],v=e[12],J=e[13],E=e[14],b=e[15],C=0;s>C;++C)o=t[C],r=o[0],n=o[1],i=o[2],a[C]=[c*r+S*n+f*i+v,h*r+p*n+m*i+J,u*r+_*n+g*i+E,l*r+d*n+y*i+b];return a},SceneJS_math_transformVector3=function(e,t){var r=t[0],n=t[1],i=t[2];return[e[0]*r+e[4]*n+e[8]*i,e[1]*r+e[5]*n+e[9]*i,e[2]*r+e[6]*n+e[10]*i]},SceneJS_math_transformVector4=function(e,t){var r=t[0],n=t[1],i=t[2],o=t[3];return[e[0]*r+e[4]*n+e[8]*i+e[12]*o,e[1]*r+e[5]*n+e[9]*i+e[13]*o,e[2]*r+e[6]*n+e[10]*i+e[14]*o,e[3]*r+e[7]*n+e[11]*i+e[15]*o]},SceneJS_math_projectVec4=function(e){var t=1/e[3];return[e[0]*t,e[1]*t,e[2]*t,1]},SceneJS_math_Plane3=function(e,t,r){if(this.normal=[0,0,1],this.offset=0,e&&t){var n=e[0],i=e[1],o=e[2];if(this.offset=t,r){var a=Math.sqrt(n*n+i*i+o*o);a>0&&(a=1/a,this.normal[0]=n*a,this.normal[1]=i*a,this.normal[2]=o*a,this.offset*=a)}}},SceneJS_math_MAX_DOUBLE=Number.POSITIVE_INFINITY,SceneJS_math_MIN_DOUBLE=Number.NEGATIVE_INFINITY,SceneJS_math_Box3=function(e,t){this.min=e||[SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE],this.max=t||[SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE],this.init=function(e,t){return this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],this.max[0]=t[0],this.max[1]=t[1],this.max[2]=t[2],this},this.fromPoints=function(e){for(var t=e.length,r=0;t>r;++r){var n=e[r][3],i=e[r][0]/n,o=e[r][1]/n,a=e[r][2]/n;i<this.min[0]&&(this.min[0]=i),o<this.min[1]&&(this.min[1]=o),a<this.min[2]&&(this.min[2]=a),i>this.max[0]&&(this.max[0]=i),o>this.max[1]&&(this.max[1]=o),a>this.max[2]&&(this.max[2]=a)}return this},this.isEmpty=function(){return this.min[0]>=this.max[0]&&this.min[1]>=this.max[1]&&this.min[2]>=this.max[2]},this.getCenter=function(){return[(this.max[0]+this.min[0])/2,(this.max[1]+this.min[1])/2,(this.max[2]+this.min[2])/2]},this.getSize=function(){return[this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]]},this.getFacesAreas=function(){var e=this.size;return[e[1]*e[2],e[0]*e[2],e[0]*e[1]]},this.getSurfaceArea=function(){var e=this.getFacesAreas();return 2*(e[0]+e[1]+e[2])},this.getVolume=function(){var e=this.size;return e[0]*e[1]*e[2]},this.getOffset=function(e){return this.min[0]-=e,this.min[1]-=e,this.min[2]-=e,this.max[0]+=e,this.max[1]+=e,this.max[2]+=e,this}},SceneJS_math_AxisBox3=function(e,t){var r=e[0],n=e[1],i=e[2],o=t[0],a=t[1],s=t[2];this.verts=[[r,n,i],[o,n,i],[o,a,i],[r,a,i],[r,n,s],[o,n,s],[o,a,s],[r,a,s]],this.toBox3=function(){for(var e=new SceneJS_math_Box3,t=0;8>t;++t)for(var r=this.verts[t],n=0;3>n;++n)r[n]<e.min[n]&&(e.min[n]=r[n]),r[n]>e.max[n]&&(e.max[n]=r[n])}},SceneJS_math_Sphere3=function(e,t){this.center=[e[0],e[1],e[2]],this.radius=t,this.isEmpty=function(){return 0===this.radius},this.surfaceArea=function(){return 4*Math.PI*this.radius*this.radius},this.getVolume=function(){var e=this.radius;return 4/3*Math.PI*e*e*e}},SceneJS_math_billboardMat=function(e){var t=[SceneJS_math_getColMat4(e,0),SceneJS_math_getColMat4(e,1),SceneJS_math_getColMat4(e,2)],r=[SceneJS_math_lenVec4(t[0]),SceneJS_math_lenVec4(t[1]),SceneJS_math_lenVec4(t[2])],n=SceneJS_math_mat4();SceneJS_math_rcpVec3(r,n);var i=SceneJS_math_scalingMat4v(r);SceneJS_math_mulVec4Scalar(t[0],n[0]),SceneJS_math_mulVec4Scalar(t[1],n[1]),SceneJS_math_mulVec4Scalar(t[2],n[2]);var o=SceneJS_math_identityMat4();return SceneJS_math_setRowMat4(o,0,t[0]),SceneJS_math_setRowMat4(o,1,t[1]),SceneJS_math_setRowMat4(o,2,t[2]),SceneJS_math_mulMat4(o,i)},SceneJS_math_FrustumPlane=function(e,t,r,n){var i=1/Math.sqrt(e*e+t*t+r*r);this.normal=[e*i,t*i,r*i],this.offset=n*i,this.testVertex=[this.normal[0]>=0?1:0,this.normal[1]>=0?1:0,this.normal[2]>=0?1:0]},SceneJS_math_OUTSIDE_FRUSTUM=3,SceneJS_math_INTERSECT_FRUSTUM=4,SceneJS_math_INSIDE_FRUSTUM=5,SceneJS_math_Frustum=function(e,t,r){var n=SceneJS_math_mat4();SceneJS_math_mulMat4(t,e,n);var i=n[0],o=n[1],a=n[2],s=n[3],c=n[4],h=n[5],u=n[6],l=n[7],S=n[8],p=n[9],_=n[10],d=n[11],f=n[12],m=n[13],g=n[14],y=n[15],v=[new SceneJS_math_FrustumPlane(s-i,l-c,d-S,y-f),new SceneJS_math_FrustumPlane(s+i,l+c,d+S,y+f),new SceneJS_math_FrustumPlane(s-o,l-h,d-p,y-m),new SceneJS_math_FrustumPlane(s+o,l+h,d+p,y+m),new SceneJS_math_FrustumPlane(s-a,l-u,d-_,y-g),new SceneJS_math_FrustumPlane(s+a,l+u,d+_,y+g)],J=[SceneJS_math_getColMat4(e,0),SceneJS_math_getColMat4(e,1),SceneJS_math_getColMat4(e,2)],E=[SceneJS_math_lenVec4(J[0]),SceneJS_math_lenVec4(J[1]),SceneJS_math_lenVec4(J[2])],b=SceneJS_math_rcpVec3(E),C=SceneJS_math_scalingMat4v(E),N=SceneJS_math_scalingMat4v(b);SceneJS_math_mulVec4Scalar(J[0],b[0]),SceneJS_math_mulVec4Scalar(J[1],b[1]),SceneJS_math_mulVec4Scalar(J[2],b[2]);var x=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(x,0,J[0]),SceneJS_math_setRowMat4(x,1,J[1]),SceneJS_math_setRowMat4(x,2,J[2]),this.matrix||(this.matrix=SceneJS_math_mat4()),SceneJS_math_mulMat4(t,e,this.matrix),this.billboardMatrix||(this.billboardMatrix=SceneJS_math_mat4()),SceneJS_math_mulMat4(N,SceneJS_math_mulMat4(x,C),this.billboardMatrix),this.viewport=r.slice(0,4),this.textAxisBoxIntersection=function(e){for(var t=SceneJS_math_INSIDE_FRUSTUM,r=[e.min,e.max],n=null,i=0;6>i;++i){if(n=v[i],n.normal[0]*r[n.testVertex[0]][0]+n.normal[1]*r[n.testVertex[1]][1]+n.normal[2]*r[n.testVertex[2]][2]+n.offset<0)return SceneJS_math_OUTSIDE_FRUSTUM;n.normal[0]*r[1-n.testVertex[0]][0]+n.normal[1]*r[1-n.testVertex[1]][1]+n.normal[2]*r[1-n.testVertex[2]][2]+n.offset<0&&(t=SceneJS_math_INTERSECT_FRUSTUM)}return t},this.getProjectedSize=function(e){var t=SceneJS_math_mat4();SceneJS_math_subVec3(e.max,e.min,t);var n=SceneJS_math_lenVec3(t),i=Math.abs(n),o=[.5*(e.min[0]+e.max[0]),.5*(e.min[1]+e.max[1]),.5*(e.min[2]+e.max[2]),0],a=.5*i,s=[-a,0,0,1],c=[a,0,0,1];return s=SceneJS_math_mulMat4v4(this.billboardMatrix,s),s=SceneJS_math_addVec4(s,o),s=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,s)),c=SceneJS_math_mulMat4v4(this.billboardMatrix,c),c=SceneJS_math_addVec4(c,o),c=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,c)),r[2]*Math.abs(c[0]-s[0])},this.getProjectedState=function(e){for(var t,n,i,o=SceneJS_math_transformPoints3(this.matrix,e),a=1e7,s=1e7,c=-1e7,h=-1e7,u=o.length,l=0;u>l;++l)t=SceneJS_math_projectVec4(o[l]),n=t[0],i=t[1],-.5>n&&(n=-.5),-.5>i&&(i=-.5),n>.5&&(n=.5),i>.5&&(i=.5),a>n&&(a=n),s>i&&(s=i),n>c&&(c=n),i>h&&(h=i);a+=.5,s+=.5,c+=.5,h+=.5;var S=r[2],p=r[3];a*=S+15,s*=p+15,c*=S+15,h*=p+15;var _=SceneJS_math_mat4();SceneJS_math_subVec2([c,h],[a,s],_);var d=SceneJS_math_lenVec2(_);return 0>a&&(a=0),c>S&&(c=S),0>s&&(s=0),h>p&&(h=p),{canvasBox:{min:[a,s],max:[c,h]},canvasSize:d}}},SceneJS_math_identityQuaternion=function(){return[0,0,0,1]},SceneJS_math_angleAxisQuaternion=function(e,t,r,n){var i=n/180*Math.PI,o=i/2,a=Math.sin(o);return[a*e,a*t,a*r,Math.cos(o)]},SceneJS_math_mulQuaternions=function(e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=t[0],s=t[1],c=t[2],h=t[3];return[o*a+r*h+n*c-i*s,o*s+n*h+i*a-r*c,o*c+i*h+r*s-n*a,o*h-r*a-n*s-i*c]},SceneJS_math_newMat4FromQuaternion=function(e){var t=e[0],r=e[1],n=e[2],i=e[3],o=2*t,a=2*r,s=2*n,c=o*i,h=a*i,u=s*i,l=o*t,S=a*t,p=s*t,_=a*r,d=s*r,f=s*n,m=SceneJS_math_identityMat4();return SceneJS_math_setCellMat4(m,0,0,1-(_+f)),SceneJS_math_setCellMat4(m,0,1,S-u),SceneJS_math_setCellMat4(m,0,2,p+h),SceneJS_math_setCellMat4(m,1,0,S+u),SceneJS_math_setCellMat4(m,1,1,1-(l+f)),SceneJS_math_setCellMat4(m,1,2,d-c),SceneJS_math_setCellMat4(m,2,0,p-h),SceneJS_math_setCellMat4(m,2,1,d+c),SceneJS_math_setCellMat4(m,2,2,1-(l+_)),m},SceneJS_math_slerp=function(e,t,r){var n=.0174532925*t[3],i=.0174532925*r[3],o=n*i+t[0]*r[0]+t[1]*r[1]+t[2]*r[2];if(Math.abs(o)>=1)return[t[0],t[1],t[2],t[3]];var a=Math.acos(o),s=Math.sqrt(1-o*o);if(Math.abs(s)<.001)return[.5*t[0]+.5*r[0],.5*t[1]+.5*r[1],.5*t[2]+.5*r[2],.5*t[3]+.5*r[3]];var c=Math.sin((1-e)*a)/s,h=Math.sin(e*a)/s;return[t[0]*c+r[0]*h,t[1]*c+r[1]*h,t[2]*c+r[2]*h,57.295779579*(n*c+i*h)]},SceneJS_math_normalizeQuaternion=function(e){var t=SceneJS_math_lenVec4([e[0],e[1],e[2],e[3]]);return[e[0]/t,e[1]/t,e[2]/t,e[3]/t]},SceneJS_math_conjugateQuaternion=function(e){return[-e[0],-e[1],-e[2],e[3]]},SceneJS_math_angleAxisFromQuaternion=function(e){e=SceneJS_math_normalizeQuaternion(e);var t=e[3],r=2*Math.acos(t),n=Math.sqrt(1-t*t);return.001>n?{x:e[0],y:e[1],z:e[2],angle:57.295779579*r}:{x:e[0]/n,y:e[1]/n,z:e[2]/n,angle:57.295779579*r}},SceneJS_sceneStatusModule=new function(){function e(){var e=document.getElementsByTagName("body")[0],t=document.createElement("div"),r=t.style;return r.position="absolute",r.width="200px",r.right="10px",r.top="0",r.padding="10px",r["z-index"]="10000",e.appendChild(t),t}function t(e,t){var r=document.createElement("div"),n=r.style;return n["font-family"]="Helvetica",n["font-size"]="14px",n.padding="5px",n.margin="4px",n["padding-left"]="12px",n.border="1px solid #000055",n.color="black",n.background="#AAAAAA",n.opacity="0.8",n["border-radius"]="3px",n["-moz-border-radius"]="3px",n["box-shadow"]="3px 3px 3px #444444",r.innerHTML=t,e.appendChild(r),r}function r(e){e.style.background="#AAFFAA";var t=.8,r=setInterval(function(){0>=t?(e.parentNode.removeChild(e),clearInterval(r)):(e.style.opacity=t,t-=.1)},100)}function n(e){e.style.background="#FFAAAA"}this.sceneStatus={};var i=new SceneJS_Map,o={},a={},s=this;SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(e){var t=e.engine.id;delete s.sceneStatus[t],delete a[t]}),this.taskStarted=function(r,n){var s=SceneJS_configsModule.configs.statusPopups!==!1,c=r.getScene(),h=c.getId(),u=r.getId(),l=c.getCanvas(),S=i.addItem(),p=this.sceneStatus[h];p||(p=this.sceneStatus[h]={numTasks:0}),p.numTasks++;var _=a[h];_||(_=a[h]={sceneId:h,nodeStates:{},scene:c,popupContainer:s?e(l):null,descCounts:{}});var d=_.descCounts[n];void 0==d&&(d=_.descCounts[n]=0),_.descCounts[n]++;var f=_.nodeStates[u];f||(f=_.nodeStates[u]={nodeId:u,numTasks:0,tasks:{}}),n=n+" "+_.descCounts[n]+"...",f.numTasks++;var m={sceneState:_,nodeState:f,description:n,element:s?t(_.popupContainer,n):null};return f.tasks[S]=m,o[S]=m,S},this.taskFinished=function(e){if(-1==e||null==e)return null;var t=o[e];if(!t)return null;var n=t.sceneState;this.sceneStatus[n.sceneId].numTasks--,t.element&&r(t.element);var i=t.nodeState;return--i.numTasks<0&&(i.numTasks=0),delete i.tasks[e],0==i.numTasks&&delete n.nodeStates[i.nodeId],null},this.taskFailed=function(e){if(-1==e||null==e)return null;var t=o[e];if(!t)return null;var r=!!SceneJS_configsModule.configs.statusPopups,i=t.sceneState;this.sceneStatus[i.sceneId].numTasks--,r&&n(t.element);var a=t.nodeState;return a.numTasks--,delete a.tasks[e],0==a.numTasks&&delete t.sceneState.nodeStates[a.nodeId],null}};SceneJS._webgl={},SceneJS._webgl.ArrayBuffer=function(e,t,r,n,i,o){this.allocated=!1,this.gl=e,this.type=t,this.numItems=n,this.itemSize=i,this.usage=o,this._allocate(r,n)},SceneJS._webgl.ArrayBuffer.prototype._allocate=function(e,t){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to allocate WebGL ArrayBuffer");this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,e,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=t,this.length=e.length,this.allocated=!0)},SceneJS._webgl.ArrayBuffer.prototype.setData=function(e,t){this.allocated&&(e.length>this.length?(this.destroy(),this._allocate(e,e.length)):t||0===t?this.gl.bufferSubData(this.type,t,e):this.gl.bufferData(this.type,e))
},SceneJS._webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},SceneJS._webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.handle=null,this.allocated=!1)},SceneJS._webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)},SceneJS._webgl.Attribute=function(e,t,r,n,i,o){this.gl=e,this.location=o,this.bindFloatArrayBuffer=function(t){t&&(t.bind(),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,t.itemSize,e.FLOAT,!1,0,0))}},SceneJS._webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(e,t,r){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,e,this.gl.FLOAT,!1,t,r)},SceneJS._webgl.enumMap={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"},SceneJS._webgl.RenderBuffer=function(e){this.allocated=!1,this.canvas=e.canvas,this.gl=e.canvas.gl,this.buf=null,this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.webglRestored=function(e){this.gl=e,this.buf=null,this.allocated=!1,this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.bound=!0)},SceneJS._webgl.RenderBuffer.prototype._touch=function(){var e=this.canvas.canvas.width,t=this.canvas.canvas.height;if(this.buf){if(this.buf.width==e&&this.buf.height==t)return;this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf)}this.buf={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:e,height:t},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buf.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(r){var n=new WebGLUnsignedByteArray(e*t*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,e,t),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buf.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),!this.gl.isFramebuffer(this.buf.framebuf))throw SceneJS_error.fatalError(SceneJS.errors.INVALID_FRAMEBUFFER,"Invalid framebuffer");var i=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(i){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: "+i)}this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},SceneJS._webgl.RenderBuffer.prototype.read=function(e,t){var r=e,n=this.canvas.canvas.height-t,i=new Uint8Array(4);return this.gl.readPixels(r,n,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i),i},SceneJS._webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.getTexture=function(){var e=this;return{bind:function(t){return e.buf&&e.buf.texture?(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buf.texture),!0):!1},unbind:function(t){e.buf&&e.buf.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}}},SceneJS._webgl.RenderBuffer.prototype.destroy=function(){this.buf&&(this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf),this.buf=null,this.bound=!1)},SceneJS._webgl.Program=function(e,t,r){this.allocated=!1,this.gl=e,this._uniforms={},this._samplers={},this._attributes={},this.uniformValues=[],this.materialSettings={specularColor:[0,0,0],specular:0,shine:0,emit:0,alpha:0},this._shaders=[];var n,i,o,a,s,c;for(i=0;i<t.length;i++)this._shaders.push(new SceneJS._webgl.Shader(e,e.VERTEX_SHADER,t[i]));for(i=0;i<r.length;i++)this._shaders.push(new SceneJS._webgl.Shader(e,e.FRAGMENT_SHADER,r[i]));if(this.handle=e.createProgram(),this.handle){for(i=0;i<this._shaders.length;i++)c=this._shaders[i],c.valid&&e.attachShader(this.handle,c.handle);e.linkProgram(this.handle);var h=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS),u=0;for(i=0;h>i;++i)o=e.getActiveUniform(this.handle,i),o&&(a=o.name,"\x00"==a[a.length-1]&&(a=a.substr(0,a.length-1)),s=e.getUniformLocation(this.handle,a),o.type==e.SAMPLER_2D||o.type==e.SAMPLER_CUBE||35682==o.type?this._samplers[a]=new SceneJS._webgl.Sampler(e,this.handle,a,o.type,o.size,s):(this._uniforms[a]=new SceneJS._webgl.Uniform(e,this.handle,a,o.type,o.size,s,u),this.uniformValues[u]=null,++u));var l=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;l>i;i++)n=e.getActiveAttrib(this.handle,i),n&&(s=e.getAttribLocation(this.handle,n.name),this._attributes[n.name]=new SceneJS._webgl.Attribute(e,this.handle,n.name,n.type,n.size,s));this.allocated=!0}},SceneJS._webgl.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},SceneJS._webgl.Program.prototype.getUniformLocation=function(e){if(this.allocated){var t=this._uniforms[e];return t?t.getLocation():void 0}},SceneJS._webgl.Program.prototype.getUniform=function(e){if(this.allocated){var t=this._uniforms[e];return t?t:void 0}},SceneJS._webgl.Program.prototype.getAttribute=function(e){if(this.allocated){var t=this._attributes[e];return t?t:void 0}},SceneJS._webgl.Program.prototype.bindFloatArrayBuffer=function(e,t){if(this.allocated){var r=this._attributes[e];r&&r.bindFloatArrayBuffer(t)}},SceneJS._webgl.Program.prototype.bindTexture=function(e,t,r){if(!this.allocated)return!1;var n=this._samplers[e];return n?n.bindTexture(t,r):!1},SceneJS._webgl.Program.prototype.destroy=function(){if(this.allocated){this.gl.deleteProgram(this.handle);for(var e in this._shaders)this.gl.deleteShader(this._shaders[e].handle);this.handle=null,this._attributes=null,this._uniforms=null,this._samplers=null,this.allocated=!1}},SceneJS._webgl.Program.prototype.setUniform=function(e,t){if(this.allocated){var r=this._uniforms[e];r&&(this.uniformValues[r.index]===t&&r.numberValue||(r.setValue(t),this.uniformValues[r.index]=t))}},SceneJS._webgl.Sampler=function(e,t,r,n,i,o){this.bindTexture=function(t,r){return t.bind(r)?(e.uniform1i(o,r),!0):!1}},SceneJS._webgl.Shader=function(e,t,r){if(this.allocated=!1,this.handle=e.createShader(t),!this.handle)throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to create WebGL shader");if(e.shaderSource(this.handle,r),e.compileShader(this.handle),this.valid=0!=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.valid&&!e.isContextLost()){SceneJS.log.error("Shader program failed to compile: "+e.getShaderInfoLog(this.handle)),SceneJS.log.error("Shader source:");for(var n=r.split("\n"),i=0;i<n.length;i++)SceneJS.log.error(i+1+": "+n[i]);throw SceneJS_error.fatalError(SceneJS.errors.SHADER_COMPILATION_FAILURE,"Shader program failed to compile")}this.allocated=!0},SceneJS._webgl.Texture2D=function(e,t){this.allocated=!1,this.target=t.target||e.TEXTURE_2D,this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.update=t.update,this.texture=t.texture,this.format=e.RGBA,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0;try{e.bindTexture(this.target,this.texture),t.minFilter&&e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,t.minFilter),t.magFilter&&e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,t.magFilter),t.wrapS&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,t.wrapS),t.wrapT&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,t.wrapT),(t.minFilter==e.NEAREST_MIPMAP_NEAREST||t.minFilter==e.LINEAR_MIPMAP_NEAREST||t.minFilter==e.NEAREST_MIPMAP_LINEAR||t.minFilter==e.LINEAR_MIPMAP_LINEAR)&&e.generateMipmap(this.target),e.bindTexture(this.target,null),this.allocated=!0}catch(r){throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to create texture: "+r.message||r)}this.bind=function(t){return this.allocated?this.texture?(e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,this.texture),this.update&&this.update(e),!0):!1:void 0},this.unbind=function(t){this.allocated&&this.texture&&(e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,null))},this.destroy=function(){this.allocated&&this.texture&&(e.deleteTexture(this.texture),this.texture=null)}},SceneJS._webgl.clampImageSize=function(e,t){var r=e.width*e.height;if(r>t){var n=t/r,i=e.width*n,o=e.height*n,a=document.createElement("canvas");a.width=SceneJS._webgl.nextHighestPowerOfTwo(i),a.height=SceneJS._webgl.nextHighestPowerOfTwo(o);var s=a.getContext("2d");s.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),e=a}return e},SceneJS._webgl.ensureImageSizePowerOfTwo=function(e){if(!SceneJS._webgl.isPowerOfTwo(e.width)||!SceneJS._webgl.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=SceneJS._webgl.nextHighestPowerOfTwo(e.width),t.height=SceneJS._webgl.nextHighestPowerOfTwo(e.height);var r=t.getContext("2d");r.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},SceneJS._webgl.isPowerOfTwo=function(e){return 0==(e&e-1)},SceneJS._webgl.nextHighestPowerOfTwo=function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},SceneJS._webgl.Uniform=function(e,t,r,n,i,o,a){var s=null;if(this.numberValue=!1,n==e.BOOL)this.numberValue=!0,s=function(t){e.uniform1i(o,t)};else if(n==e.BOOL_VEC2)s=function(t){e.uniform2iv(o,t)};else if(n==e.BOOL_VEC3)s=function(t){e.uniform3iv(o,t)};else if(n==e.BOOL_VEC4)s=function(t){e.uniform4iv(o,t)};else if(n==e.INT)this.numberValue=!0,s=function(t){e.uniform1iv(o,t)};else if(n==e.INT_VEC2)s=function(t){e.uniform2iv(o,t)};else if(n==e.INT_VEC3)s=function(t){e.uniform3iv(o,t)};else if(n==e.INT_VEC4)s=function(t){e.uniform4iv(o,t)};else if(n==e.FLOAT)this.numberValue=!0,s=function(t){e.uniform1f(o,t)};else if(n==e.FLOAT_VEC2)s=function(t){e.uniform2fv(o,t)};else if(n==e.FLOAT_VEC3)s=function(t){e.uniform3fv(o,t)};else if(n==e.FLOAT_VEC4)s=function(t){e.uniform4fv(o,t)};else if(n==e.FLOAT_MAT2)s=function(t){e.uniformMatrix2fv(o,e.FALSE,t)};else if(n==e.FLOAT_MAT3)s=function(t){e.uniformMatrix3fv(o,e.FALSE,t)};else{if(n!=e.FLOAT_MAT4)throw"Unsupported shader uniform type: "+n;s=function(t){e.uniformMatrix4fv(o,e.FALSE,t)}}this.setValue=s,this.getValue=function(){return e.getUniform(t,o)},this.getLocation=function(){return o},this.index=a};var SceneJS_nodeEventsModule=new function(){var e,t=[],r=[],n=0,i={type:"listeners",stateId:SceneJS._baseStateId++,empty:!0,listeners:[]};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){n=0,e=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(o){if(e){if(n>0){var a={type:"listeners",stateId:t[n-1],listeners:r.slice(0,n)};o.display.renderListeners=a}else o.display.renderListeners=i;e=!1}}),this.preVisitNode=function(i){var o=i._topicSubs.rendered,a=i._topicSubs.worldPos,s=i._topicSubs.viewPos,c=i._topicSubs.cameraPos,h=i._topicSubs.projPos,u=i._topicSubs.canvasPos;(o||a||s||c||h||u)&&(t[n]=i.id,r[n]=function(e){o&&i.publish("rendered",e,!0),a&&i.publish("worldPos",e.getWorldPos()),s&&i.publish("viewPos",e.getViewPos()),c&&i.publish("cameraPos",e.getCameraPos()),h&&i.publish("projPos",e.getProjPos()),u&&i.publish("canvasPos",e.getCanvasPos())},n++,e=!0)},this.postVisitNode=function(r){r.id==t[n-1]&&(n--,e=!0)}},SceneJS_Core=function(e){this.type=e,this.coreId=null,this.stateId=null,this.useCount=0},SceneJS_CoreFactory=function(){this._stateMap=new SceneJS_Map(null,SceneJS._baseStateId),this._cores={}};SceneJS_CoreFactory.coreTypes={},SceneJS_CoreFactory.createCoreType=function(){},SceneJS_CoreFactory.addCoreBuilder=function(){},SceneJS_CoreFactory.coreAliases={rotate:"xform",translate:"xform",scale:"xform",matrix:"xform",xform:"xform"},SceneJS_CoreFactory.prototype.getCore=function(e,t){var r=SceneJS_CoreFactory.coreAliases[e];r&&(e=r);var n=this._cores[e];n||(n=this._cores[e]={});var i;return t&&(i=n[t])?(i.useCount++,i):(i=new SceneJS_Core(e),i.useCount=1,i.stateId=this._stateMap.addItem(i),i.coreId=void 0!=t&&null!=t?t:i.stateId,n[i.coreId]=i,i)},SceneJS_CoreFactory.prototype.hasCore=function(e,t){var r=SceneJS_CoreFactory.coreAliases[e];r&&(e=r);var n=this._cores[e];return n&&n[t]},SceneJS_CoreFactory.prototype.putCore=function(e){if(0!=e.useCount&&--e.useCount<=0){var t=this._cores[e.type];delete t[e.coreId],this._stateMap.removeItem(e.stateId)}},SceneJS_CoreFactory.prototype.webglRestored=function(){var e,t;for(var r in this._cores)if(this._cores.hasOwnProperty(r)&&(e=this._cores[r]))for(var n in e)e.hasOwnProperty(n)&&(t=e[n],t&&t.webglRestored&&t.webglRestored())},SceneJS.Node=function(){},SceneJS.Node.prototype.constructor=SceneJS.Node,SceneJS.Node.prototype._construct=function(e,t,r,n){this._engine=e,this._core=t,this.coreId=t.coreId,this.id=r.id||r.nodeId||n,this.type=r.type||"node",this.data=r.data,this.parent=null,this.nodes=[],this._handleMap=new SceneJS_Map,this._topicSubs={},this._handleTopics={},this._topicPubs={},this._listeners={},this._numListeners=0,this.dirty=!1,this.branchDirty=!1,this._init&&this._init(r)},SceneJS.Node.prototype.taskStarted=function(e){return SceneJS_sceneStatusModule.taskStarted(this,e||"Task")},SceneJS.Node.prototype.taskFinished=function(e){return SceneJS_sceneStatusModule.taskFinished(e)},SceneJS.Node.prototype.taskFailed=function(e){return SceneJS_sceneStatusModule.taskFailed(e)},SceneJS.Node.prototype.log=function(){var e,t;switch(1==arguments.length?(e="info",t=arguments[0]):2==arguments.length&&(e=arguments[0],t=arguments[1]),e){case"warn":t="WARN;  [SceneJS.Node type="+this.type+", id="+this.id+"] : "+t;break;case"error":t="ERROR; [SceneJS.Node type="+this.type+", id="+this.id+"] : "+t;break;default:t="INFO;  [SceneJS.Node type="+this.type+", id="+this.id+"] : "+t}console[e]?console[e](t):console.log(t)},SceneJS.Node.prototype.publish=function(e,t,r){if(r||(this._topicPubs[e]=t),this._topicSubs[e]){var n=this._topicSubs[e];for(var i in n)n.hasOwnProperty(i)&&n[i].call(this,t)}},SceneJS.Node.prototype.unpublish=function(e){var t=this._topicSubs[e];if(t)for(var r in t)t.hasOwnProperty(r)&&t[r].call(this,null);delete this._topicPubs[e]},SceneJS.Node.prototype.on=function(e,t){var r=this._topicSubs[e];r||(r={},this._topicSubs[e]=r);var n=this._handleMap.addItem();r[n]=t,this._handleTopics[n]=e;var i=this._topicPubs[e];return i&&t.call(this,i),"rendered"==e&&this._engine.branchDirty(this),n},SceneJS.Node.prototype.off=function(e){var t=this._handleTopics[e];if(t){delete this._handleTopics[e];var r=this._topicSubs[t];r&&delete r[e],this._handleMap.removeItem(e),"rendered"==t&&this._engine.branchDirty(this)}},SceneJS.Node.prototype.once=function(e,t){var r=this,n=this.on(e,function(e){r.off(n),t(e)})},SceneJS.Node.prototype.getScene=function(){return this._engine.scene},SceneJS.Node.prototype.getCoreId=function(){return this._core.coreId},SceneJS.Node.prototype.getID=function(){return this.id},SceneJS.Node.prototype.getId=function(){return this.id},SceneJS.Node.prototype.getNodeId=function(){return this.id},SceneJS.Node.prototype.getType=function(){return this.type},SceneJS.Node.prototype.getData=function(){return this.data},SceneJS.Node.prototype.setData=function(e){return this.data=e,this},SceneJS.Node.prototype.getNumNodes=function(){return this.nodes.length},SceneJS.Node.prototype.getNodes=function(){return this.nodes.slice(0)},SceneJS.Node.prototype.getNodeAt=function(e){return 0>e||e>=this.nodes.length?null:this.nodes[e]},SceneJS.Node.prototype.getFirstNode=function(){return 0==this.nodes.length?null:this.nodes[0]},SceneJS.Node.prototype.getLastNode=function(){return 0==this.nodes.length?null:this.nodes[this.nodes.length-1]},SceneJS.Node.prototype.getNode=function(e){for(var t=0;t<this.nodes.length;t++)if(this.nodes[t].id==e)return this.nodes[t];return null},SceneJS.Node.prototype.disconnectNodeAt=function(e){var t=this.nodes.splice(e,1);return t.length>0?(t[0].parent=null,this._engine.display.objectListDirty=!0,t[0]):null},SceneJS.Node.prototype.disconnect=function(){if(this.parent){for(var e=0;e<this.parent.nodes.length;e++)if(this.parent.nodes[e]===this){var t=this.parent.disconnectNodeAt(e);return this.parent=null,t}this.parent=null}return null},SceneJS.Node.prototype.removeNodeAt=function(e){var t=this.disconnectNodeAt(e);t&&(t.destroy(),this._engine.display.objectListDirty=!0)},SceneJS.Node.prototype.removeNode=function(e){if(!e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#removeNode - node argument undefined");if(!e._compile&&"string"==typeof e){var t=this._engine.findNode(e);if(!t)throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - node not found anywhere: '"+e+"'");e=t}if(e._compile)for(var r=0;r<this.nodes.length;r++)if(this.nodes[r]===e){var n=this.removeNodeAt(r);return this._engine.display.objectListDirty=!0,n}throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - child node not found: "+(e._compile?": "+e.id:e))},SceneJS.Node.prototype.disconnectNodes=function(){for(var e=this.nodes.length,t=0;e>t;t++)this.nodes[t].parent=null;var r=this.nodes;return this.nodes=[],this._engine.display.objectListDirty=!0,r},SceneJS.Node.prototype.removeNodes=function(){for(var e=this.disconnectNodes(),t=0;t<e.length;t++)e[t].destroy(),this._engine.display.objectListDirty=!0},SceneJS.Node.prototype.splice=function(){var e,t;if(null==this.parent)return null;var r=this.parent,n=this.disconnectNodes();for(e=0,t=n.length;t>e;e++)n[e].parent=this.parent;for(e=0,t=r.nodes.length;t>e;e++)if(r.nodes[e]===this)return r.nodes.splice.apply(r.nodes,[e,1].concat(n)),this.nodes=[],this.parent=null,this.destroy(),this._engine.branchDirty(r),r},SceneJS.Node.prototype.addNodes=function(e,t){if(!e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNodes - nodes argument is undefined");for(var r,n=[],i=e.length,o=e.length-1;o>=0;o--){var a=e[o];if("node"==a.type||this._engine.hasNodeType(a.type)){if(r=this.addNode(a),n[o]=r,0==--i)return t&&t(e),e}else{var s=this;!function(){var r=o;s.addNode(a,function(o){n[r]=o,0==--i&&t&&t(e)})}()}}return null},SceneJS.Node.prototype.addNode=function(e,t){if(e=e||{},e._compile){if(null!=e.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent");return this.nodes.push(e),e.parent=this,this._engine.branchDirty(e),t&&t(e),e}if("string"==typeof e){var r=this._engine.findNode(e);if(!r)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node not found: '"+e+"'");if(e=r,null!=e.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent");return this.nodes.push(e),e.parent=this,this._engine.branchDirty(e),t&&t(e),e}if(e.type=e.type||"node","node"==e.type||this._engine.hasNodeType(e.type))return e=this._engine.createNode(e),this.nodes.push(e),e.parent=this,this._engine.branchDirty(e),t&&t(e),e;var n=this;return this._engine.createNode(e,function(e){n.nodes.push(e),e.parent=n,n._engine.branchDirty(e),t&&t(e)}),null},SceneJS.Node.prototype.insertNode=function(e,t){if(!e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is undefined");if(e._compile||(e=this._engine.createNode(e)),!e._compile)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is not a SceneJS.Node");if(null!=e.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is still attached to another parent");if(void 0===t||null===t)e.addNodes(this.disconnectNodes()),this.addNode(e);else{if(0>t)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node index out of range: -1");t>=this.nodes.length?this.nodes.push(e):this.nodes.splice(t,0,e)}return e.parent=this,e},SceneJS.Node.prototype.mapNodes=function(e){if(e(this))return this;for(var t,r=0;r<this.nodes.length;r++)if(t=this.nodes[r].mapNodes(e))return t;return null},SceneJS.Node.prototype.addListener=function(e,t,r){var n=this._listeners[e];return n||(n=[],this._listeners[e]=n),n.push({eventName:e,fn:t,options:r||{}}),this._numListeners++,this},SceneJS.Node.prototype._fireEvent=function(e,t,r){var n=this._listeners[e];if(n){t||(t={});for(var i,o={name:e,params:t,options:r||{}},a=0,s=n.length;s>a;a++)i=n[a],i.options.scope?i.fn.call(i.options.scope,o):i.fn.call(this,o)}},SceneJS.Node.prototype.removeListener=function(e,t){var r=this._listeners[e];if(!r)return null;for(var n=0;n<r.length;n++)if(r[n].fn==t)return r.splice(n,1),t;return this._numListeners--,null},SceneJS.Node.prototype.hasListener=function(e){return this._listeners[e]},SceneJS.Node.prototype.hasListeners=function(){return this._numListeners>0},SceneJS.Node.prototype.removeListeners=function(){return this._listeners={},this._numListeners=0,this},SceneJS.Node.prototype.getParent=function(){return this.parent},SceneJS.Node.prototype.getParentOfType=function(e){for(var t=this.parent;t&&t.type!=e;)t=t.parent;return t},SceneJS.Node.prototype.eachParent=function(e){if(!e)throw"SceneJS.Node.eachParent param 'fn' is null or undefined";for(var t=0,r=this;r.parent;){if(e.call(r.parent,t++)===!0)return r.parent;r=r.parent}return null},SceneJS.Node.prototype.hasNode=function(e){if(null===e||void 0===e)throw"SceneJS.Node.hasNode param 'node' is null or undefined";var t,r=typeof e;if("number"==r)t=this.getNodeAt(e);else{if("string"!=r)throw"SceneJS.Node.hasNode param 'node' should be either an index number or an ID string";t=this.getNode(e)}return void 0!=t&&null!=t},SceneJS.Node.prototype.node=function(e){if(null===e||void 0===e)throw"SceneJS.Node.node param 'node' is null or undefined";var t,r=typeof e;if("number"==r)t=this.getNodeAt(e);else{if("string"!=r)throw"SceneJS.Node.node param 'node' should be either an index number or an ID string";t=this.getNode(e)}if(!t)throw"SceneJS.Node.node - node not found: '"+e+"'";return t},SceneJS.Node.prototype.eachNode=function(e,t){if(!e)throw"SceneJS.Node.eachNode param 'fn' is null or undefined";if("function"!=typeof e)throw"SceneJS.Node.eachNode param 'fn' should be a function";var r;t=t||{};var n=0;return t.andSelf&&e.call(this,n++)===!0?this:(t.depthFirst||t.breadthFirst?t.depthFirst&&(r=this._iterateEachNodeDepthFirst(e,this,n,!1)):r=this._iterateEachNode(e,this,n),r?r:void 0)},SceneJS.Node.prototype.numNodes=function(){return this.nodes.length},SceneJS.Node.prototype._iterateEachNode=function(e,t,r){for(var n,i=t.nodes.length,o=0;i>o;o++)if(n=t.nodes[o],e.call(n,r++)===!0)return n;return null},SceneJS.Node.prototype._iterateEachNodeDepthFirst=function(e,t,r,n){if(n&&e.call(t,r++)===!0)return t;n=!0;for(var i,o=t.nodes.length,a=0;o>a;a++)if(i=this._iterateEachNodeDepthFirst(e,t.nodes[a],r,n))return i;return null},SceneJS.Node.prototype.findNodesByType=function(e,t){return this._findNodesByType(e,[],t)},SceneJS.Node.prototype._findNodesByType=function(e,t,r){var n;for(n=0;n<this.nodes.length;n++){var i=this.nodes[n];i.type==e&&t.push(i)}if(r)for(n=0;n<this.nodes.length;n++)this.nodes[n]._findNodesByType(e,t,r);return t},SceneJS.Node.prototype.findParentByType=function(e){for(var t=this.parent;t&&t.type!=e;)t=t.parent;return t},SceneJS.Node.prototype.set=function(e,t){if("object"!=typeof e){if(this._set){var r=this._set[e];if(r)return r.call(this,t)}return this._createAccessor("set",e,t)}for(var n in e)e.hasOwnProperty(n)&&this.set(n,e[n])},SceneJS.Node.prototype.get=function(e){if(this._get){var t=this._get[e];if(t)return t.call(this)}return this._createAccessor("get",e)},SceneJS.Node.prototype.add=function(e,t){if("object"!=typeof e){if(this._add){var r=this._add[e];if(r)return r.call(this,t)}return this._createAccessor("add",e,t)}for(var n in e)e.hasOwnProperty(n)&&this.add(n,e[n])},SceneJS.Node.prototype.inc=function(e,t){if("object"!=typeof e){if(this._inc){var r=this._inc[e];if(r)return r.call(this,t)}return this._createAccessor("inc",e,t)}for(var n in e)e.hasOwnProperty(n)&&this.inc(n,e[n])},SceneJS.Node.prototype.insert=function(e,t){if("object"!=typeof e){if(this._set){var r=this._set[e];if(r)return r.call(this,t)}return this._createAccessor("insert",e,t)}for(var n in e)e.hasOwnProperty(n)&&this.insert(n,e[n])},SceneJS.Node.prototype.remove=function(e,t){if("object"!=typeof e){if(this._remove){var r=this._remove[e];if(r)return r.call(this,t)}return this._createAccessor("remove",e,t)}for(var n in e)e.hasOwnProperty(n)&&this.remove(n,e[n])},SceneJS.Node.prototype._createAccessor=function(e,t,r){var n=e+t.substr(0,1).toUpperCase()+t.substr(1),i=this[n];if(!i)throw"Method not found on node: '"+n+"'";var o,a=this.__proto__;switch(e){case"set":o=a._set||(a._set={});break;case"get":o=a._get||(a._get={});break;case"inc":o=a._inc||(a._inc={});break;case"add":o=a._add||(a._add={});break;case"insert":o=a._insert||(a._insert={});break;case"remove":o=a._remove||(a._remove={})}return o[t]=i,i.call(this,r)},SceneJS.Node.prototype.bind=function(e,t){if(!e)throw"SceneJS.Node.bind param 'name' null or undefined";if("string"!=typeof e)throw"SceneJS.Node.bind param 'name' should be a string";if(!t)throw"SceneJS.Node.bind param 'handler' null or undefined";if("function"!=typeof t)throw"SceneJS.Node.bind param 'handler' should be a function";return this.addListener(e,t,{scope:this}),this._engine.branchDirty(this),t},SceneJS.Node.prototype.getJSON=function(){return this},SceneJS.Node.prototype._compile=function(e){this.preCompile&&this.preCompile(),this._compileNodes(e),this.postCompile&&this.postCompile()},SceneJS.Node.prototype._compileNodes=function(e){var t=this._topicSubs.rendered;t&&SceneJS_nodeEventsModule.preVisitNode(this);for(var r,n=0,i=this.nodes.length;i>n;n++)r=this.nodes[n],r.branchDirty=r.branchDirty||this.branchDirty,(r.dirty||r.branchDirty||this._engine.sceneDirty)&&(r._compile(e),r.dirty=!1,r.branchDirty=!1);t&&SceneJS_nodeEventsModule.postVisitNode(this)},SceneJS.Node.prototype.destroy=function(){if(!this.destroyed){if(this.parent)for(var e=0;e<this.nodes.length;e++)if(this.parent.nodes[e].id===this.id){this.parent.nodes.splice(e,1);break}this._engine.scene.unpublish("nodes/"+this.id),this._destroyTree(),this._engine.display.objectListDirty=!0}return this},SceneJS.Node.prototype._destroyTree=function(){this.destroyed=!0,this._engine.destroyNode(this);for(var e=0,t=this.nodes.length;t>e;e++)this.nodes[e]._destroyTree()},SceneJS.Node.prototype._doDestroy=function(){return this._destroy&&this._destroy(),this},SceneJS_PubSubProxy=function(e,t){this.scene=e,this.proxy=t};var SceneJS_NodeFactory=function(){this.nodes=new SceneJS_Map({})};SceneJS_NodeFactory.nodeTypes={},SceneJS_NodeFactory._subs={},SceneJS_NodeFactory.createNodeType=function(e,t,r){if(SceneJS_NodeFactory.nodeTypes[e])throw"Node type already defined: "+e;var n=function(){SceneJS.Node.apply(this,arguments),this.type=e};n.prototype=new SceneJS.Node,n.prototype.constructor=n,SceneJS_NodeFactory.nodeTypes[e]=n;var i=SceneJS_NodeFactory.nodeTypes[e];if(!i)throw"Node type plugin did not install itself correctly";r&&r(n);var o=SceneJS_NodeFactory._subs[e];if(o){for(;o.length>0;)o.pop()(i);delete o[e]}return n},SceneJS_NodeFactory.prototype.getNode=function(e,t,r,n){t.type=t.type||"node";var i;if(i="node"==t.type?SceneJS.Node:SceneJS_NodeFactory.nodeTypes[t.type])return this._createNode(i,e,t,r,n);var o=this;this._getType(e,t.type,function(i){o._createNode(i,e,t,r,n)})},SceneJS_NodeFactory.prototype._createNode=function(e,t,r,n,i){var o=new e,a=r.id||r.nodeId;return a?this.nodes.addItem(a,o):a=this.nodes.addItem(o),o._construct(t,n,r,a),i&&i(o),o},SceneJS_NodeFactory.prototype._getType=function(e,t,r){var n=SceneJS_NodeFactory.nodeTypes[t];if(n)return void r(n);var i=SceneJS_NodeFactory._subs[t]||(SceneJS_NodeFactory._subs[t]=[]);if(i.push(r),!(i.length>1)){var o=SceneJS_sceneStatusModule.taskStarted(e.scene,"Loading plugin");i.push(function(){SceneJS_sceneStatusModule.taskFinished(o)});var a=SceneJS_configsModule.configs.pluginPath;if(!a)throw"no typePath config";this._loadScript(a+"/node/"+t+".js",function(){SceneJS_sceneStatusModule.taskFailed(o)})}},SceneJS_NodeFactory.prototype._loadScript=function(e,t){var r=document.createElement("script");r.type="text/javascript",r.src=e,r.onerror=t,document.getElementsByTagName("head")[0].appendChild(r)},SceneJS_NodeFactory.prototype.putNode=function(e){this.nodes.removeItem(e.id)},function(){function e(e){var t=e.optics;if("ortho"==t.type?e.matrix=SceneJS_math_orthoMat4c(t.left,t.right,t.bottom,t.top,t.near,t.far):"frustum"==t.type?e.matrix=SceneJS_math_frustumMatrix4(t.left,t.right,t.bottom,t.top,t.near,t.far):"perspective"==t.type&&(e.matrix=SceneJS_math_perspectiveMatrix4(t.fovy*Math.PI/180,t.aspect,t.near,t.far)),e.pan){var r=e.pan,n=SceneJS_math_translationMat4v([r.x||0,r.y||0,r.z||0]);e.matrix=SceneJS_math_mulMat4(n,e.matrix,[])}e.mat?e.mat.set(e.matrix):e.mat=new Float32Array(e.matrix)}var t=SceneJS_math_perspectiveMatrix4(45,1,.1,1e4),r=new Float32Array(t),n={type:"camera",stateId:SceneJS._baseStateId++,matrix:t,mat:r,optics:{type:"perspective",fovy:45,aspect:1,near:.1,far:1e4},checkAspect:function(t,r){t.optics.aspect!=r&&(t.optics.aspect=r,e(this))
}},i=[],o=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.projTransform=n,o=0}),SceneJS.Camera=SceneJS_NodeFactory.createNodeType("camera"),SceneJS.Camera.prototype._init=function(t){if(1==this._core.useCount){t.optics=t.optics||{};var r=this.getScene().getCanvas();t.optics.aspect=r.width/r.height,this.setOptics(t.optics),t.pan&&this.setPan(t.pan);var n=this;this._canvasSizeSub=this.getScene().on("canvasSize",function(t){n._core.optics.aspect=t.aspect,e(n._core),n._engine.display.imageDirty=!0})}},SceneJS.Camera.getDefaultMatrix=function(){return r},SceneJS.Camera.prototype.setOptics=function(t){var r=this._core;if(t){var n=t.type||r.optics.type||"perspective";if("ortho"==n)r.optics=SceneJS._applyIf(SceneJS_math_ORTHO_OBJ,{type:n,left:t.left,bottom:t.bottom,near:t.near,right:t.right,top:t.top,far:t.far});else if("frustum"==n)r.optics={type:n,left:t.left||-1,bottom:t.bottom||-1,near:t.near||.1,right:t.right||1,top:t.top||1,far:t.far||1e4};else{if("perspective"!=n)throw t.type?SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not supported - supported types are 'perspective', 'frustum' and 'ortho'"):SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not specified - supported types are 'perspective', 'frustum' and 'ortho'");r.optics={type:n,fovy:t.fovy||60,aspect:void 0==t.aspect?1:t.aspect,near:t.near||.1,far:t.far||1e4}}}else r.optics={type:"perspective",fovy:60,aspect:1,near:.1,far:1e4};this._core.optics.pan=t.pan,e(this._core),this.publish("matrix",this._core.matrix),this._engine.display.imageDirty=!0},SceneJS.Camera.prototype.setPan=function(t){this._core.pan=t,e(this._core),this.publish("matrix",this._core.matrix),this._engine.display.imageDirty=!0},SceneJS.Camera.prototype.getOptics=function(){var e={};for(var t in this._core.optics)this._core.optics.hasOwnProperty(t)&&(e[t]=this._core.optics[t]);return e},SceneJS.Camera.prototype.getMatrix=function(){return this._core.matrix.slice(0)},SceneJS.Camera.prototype._compile=function(e){this._engine.display.projTransform=i[o++]=this._core,this._compileNodes(e),this._engine.display.projTransform=--o>0?i[o-1]:n},SceneJS.Camera.prototype._destroy=function(){this.getScene().off(this._canvasSizeSub)}}(),function(){var e={type:"clips",stateId:SceneJS._baseStateId++,empty:!0,hash:"",clips:[]},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.clips=e,r=0}),SceneJS.Clips=SceneJS_NodeFactory.createNodeType("clips"),SceneJS.Clips.prototype._init=function(e){if(1==this._core.useCount){var t=e.clips;if(!t)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"clips node attribute missing : 'clips'");this._core.clips=this._core.clips||[];for(var r=0,n=t.length;n>r;r++)this._setClip(r,t[r])}},SceneJS.Clips.prototype.setClips=function(e){var t;for(var r in e)if(e.hasOwnProperty(r)&&(void 0!=r||null!=r)){if(t=parseInt(r),0>t||t>=this._core.clips.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'clips': index out of range ("+this._core.clips.length+" clips defined)");this._setClip(t,e[r]||{})}this._engine.display.imageDirty=!0},SceneJS.Clips.prototype._setClip=function(e,t){var r=this._core.clips[e]||(this._core.clips[e]={});r.normalAndDist=[t.x||0,t.y||0,t.z||0,t.dist||0];var n=t.mode||r.mode||"disabled";if("inside"!=n&&"outside"!=n&&"disabled"!=n)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"clips node invalid value for property 'mode': should be 'inside' or 'outside' or 'disabled'");r.mode=n,this._core.hash=null},SceneJS.Clips.prototype._compile=function(n){this._core.hash||(this._core.hash=this._core.clips.length),this._engine.display.clips=t[r++]=this._core,this._compileNodes(n),this._engine.display.clips=--r>0?t[r-1]:e}}(),function(){var e={stateId:SceneJS._baseStateId++,type:"enable",enabled:!0},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.enable=e,r=0}),SceneJS.Enable=SceneJS_NodeFactory.createNodeType("enable"),SceneJS.Enable.prototype._init=function(e){1==this._core.useCount&&(this._core.enabled=!0,void 0!=e.enabled&&this.setEnabled(e.enabled))},SceneJS.Enable.prototype.setEnabled=function(e){return e!==this._core.enabled&&(this._core.enabled=e,this._engine.display.drawListDirty=!0,this.publish("enabled",e)),this},SceneJS.Enable.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Enable.prototype._compile=function(n){this._engine.display.enable=t[r++]=this._core,this._compileNodes(n),this._engine.display.enable=--r>0?t[r-1]:e}}(),function(){var e={stateId:SceneJS._baseStateId++,type:"flags",picking:!0,clipping:!0,enabled:!0,transparent:!1,backfaces:!0,frontface:"ccw",backfaceLighting:!0,backfaceTexturing:!0,diffuse:!0,specular:!0,ambient:!0,reflection:!0},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.flags=e,r=0}),SceneJS.Flags=SceneJS_NodeFactory.createNodeType("flags"),SceneJS.Flags.prototype._init=function(e){1==this._core.useCount&&(this._core.picking=!0,this._core.clipping=!0,this._core.enabled=!0,this._core.transparent=!1,this._core.backfaces=!0,this._core.frontface="ccw",this._core.backfaceLighting=!0,this._core.backfaceTexturing=!0,this._core.diffuse=!0,this._core.specular=!0,this._core.ambient=!0,this._core.reflection=!0,e.flags&&this.setFlags(e.flags))},SceneJS.Flags.prototype.setFlags=function(e){var t=this._core;return void 0!=e.picking&&(t.picking=!!e.picking,this._engine.display.drawListDirty=!0),void 0!=e.clipping&&(t.clipping=!!e.clipping,this._engine.display.imageDirty=!0),void 0!=e.enabled&&(t.enabled=!!e.enabled,this._engine.display.drawListDirty=!0),void 0!=e.transparent&&(t.transparent=!!e.transparent,this._engine.display.stateSortDirty=!0),void 0!=e.backfaces&&(t.backfaces=!!e.backfaces,this._engine.display.imageDirty=!0),void 0!=e.frontface&&(t.frontface=e.frontface,this._engine.display.imageDirty=!0),void 0!=e.backfaceLighting&&(t.backfaceLighting=!!e.backfaceLighting,this._engine.display.imageDirty=!0),void 0!=e.backfaceTexturing&&(t.backfaceTexturing=!!e.backfaceTexturing,this._engine.display.imageDirty=!0),void 0!=e.diffuse&&(t.diffuse=!!e.diffuse,this._engine.display.imageDirty=!0),void 0!=e.specular&&(t.specular=!!e.specular,this._engine.display.imageDirty=!0),void 0!=e.ambient&&(t.ambient=!!e.ambient,this._engine.display.imageDirty=!0),void 0!=e.reflection&&(t.reflection=!!e.reflection,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.addFlags=function(e){return this.setFlags(e)},SceneJS.Flags.prototype.getFlags=function(){var e=this._core;return{picking:e.picking,clipping:e.clipping,enabled:e.enabled,transparent:e.transparent,backfaces:e.backfaces,frontface:e.frontface,diffuse:e.diffuse,specular:e.specular,ambient:e.ambient,backfaceLighting:e.backfaceLighting,backfaceTexturing:e.backfaceTexturing,reflection:e.reflection}},SceneJS.Flags.prototype.setPicking=function(e){return e=!!e,this._core.picking!=e&&(this._core.picking=e,this._engine.display.drawListDirty=!0),this},SceneJS.Flags.prototype.getPicking=function(){return this._core.picking},SceneJS.Flags.prototype.setClipping=function(e){return e=!!e,this._core.clipping!=e&&(this._core.clipping=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getClipping=function(){return this._core.clipping},SceneJS.Flags.prototype.setEnabled=function(e){return e=!!e,this._core.enabled!=e&&(this._core.enabled=e,this._engine.display.drawListDirty=!0),this},SceneJS.Flags.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Flags.prototype.setTransparent=function(e){return e=!!e,this._core.transparent!=e&&(this._core.transparent=e,this._engine.display.stateOrderDirty=!0),this},SceneJS.Flags.prototype.getTransparent=function(){return this._core.transparent},SceneJS.Flags.prototype.setBackfaces=function(e){return e=!!e,this._core.backfaces!=e&&(this._core.backfaces=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getBackfaces=function(){return this._core.backfaces},SceneJS.Flags.prototype.setFrontface=function(e){return this._core.frontface!=e&&(this._core.frontface=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getFrontface=function(){return this._core.frontface},SceneJS.Flags.prototype.setBackfaceLighting=function(e){return e=!!e,this._core.backfaceLighting!=e&&(this._core.backfaceLighting=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getBackfaceLighting=function(){return this._core.backfaceLighting},SceneJS.Flags.prototype.setBackfaceTexturing=function(e){return e=!!e,this._core.backfaceTexturing!=e&&(this._core.backfaceTexturing=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getBackfaceTexturing=function(){return this._core.backfaceTexturing},SceneJS.Flags.prototype.setDiffuse=function(e){return e=!!e,this._core.diffuse!=e&&(this._core.diffuse=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getDiffuse=function(){return this._core.diffuse},SceneJS.Flags.prototype.setSpecular=function(e){return e=!!e,this._core.specular!=e&&(this._core.specular=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getSpecular=function(){return this._core.specular},SceneJS.Flags.prototype.setAmbient=function(e){return e=!!e,this._core.ambient!=e&&(this._core.ambient=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getAmbient=function(){return this._core.ambient},SceneJS.Flags.prototype.setReflection=function(e){return e=!!e,this._core.reflection!=e&&(this._core.reflection=e,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getReflection=function(){return this._core.reflection},SceneJS.Flags.prototype._compile=function(n){this._engine.display.flags=t[r++]=this._core,this._compileNodes(n),this._engine.display.flags=--r>0?t[r-1]:e}}(),new function(){var e={type:"renderTarget",stateId:SceneJS._baseStateId++,targets:null},t={},r=[],n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.renderTarget=e,n=0}),SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){for(var e in t)t.hasOwnProperty(e)&&t[e]._core.renderBuf.webglRestored()}),SceneJS.ColorTarget=SceneJS_NodeFactory.createNodeType("colorTarget"),SceneJS.ColorTarget.prototype._init=function(){t[this._core.coreId]=this,this._core.bufType="color",this._core.renderBuf=new SceneJS._webgl.RenderBuffer({canvas:this._engine.canvas})},SceneJS.ColorTarget.prototype._compile=function(t){this.__core||(this.__core=this._engine._coreFactory.getCore("renderTarget"));var i=this._engine.display.renderTarget;this._core.empty||(this.__core.targets=i&&i.targets?i.targets.concat([this._core]):[this._core]),r[n++]=this.__core,this._engine.display.renderTarget=this.__core,this._compileNodes(t),this._engine.display.renderTarget=--n>0?r[n-1]:e},SceneJS.ColorTarget.prototype._destroy=function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete t[this._core.coreId])}},new function(){var e={type:"renderTarget",stateId:SceneJS._baseStateId++,targets:null},t={},r=[],n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.renderTarget=e,n=0}),SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){for(var e in t)t.hasOwnProperty(e)&&t[e]._buildNodeCore()}),SceneJS.DepthTarget=SceneJS_NodeFactory.createNodeType("depthTarget"),SceneJS.DepthTarget.prototype._init=function(){t[this._core.coreId]=this,this._core.bufType="depth",this._core.renderBuf=new SceneJS._webgl.RenderBuffer({canvas:this._engine.canvas})},SceneJS.DepthTarget.prototype._compile=function(t){this.__core||(this.__core=this._engine._coreFactory.getCore("renderTarget"));var i=this._engine.display.renderTarget;this._core.empty||(this.__core.targets=i&&i.targets?i.targets.concat([this._core]):[this._core]),r[n++]=this.__core,this._engine.display.renderTarget=this.__core,this._compileNodes(t),this._engine.display.renderTarget=--n>0?r[n-1]:e},SceneJS.DepthTarget.prototype._destroy=function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete t[this._core.coreId])}},new function(){var e=[],t=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){t=0}),SceneJS.Geometry=SceneJS_NodeFactory.createNodeType("geometry"),SceneJS.Geometry.prototype._init=function(e){if(1==this._core.useCount){this._initNodeCore(e,{origin:e.origin,scale:e.scale,autoNormals:"auto"==e.normals}),this._buildNodeCore(this._engine.canvas.gl,this._core);var t=this;this._core.webglRestored=function(){t._buildNodeCore(t._engine.canvas.gl,t._core)}}},SceneJS.Geometry.prototype._initNodeCore=function(e,t){var r=this;t=t||{};var n=e.primitive||"triangles",i=this._core;i.primitive=this._getPrimitiveType(n),e.normals&&"triangles"==n&&("auto"===e.normals||e.normals===!0)&&e.positions&&e.indices&&this._buildNormals(e),i.arrays={positions:e.positions?new Float32Array(t.scale||t.origin?this._applyOptions(e.positions,t):e.positions):void 0,normals:e.normals?new Float32Array(e.normals):void 0,uv:e.uv?new Float32Array(e.uv):void 0,uv2:e.uv2?new Float32Array(e.uv2):void 0,colors:e.colors?new Float32Array(e.colors):void 0,indices:e.indices?new Uint16Array(e.indices):void 0},delete e.positions,delete e.normals,delete e.uv,delete e.uv2,delete e.indices,delete e.colors,i.getTangentBuf=function(){if(i.tangentBuf)return i.tangentBuf;var e=i.arrays;if(e.positions&&e.indices&&e.uv){var t=r._engine.canvas.gl,n=new Float32Array(r._buildTangents(e));i.arrays.tangents=n;var o=t.STATIC_DRAW;return i.tangentBuf=new SceneJS._webgl.ArrayBuffer(t,t.ARRAY_BUFFER,n,n.length,3,o)}}},SceneJS.Geometry.prototype._getPrimitiveType=function(e){var t=this._engine.canvas.gl;switch(e){case"points":return t.POINTS;case"lines":return t.LINES;case"line-loop":return t.LINE_LOOP;case"line-strip":return t.LINE_STRIP;case"triangles":return t.TRIANGLES;case"triangle-strip":return t.TRIANGLE_STRIP;case"triangle-fan":return t.TRIANGLE_FAN;default:throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry primitive unsupported: '"+e+"' - supported types are: 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'")}},SceneJS.Geometry.prototype._applyOptions=function(e,t){var r=e.slice?e.slice(0):new Float32Array(e);if(t.scale)for(var n=void 0!=t.scale.x?t.scale.x:1,i=void 0!=t.scale.y?t.scale.y:1,o=void 0!=t.scale.z?t.scale.z:1,a=0,s=r.length;s>a;a+=3)r[a]*=n,r[a+1]*=i,r[a+2]*=o;if(t.origin)for(var c=void 0!=t.origin.x?t.origin.x:0,h=void 0!=t.origin.y?t.origin.y:0,u=void 0!=t.origin.z?t.origin.z:0,a=0,s=r.length;s>a;a+=3)r[a]-=c,r[a+1]-=h,r[a+2]-=u;return r};var r=function(e){e.vertexBuf&&(e.vertexBuf.destroy(),e.vertexBuf=null),e.normalBuf&&(e.normalBuf.destroy(),e.normalBuf=null),e.uvBuf&&(e.uvBuf.destroy(),e.uvBuf=null),e.uvBuf2&&(e.uvBuf2.destroy(),e.uvBuf2=null),e.colorBuf&&(e.colorBuf.destroy(),e.colorBuf=null),e.tangentBuf&&(e.tangentBuf.destroy(),e.tangentBuf=null),e.indexBuf&&(e.indexBuf.destroy(),e.indexBuf=null),e.interleavedBuf&&(e.interleavedBuf.destroy(),e.interleavedBuf=null)};SceneJS.Geometry.prototype._buildNodeCore=function(e,t){var n=e.STATIC_DRAW;try{var i=t.arrays,o=SceneJS.getConfigs("enableInterleaving")!==!1,a=0,s=0,c=[],h=[],u=function(e,t){return 0==a?a=e.length/t:e.length/t!=a&&(o=!1),c.push(e),h.push(t),s+=t,4*(s-t)};if(i.positions&&(o&&(t.interleavedPositionOffset=u(i.positions,3)),t.vertexBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,i.positions,i.positions.length,3,n)),i.normals&&(o&&(t.interleavedNormalOffset=u(i.normals,3)),t.normalBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,i.normals,i.normals.length,3,n)),i.uv&&(o&&(t.interleavedUVOffset=u(i.uv,2)),t.uvBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,i.uv,i.uv.length,2,n)),i.uv2&&(o&&(t.interleavedUV2Offset=u(i.uv2,2)),t.uvBuf2=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,i.uv2,i.uv2.length,2,n)),i.colors&&(o&&(t.interleavedColorOffset=u(i.colors,4)),t.colorBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,i.colors,i.colors.length,4,n)),i.indices&&(t.indexBuf=new SceneJS._webgl.ArrayBuffer(e,e.ELEMENT_ARRAY_BUFFER,i.indices,i.indices.length,1,n)),s>0&&o){for(var l=[],S=c.length,p=0;a>p;++p)for(var _=0;S>_;++_)for(var d=h[_],f=0;d>f;++f)l.push(c[_][p*d+f]);t.interleavedStride=4*s,t.interleavedBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,new Float32Array(l),l.length,s,n),t.interleavedBuf.dirty=!1}}catch(m){throw r(t),SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate geometry: "+m)}},SceneJS.Geometry.prototype._updateArray=function(e,t,r){var n=e.length,i=t.length;i+r>n&&(i-=i+r-n);for(var o=r,a=0;i>a;o++,a++)e[o]=t[a]},SceneJS.Geometry.prototype._buildNormals=function(e){for(var t,r,n,i,o,a,s=e.positions,c=e.indices,h=new Array(s.length/3),u=0,l=c.length-3;l>u;u+=3){t=c[u+0],r=c[u+1],n=c[u+2],i=[s[3*t+0],s[3*t+1],s[3*t+2]],o=[s[3*r+0],s[3*r+1],s[3*r+2]],a=[s[3*n+0],s[3*n+1],s[3*n+2]],o=SceneJS_math_subVec4(o,i,[0,0,0,0]),a=SceneJS_math_subVec4(a,i,[0,0,0,0]);var S=SceneJS_math_normalizeVec4(SceneJS_math_cross3Vec4(o,a,[0,0,0,0]),[0,0,0,0]);h[t]||(h[t]=[]),h[r]||(h[r]=[]),h[n]||(h[n]=[]),h[t].push(S),h[r].push(S),h[n].push(S)}for(var p=new Array(s.length),u=0,l=h.length;l>u;u++){for(var _=h[u].length,d=0,f=0,m=0,g=0;_>g;g++)d+=h[u][g][0],f+=h[u][g][1],m+=h[u][g][2];p[3*u+0]=d/_,p[3*u+1]=f/_,p[3*u+2]=m/_}e.normals=p},SceneJS.Geometry.prototype._buildTangents=function(e){for(var t=e.positions,r=e.indices,n=e.uv,i=[],o=0;o<r.length;o+=3){var a=r[o],s=[t[3*a],t[3*a+1],t[3*a+2]],c=[n[2*a],n[2*a+1]];a=r[o+1];var h=[t[3*a],t[3*a+1],t[3*a+2]],u=[n[2*a],n[2*a+1]];a=r[o+2];for(var l=[t[3*a],t[3*a+1],t[3*a+2]],S=[n[2*a],n[2*a+1]],p=SceneJS_math_subVec3(h,s,[]),_=SceneJS_math_subVec3(l,s,[]),d=SceneJS_math_subVec2(u,c,[]),f=SceneJS_math_subVec2(S,c,[]),m=1/(d[0]*f[1]-d[1]*f[0]),g=SceneJS_math_mulVec3Scalar(SceneJS_math_subVec3(SceneJS_math_mulVec3Scalar(p,f[1],[]),SceneJS_math_mulVec3Scalar(_,d[1],[]),[]),m,[]),y=0;3>y;y++){var v=r[o+y];i[v]="undefined"!=typeof i[v]?SceneJS_math_addVec3(i[v],g,[]):g}}for(var J=[],E=0;E<i.length;E++)J=J.concat(i[E]);return J},SceneJS.Geometry.prototype.setSource=function(e){this._sourceConfigs=e;var t=this._source;t&&t.configure&&t.configure(e)},SceneJS.Geometry.prototype.getSource=function(){return this._sourceConfigs||{}},SceneJS.Geometry.prototype.setPositions=function(e){if(e.positions&&this._core.vertexBuf){this._boundary=null;var t=this._core;t.vertexBuf.bind(),t.vertexBuf.setData(new Float32Array(e.positions),e.positionsOffset||0),t.arrays.positions.set(e.positions,e.positionsOffset||0),this._engine.display.imageDirty=!0,t.interleavedBuf&&(t.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getPositions=function(){return this._core.arrays?this._core.arrays.positions:null},SceneJS.Geometry.prototype.setNormals=function(e){if(e.normals&&this._core.normalBuf){var t=this._core;t.normalBuf.bind(),t.normalBuf.setData(new Float32Array(e.normals),e.normalsOffset||0),t.arrays.normals.set(e.normals,e.normalsOffset||0),this._engine.display.imageDirty=!0,t.interleavedBuf&&(t.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getNormals=function(){return this._core.arrays?this._core.arrays.normals:null},SceneJS.Geometry.prototype.setColors=function(e){if(e.colors&&this._core.colorBuf){var t=this._core;t.colorBuf.bind(),t.colorBuf.setData(new Float32Array(e.colors),e.colorsOffset||0),t.arrays.colors.set(e.colors,e.colorsOffset||0),this._engine.display.imageDirty=!0,t.interleavedBuf&&(t.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getColors=function(){return this._core.arrays?this._core.arrays.colors:null},SceneJS.Geometry.prototype.getIndices=function(){return this._core.arrays?this._core.arrays.indices:null},SceneJS.Geometry.prototype.setUV=function(e){if(e.uv&&this._core.uvBuf){var t=this._core;t.uvBuf.bind(),t.uvBuf.setData(new Float32Array(e.uv),e.uvOffset||0),t.arrays.uv.set(e.uv,e.uvOffset||0),this._engine.display.imageDirty=!0,t.interleavedBuf&&(t.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getUV=function(){return this._core.arrays?this._core.arrays.uv:null},SceneJS.Geometry.prototype.setUV2=function(e){if(e.uv2&&this._core.uv2Buf){var t=this._core;t.uv2Buf.bind(),t.uv2Buf.setData(new Float32Array(e.uv2),e.uv2Offset||0),t.arrays.uv2.set(e.uv2,e.uv2Offset||0),this._engine.display.imageDirty=!0,t.interleavedBuf&&(t.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getUV2=function(){return this._core.arrays?this._core.arrays.uv2:null},SceneJS.Geometry.prototype.getPrimitive=function(){return this.primitive},SceneJS.Geometry.prototype.getBoundary=function(){if(this._boundary)return this._boundary;var e=this._core.arrays;if(!e)return null;var t=e.positions;if(!t)return null;this._boundary={xmin:SceneJS_math_MAX_DOUBLE,ymin:SceneJS_math_MAX_DOUBLE,zmin:SceneJS_math_MAX_DOUBLE,xmax:SceneJS_math_MIN_DOUBLE,ymax:SceneJS_math_MIN_DOUBLE,zmax:SceneJS_math_MIN_DOUBLE};for(var r,n,i,o=0,a=t.length-2;a>o;o+=3)r=t[o],n=t[o+1],i=t[o+2],r<this._boundary.xmin&&(this._boundary.xmin=r),n<this._boundary.ymin&&(this._boundary.ymin=n),i<this._boundary.zmin&&(this._boundary.zmin=i),r>this._boundary.xmax&&(this._boundary.xmax=r),n>this._boundary.ymax&&(this._boundary.ymax=n),i>this._boundary.zmax&&(this._boundary.zmax=i);return this._boundary},SceneJS.Geometry.prototype._compile=function(r){if(this._core._loading)return void this._compileNodes(r);var n=this._core;n.vertexBuf||(n=this._inheritVBOs(n)),n.indexBuf?(n.hash=[n.normalBuf?"t":"f",n.arrays&&n.arrays.tangents?"t":"f",n.uvBuf?"t":"f",n.uvBuf2?"t":"f",n.colorBuf?"t":"f",n.primitive].join(""),n.stateId=this._core.stateId,n.type="geometry",this._engine.display.geometry=e[t++]=n,SceneJS_events.fireEvent(SceneJS_events.OBJECT_COMPILING,{display:this._engine.display}),this._engine.display.buildObject(this.id)):e[t++]=this._core,this._compileNodes(r),t--},SceneJS.Geometry.prototype._inheritVBOs=function(r){for(var n={primitive:r.primitive,boundary:r.boundary,normalBuf:r.normalBuf,uvBuf:r.uvBuf,uvBuf2:r.uvBuf2,colorBuf:r.colorBuf,interleavedBuf:r.interleavedBuf,indexBuf:r.indexBuf,interleavedStride:r.interleavedStride,interleavedPositionOffset:r.interleavedPositionOffset,interleavedNormalOffset:r.interleavedNormalOffset,interleavedUVOffset:r.interleavedUVOffset,interleavedUV2Offset:r.interleavedUV2Offset,interleavedColorOffset:r.interleavedColorOffset},i=t-1;i>=0;i--)if(e[i].vertexBuf)return n.vertexBuf=e[i].vertexBuf,n.boundary=e[i].boundary,n.normalBuf=e[i].normalBuf,n.uvBuf=e[i].uvBuf,n.uvBuf2=e[i].uvBuf2,n.colorBuf=e[i].colorBuf,n.interleavedBuf=e[i].interleavedBuf,n.interleavedStride=e[i].interleavedStride,n.interleavedPositionOffset=e[i].interleavedPositionOffset,n.interleavedNormalOffset=e[i].interleavedNormalOffset,n.interleavedUVOffset=e[i].interleavedUVOffset,n.interleavedUV2Offset=e[i].interleavedUV2Offset,n.interleavedColorOffset=e[i].interleavedColorOffset,n;return n},SceneJS.Geometry.prototype._destroy=function(){this._engine.display.removeObject(this.id),1==this._core.useCount&&(this._destroyNodeCore(),this._source&&this._source.destroy&&this._source.destroy())},SceneJS.Geometry.prototype._destroyNodeCore=function(){document.getElementById(this._engine.canvas.canvasId)&&r(this._core)}},function(){var e={type:"stage",stateId:SceneJS._baseStateId++,priority:0,pickable:!0,enabled:!0},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.stage=e,r=0}),SceneJS.Stage=SceneJS_NodeFactory.createNodeType("stage"),SceneJS.Stage.prototype._init=function(e){1==this._core.useCount&&(this._core.priority=e.priority||0,this._core.enabled=e.enabled!==!1,this._core.pickable=!!e.pickable)},SceneJS.Stage.prototype.setPriority=function(e){e=e||0,this._core.priority!=e&&(this._core.priority=e,this._engine.display.stateOrderDirty=!0)},SceneJS.Stage.prototype.getPriority=function(){return this._core.priority},SceneJS.Stage.prototype.setEnabled=function(e){e=!!e,this._core.enabled!=e&&(this._core.enabled=e,this._engine.display.drawListDirty=!0)},SceneJS.Stage.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Stage.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Stage.prototype._compile=function(n){this._engine.display.stage=t[r++]=this._core,this._compileNodes(n),this._engine.display.stage=--r>0?t[r-1]:e}}(),function(){var e={type:"layer",stateId:SceneJS._baseStateId++,priority:0,enabled:!0},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.layer=e,r=0}),SceneJS.Layer=SceneJS_NodeFactory.createNodeType("layer"),SceneJS.Layer.prototype._init=function(e){1==this._core.useCount&&(this._core.priority=e.priority||0,this._core.enabled=e.enabled!==!1)},SceneJS.Layer.prototype.setPriority=function(e){e=e||0,this._core.priority!=e&&(this._core.priority=e,this._engine.display.stateOrderDirty=!0)},SceneJS.Layer.prototype.getPriority=function(){return this._core.priority},SceneJS.Layer.prototype.setEnabled=function(e){e=!!e,this._core.enabled!=e&&(this._core.enabled=e,this._engine.display.drawListDirty=!0)},SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Layer.prototype.setClearDepth=function(e){e=e||0,this._core.clearDepth!=e&&(this._core.clearDepth=e,this._engine.display.drawListDirty=!0)},SceneJS.Layer.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.Layer.prototype._compile=function(n){this._engine.display.layer=t[r++]=this._core,this._compileNodes(n),this._engine.display.layer=--r>0?t[r-1]:e}}(),SceneJS.Library=SceneJS_NodeFactory.createNodeType("library"),SceneJS.Library.prototype._compile=function(){},function(){function e(e){if(e.lights&&e.lights.length>0){for(var t,r=e.lights,n=[],i=0,o=r.length;o>i;i++)t=r[i],n.push(t.mode),t.specular&&n.push("s"),t.diffuse&&n.push("d"),n.push("world"==t.space?"w":"v");e.hash=n.join("")}else e.hash=""}var t={type:"lights",stateId:SceneJS._baseStateId++,hash:null,empty:!1,lights:[{mode:"ambient",color:[.7,.7,.8],diffuse:!0,specular:!1},{mode:"dir",color:[1,1,1],diffuse:!0,specular:!0,dir:[-.5,-.5,-1],space:"view"},{mode:"dir",color:[1,1,1],diffuse:!1,specular:!0,dir:[1,-.9,-.7],space:"view"}]};e(t);var r=[],n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.lights=t,n=0}),SceneJS.Lights=SceneJS_NodeFactory.createNodeType("lights"),SceneJS.Lights.prototype._init=function(e){if(1==this._core.useCount){var t=e.lights;if(!t)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"lights node attribute missing : 'lights'");this._core.lights=this._core.lights||[];for(var r=0,n=t.length;n>r;r++)this._initLight(r,t[r])}},SceneJS.Lights.prototype._initLight=function(e,t){var r=[];this._core.lights[e]=r;var n=t.mode||"dir";if("dir"!=n&&"point"!=n&&"ambient"!=n)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'");var i=t.pos,o=t.dir,a=t.color;r.color=[void 0!=a.r?a.r:1,void 0!=a.g?a.g:1,void 0!=a.b?a.b:1],r.mode=n,r.diffuse="ambient"==n?!0:void 0!=t.diffuse?t.diffuse:!0,r.specular="ambient"==n?!1:void 0!=t.specular?t.specular:!0,r.pos=t.pos?[i.x||0,i.y||0,i.z||0]:[0,0,0],r.dir=t.dir?[o.x||0,o.y||0,o.z||0]:[0,0,1],r.attenuation=[void 0!=t.constantAttenuation?t.constantAttenuation:0,t.linearAttenuation||0,t.quadraticAttenuation||0];var s=t.space;if(s){if("view"!=s&&"world"!=s)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+s+"' - should be 'view' or 'world'")}else s="world";r.space=s,this._core.hash=null},SceneJS.Lights.prototype.setLights=function(e){var t;for(var r in e)if(e.hasOwnProperty(r)&&(void 0!=r||null!=r)){if(t=parseInt(r),0>t||t>=this._core.lights.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'lights': index out of range ("+this._core.lights.length+" lights defined)");this._setLight(t,e[r]||{})}this._engine.branchDirty(this)},SceneJS.Lights.prototype._setLight=function(e,t){var r=this._core.lights[e],n=!1,i=!1;if(t.mode&&t.mode!=r.mode){var o=t.mode;if("dir"!=o&&"point"!=o&&"ambient"!=o)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'");r.mode=o,r.diffuse="ambient"==o?!0:void 0!=t.diffuse?t.diffuse:!0,r.specular="ambient"==o?!1:void 0!=t.specular?t.specular:!0,i=!0}if(t.color){var a=t.color;r.color=[void 0!=a.r?a.r:1,void 0!=a.g?a.g:1,void 0!=a.b?a.b:1],n=!0}var s=t.pos;s&&(r.pos=[s.x||0,s.y||0,s.z||0],n=!0);var c=t.dir;if(c&&(r.dir=[c.x||0,c.y||0,c.z||0],n=!0),void 0!=t.constantAttenuation&&(r.attenuation[0]=t.constantAttenuation,n=!0),void 0!=t.linearAttenuation&&(r.attenuation[1]=t.linearAttenuation,n=!0),void 0!=t.quadraticAttenuation&&(r.attenuation[2]=t.quadraticAttenuation,n=!0),t.space&&t.space!=r.space){var h=t.space;if("view"!=h&&"world"!=h)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+h+"' - should be 'view' or 'world'");r.space=h,this._core.hash=null,i=!0}void 0!=t.specular&&t.specular!=r.specular&&(r.specular=t.specular,i=!0),void 0!=t.diffuse&&t.diffuse!=r.diffuse&&(r.diffuse=t.diffuse,i=!0),i?this._engine.branchDirty(this):n&&(this._engine.display.imageDirty=!0),this._core.hash=null},SceneJS.Lights.prototype._compile=function(i){this._core.hash||e(this._core),this._engine.display.lights=r[n++]=this._core,this._compileNodes(i),this._engine.display.lights=--n>0?r[n-1]:t}}(),function(){var e=SceneJS_math_lookAtMat4c(0,0,10,0,0,0,0,1,0),t=new Float32Array(e),r=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t,SceneJS_math_mat4())),n=new Float32Array(r),i={type:"lookAt",stateId:SceneJS._baseStateId++,matrix:e,mat:t,normalMatrix:r,normalMat:n,lookAt:SceneJS_math_LOOKAT_ARRAYS},o=[],a=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.viewTransform=i,a=0}),SceneJS.Lookat=SceneJS_NodeFactory.createNodeType("lookAt"),SceneJS.Lookat.prototype._init=function(e){if(this._mat=null,this._xf={type:"lookat"},1==this._core.useCount){this._core.eyeX=0,this._core.eyeY=0,this._core.eyeZ=10,this._core.lookX=0,this._core.lookY=0,this._core.lookZ=0,this._core.upX=0,this._core.upY=1,this._core.upZ=0,e.eye||e.look||e.up?(this.setEye(e.eye),this.setLook(e.look),this.setUp(e.up)):(this.setEye({x:0,y:0,z:10}),this.setLook({x:0,y:0,z:0}),this.setUp({x:0,y:1,z:0}));var t=this._core,r=this;this._core.rebuild=function(){t.matrix=SceneJS_math_lookAtMat4c(t.eyeX,t.eyeY,t.eyeZ,t.lookX,t.lookY,t.lookZ,t.upX,t.upY,t.upZ),t.lookAt={eye:[t.eyeX,t.eyeY,t.eyeZ],look:[t.lookX,t.lookY,t.lookZ],up:[t.upX,t.upY,t.upZ]},t.mat?(t.mat.set(t.matrix),t.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t.matrix,SceneJS_math_mat4())))):(t.mat=new Float32Array(t.matrix),t.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t.matrix,SceneJS_math_mat4())))),r.publish("matrix",t.matrix),t.dirty=!1},this._core.dirty=!0,this._tick=this.getScene().on("tick",function(){r._core.dirty&&r._core.rebuild()})}},SceneJS.Lookat.getDefaultMatrix=function(){return t},SceneJS.Lookat.prototype.setEye=function(e){return e=e||{},void 0!=e.x&&null!=e.x&&(this._core.eyeX=e.x),void 0!=e.y&&null!=e.y&&(this._core.eyeY=e.y),void 0!=e.z&&null!=e.z&&(this._core.eyeZ=e.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEye=function(e){return e=e||{},this._core.eyeX+=void 0!=e.x&&null!=e.x?e.x:0,this._core.eyeY+=void 0!=e.y&&null!=e.y?e.y:0,this._core.eyeZ+=void 0!=e.z&&null!=e.z?e.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setEyeX=function(e){return this._core.eyeX=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this
},SceneJS.Lookat.prototype.setEyeY=function(e){return this._core.eyeY=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setEyeZ=function(e){return this._core.eyeZ=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeX=function(e){return this._core.eyeX+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeY=function(e){return this._core.eyeY+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeZ=function(e){return this._core.eyeZ+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getEye=function(){return{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ}},SceneJS.Lookat.prototype.setLook=function(e){return e=e||{},void 0!=e.x&&null!=e.x&&(this._core.lookX=e.x),void 0!=e.y&&null!=e.y&&(this._core.lookY=e.y),void 0!=e.z&&null!=e.z&&(this._core.lookZ=e.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLook=function(e){return e=e||{},this._core.lookX+=void 0!=e.x&&null!=e.x?e.x:0,this._core.lookY+=void 0!=e.y&&null!=e.y?e.y:0,this._core.lookZ+=void 0!=e.z&&null!=e.z?e.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookX=function(e){return this._core.lookX=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookY=function(e){return this._core.lookY=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookZ=function(e){return this._core.lookZ=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookX=function(e){return this._core.lookX+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookY=function(e){return this._core.lookY+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookZ=function(e){return this._core.lookZ+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getLook=function(){return{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ}},SceneJS.Lookat.prototype.setUp=function(e){return e=e||{},void 0!=e.x&&null!=e.x&&(this._core.upX=e.x),void 0!=e.y&&null!=e.y&&(this._core.upY=e.y),void 0!=e.z&&null!=e.z&&(this._core.upZ=e.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUp=function(e){return e=e||{},this._core.upX+=void 0!=e.x&&null!=e.x?e.x:0,this._core.upY+=void 0!=e.y&&null!=e.y?e.y:0,this._core.upZ+=void 0!=e.z&&null!=e.z?e.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpX=function(e){return this._core.upX=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpY=function(e){return this._core.upY=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpZ=function(e){return this._core.upZ=e||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpX=function(e){return this._core.upX+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpY=function(e){return this._core.upY+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpZ=function(e){return this._core.upZ+=e,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getUp=function(){return{x:this._core.upX,y:this._core.upY,z:this._core.upZ}},SceneJS.Lookat.prototype.getMatrix=function(){return this._core.dirty&&this._core.rebuild(),this._core.matrix.slice(0)},SceneJS.Lookat.prototype.getAttributes=function(){return{look:{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ},eye:{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ},up:{x:this._core.upX,y:this._core.upY,z:this._core.upZ}}},SceneJS.Lookat.prototype._compile=function(e){this._engine.display.viewTransform=o[a++]=this._core,this._compileNodes(e),this._engine.display.viewTransform=--a>0?o[a-1]:i},SceneJS.Lookat.prototype._destroy=function(){this.getScene().off(this._tick)}}(),new function(){var e={type:"material",stateId:SceneJS._baseStateId++,baseColor:[1,1,1],specularColor:[1,1,1],specular:1,shine:70,alpha:1,emit:0},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.material=e,r=0}),SceneJS.Material=SceneJS_NodeFactory.createNodeType("material"),SceneJS.Material.prototype._init=function(e){1==this._core.useCount&&(this.setBaseColor(e.color||e.baseColor),this.setSpecularColor(e.specularColor),this.setSpecular(e.specular),this.setShine(e.shine),this.setEmit(e.emit),this.setAlpha(e.alpha))},SceneJS.Material.prototype.setBaseColor=function(t){var r=e.baseColor;return this._core.baseColor=t?[void 0!=t.r&&null!=t.r?t.r:r[0],void 0!=t.g&&null!=t.g?t.g:r[1],void 0!=t.b&&null!=t.b?t.b:r[2]]:e.baseColor,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.setColor=SceneJS.Material.prototype.setBaseColor,SceneJS.Material.prototype.getBaseColor=function(){return{r:this._core.baseColor[0],g:this._core.baseColor[1],b:this._core.baseColor[2]}},SceneJS.Material.prototype.getColor=SceneJS.Material.prototype.getBaseColor,SceneJS.Material.prototype.setSpecularColor=function(t){var r=e.specularColor;return this._core.specularColor=t?[void 0!=t.r&&null!=t.r?t.r:r[0],void 0!=t.g&&null!=t.g?t.g:r[1],void 0!=t.b&&null!=t.b?t.b:r[2]]:e.specularColor,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getSpecularColor=function(){return{r:this._core.specularColor[0],g:this._core.specularColor[1],b:this._core.specularColor[2]}},SceneJS.Material.prototype.setSpecular=function(t){return this._core.specular=void 0!=t&&null!=t?t:e.specular,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getSpecular=function(){return this._core.specular},SceneJS.Material.prototype.setShine=function(t){return this._core.shine=void 0!=t&&null!=t?t:e.shine,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getShine=function(){return this._core.shine},SceneJS.Material.prototype.setEmit=function(t){return this._core.emit=void 0!=t&&null!=t?t:e.emit,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getEmit=function(){return this._core.emit},SceneJS.Material.prototype.setAlpha=function(t){return this._core.alpha=void 0!=t&&null!=t?t:e.alpha,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getAlpha=function(){return this._core.alpha},SceneJS.Material.prototype._compile=function(n){this._engine.display.material=t[r++]=this._core,this._compileNodes(n),this._engine.display.material=--r>0?t[r-1]:e}},new function(){var e={type:"morphGeometry",stateId:SceneJS._baseStateId++,hash:"",morph:null},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.morphGeometry=e,r=0}),SceneJS.MorphGeometry=SceneJS_NodeFactory.createNodeType("morphGeometry"),SceneJS.MorphGeometry.prototype._init=function(e){if(1==this._core.useCount){if(this._sourceConfigs=e.source,this._source=null,e.source){if(!e.source.type)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry config expected: source.type");var t=this;SceneJS.Plugins.getPlugin("morphGeometry",this._sourceConfigs.type,function(r){if(!r)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: no support for source type '"+t._sourceConfigs.type+"' - need to include plugin for self source type, or install a custom source service with SceneJS.Plugins.addPlugin(SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN, '"+t._sourceConfigs.type+"', <your service>).");if(!r.getSource)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'getSource' method not found on MorphGeoFactoryService (SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN)");if(t._source=r.getSource(),!t._source.subscribe)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'subscribe' method not found on source provided by plugin type '"+e.source.type+"'");var n=!1;t._source.subscribe(function(e){if(n){if(e.targets)for(var r,i,o,a=e.targets,s=t._core.targets,c=0,h=a.length;h>c;c++)r=a[c],i=r.targetIndex,o=s[i],r.positions&&o.vertexBuf&&(o.vertexBuf.bind(),o.vertexBuf.setData(r.positions,0));t._display.imageDirty=!0}else t._buildNodeCore(e),t._core._loading=!1,t._fireEvent("loaded"),t._engine.branchDirty(t),n=!0}),t._core._loading=!0,t._fireEvent("loading"),t._source.configure(t._sourceConfigs)})}else this._buildNodeCore(e.create instanceof Function?e.create():e);this._core.webglRestored=function(){},this.setFactor(e.factor)}this._core.factor=e.factor||0,this._core.clamp=!!e.clamp},SceneJS.MorphGeometry.prototype._buildNodeCore=function(e){var t=e.targets||[];if(t.length<2)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node should have at least two targets");var r=e.keys||[];if(r.length!=t.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node mismatch in number of keys and targets");var n=this._core,i=this._engine.canvas.gl,o=i.STATIC_DRAW;n.keys=r,n.targets=[],n.key1=0,n.key2=1;for(var a,s,c,h,u,l=0,S=t.length;S>l;l++)u=t[l],!a&&u.positions&&(a=u.positions),!s&&u.normals&&(s=u.normals),!c&&u.uv&&(c=u.uv),!h&&u.uv2&&(h=u.uv2);try{for(var p,_,l=0,S=t.length;S>l;l++)u=t[l],p={},_=u.positions||a,_&&(p.positions="Float32Array"==typeof _?_:new Float32Array(_),p.vertexBuf=new SceneJS._webgl.ArrayBuffer(i,i.ARRAY_BUFFER,p.positions,_.length,3,o),a=_),_=u.normals||s,_&&(p.normals="Float32Array"==typeof _?_:new Float32Array(_),p.normalBuf=new SceneJS._webgl.ArrayBuffer(i,i.ARRAY_BUFFER,p.normals,_.length,3,o),s=_),_=u.uv||c,_&&(p.uv="Float32Array"==typeof _?_:new Float32Array(_),p.uvBuf=new SceneJS._webgl.ArrayBuffer(i,i.ARRAY_BUFFER,p.uv,_.length,2,o),c=_),_=u.uv2||h,_&&(p.uv2="Float32Array"==typeof _?_:new Float32Array(_),p.uvBuf2=new SceneJS._webgl.ArrayBuffer(i,i.ARRAY_BUFFER,p.uv2,_.length,2,o),h=_),n.targets.push(p)}catch(d){for(var l=0,S=n.targets.length;S>l;l++)p=n.targets[l],p.vertexBuf&&p.vertexBuf.destroy(),p.normalBuf&&p.normalBuf.destroy(),p.uvBuf&&p.uvBuf.destroy(),p.uvBuf2&&p.uvBuf2.destroy();throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate VBO(s) for morphGeometry: "+d)}},SceneJS.MorphGeometry.prototype.setSource=function(e){this._sourceConfigs=e;var t=this._source;t&&t.configure(e)},SceneJS.MorphGeometry.prototype.getSource=function(){return this._sourceConfigs},SceneJS.MorphGeometry.prototype.setFactor=function(e){e=e||0;var t=this._core,r=t.keys,n=t.key1,i=t.key2;if(e<r[0])n=0,i=1;else if(e>r[r.length-1])n=r.length-2,i=n+1;else{for(;r[n]>e;)n--,i--;for(;r[i]<e;)n++,i++}t.factor=(e-r[n])/(r[i]-r[n]),t.key1=n,t.key2=i,this._engine.display.imageDirty=!0},SceneJS.MorphGeometry.prototype.getFactor=function(){return this._core.factor},SceneJS.MorphGeometry.prototype.getKeys=function(){return this._core.keys},SceneJS.MorphGeometry.prototype.getTargets=function(){return this._core.targets},SceneJS.MorphGeometry.prototype._compile=function(n){this._core.hash||this._makeHash(),this._engine.display.morphGeometry=t[r++]=this._core,this._compileNodes(n),this._engine.display.morphGeometry=--r>0?t[r-1]:e},SceneJS.MorphGeometry.prototype._makeHash=function(){var e=this._core;if(e.targets.length>0){var t=e.targets[0],r="t",n="f";e.hash=[t.vertexBuf?r:n,t.normalBuf?r:n,t.uvBuf?r:n,t.uvBuf2?r:n].join("")}else e.hash=""},SceneJS.MorphGeometry.prototype._destroy=function(){if(1==this._core.useCount){if(document.getElementById(this._engine.canvas.canvasId))for(var e,t=this._core,r=0,n=t.targets.length;n>r;r++)e=t.targets[r],e.vertexBuf&&e.vertexBuf.destroy(),e.normalBuf&&e.normalBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.uvBuf2&&e.uvBuf2.destroy();this._source&&this._source.destroy&&this._source.destroy()}}},function(){var e={type:"name",stateId:SceneJS._baseStateId++,name:null},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.name=e,r=0}),SceneJS.Name=SceneJS_NodeFactory.createNodeType("name"),SceneJS.Name.prototype._init=function(e){this.setName(e.name),this._core.nodeId=this.id},SceneJS.Name.prototype.setName=function(e){this._core.name=e||"unnamed",this._engine.branchDirty(this)},SceneJS.Name.prototype.getName=function(){return this._core.name},SceneJS.Name.prototype._compile=function(n){this._engine.display.name=t[r++]=this._core;for(var i,o=[],a=0;r>a;a++)i=t[a].name,i&&o.push(i);this._core.path=o.join("."),this._compileNodes(n),this._engine.display.name=--r>0?t[r-1]:e}}(),new function(){function e(e){var r;if(o>0){r={};for(var n in e)e.hasOwnProperty(n)&&void 0!=e[n]&&(r[n]=a(n))}return t(e.props),{props:e,setProps:function(t){s(t,e)},restoreProps:function(e){r&&c(e,r)}}}function t(e){var t;for(var r in e)e.hasOwnProperty(r)&&(t=e[r],void 0!=t&&null!=t&&(u[r]?e[r]=u[r](null,t):l[r]&&(e[r]=l[r](null,t))))}var r,n={type:"renderer",stateId:SceneJS._baseStateId++,props:null},i=[],o=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){r=e.engine.canvas,o=0,e.engine.display.renderer=i[o++]=n});var a=function(e){for(var t,r,n=o-1;n>=0;n--)if(t=i[n].props,t&&(r=t[e],void 0!=r&&null!=r))return t[e];return null},s=function(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=u[r];n&&n(e,t[r])}t.viewport&&l.viewport(e,t.viewport),t.scissor&&l.clear(e,t.scissor),t.clear&&l.clear(e,t.clear)},c=function(e,t){var r;for(var n in t)if(t.hasOwnProperty(n)&&(r=t[n],void 0!=r&&null!=r)){var i=u[n];i&&i(e,r)}t.viewport&&l.viewport(e,t.viewport),t.scissor&&l.clear(e,t.scissor)},h=function(e,t){if(!t)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Null SceneJS.State node config: "'+t+'"');var r=SceneJS._webgl.enumMap[t];if(!r)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Unrecognised SceneJS.State node config value: "'+t+'"');var n=e[r];if(!n)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"This browser's WebGL does not support renderer node config value: \""+t+'"');return n},u={enableBlend:function(e,t){return e?void(t?e.enable(e.BLEND):e.disable(e.BLEND)):((null==t||void 0==t)&&(t=!1),t)},blendColor:function(e,t){return e?void e.blendColor(t.r,t.g,t.b,t.a):(t=t||{},{r:t.r||0,g:t.g||0,b:t.b||0,a:void 0==t.a||null==t.a?1:t.a})},blendEquation:function(e,t){return e?void e.blendEquation(e,h(e,t)):t||"funcAdd"},blendEquationSeparate:function(e,t){return e?void e.blendEquation(h(e,t.rgb),h(e,t.alpha)):(t=t||{},{rgb:t.rgb||"funcAdd",alpha:t.alpha||"funcAdd"})},blendFunc:function(e,t){return e?void e.blendFunc(h(e,t.sfactor||"srcAlpha"),h(e,t.dfactor||"oneMinusSrcAlpha")):(t=t||{},{sfactor:t.sfactor||"srcAlpha",dfactor:t.dfactor||"oneMinusSrcAlpha"})},blendFuncSeparate:function(e,t){return e?void e.blendFuncSeparate(h(e,t.srcRGB||"zero"),h(e,t.dstRGB||"zero"),h(e,t.srcAlpha||"zero"),h(e,t.dstAlpha||"zero")):(t=t||{},{srcRGB:t.srcRGB||"zero",dstRGB:t.dstRGB||"zero",srcAlpha:t.srcAlpha||"zero",dstAlpha:t.dstAlpha||"zero"})},clearColor:function(e,t){return e?void e.clearColor(t.r,t.g,t.b,t.a):(t=t||{},{r:t.r||0,g:t.g||0,b:t.b||0,a:void 0==t.a||null==t.a?1:t.a})},clearDepth:function(e,t){return e?void e.clearDepth(t):null==t||void 0==t?1:t},clearStencil:function(e,t){return e?void e.clearStencil(t):t||0},colorMask:function(e,t){return e?void e.colorMask(t.r,t.g,t.b,t.a):(t=t||{},{r:t.r||0,g:t.g||0,b:t.b||0,a:void 0==t.a||null==t.a?1:t.a})},enableCullFace:function(e,t){return e?void(t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE)):t},cullFace:function(e,t){return e?void e.cullFace(h(e,t)):t||"back"},enableDepthTest:function(e,t){return e?void(t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST)):((null==t||void 0==t)&&(t=!0),t)},depthFunc:function(e,t){return e?void e.depthFunc(h(e,t)):t||"less"},enableDepthMask:function(e,t){return e?void e.depthMask(t):((null==t||void 0==t)&&(t=!0),t)},depthRange:function(e,t){return e?void e.depthRange(t.zNear,t.zFar):(t=t||{},{zNear:void 0==t.zNear||null==t.zNear?0:t.zNear,zFar:void 0==t.zFar||null==t.zFar?1:t.zFar})},frontFace:function(e,t){return e?void e.frontFace(h(e,t)):t||"ccw"},lineWidth:function(e,t){return e?void e.lineWidth(t):t||1},enableScissorTest:function(e,t){return e?void(t?e.enable(e.SCISSOR_TEST):(t=!1,e.disable(e.SCISSOR_TEST))):t}},l={viewport:function(e,t){return e?void e.viewport(t.x,t.y,t.width,t.height):(t=t||{},{x:t.x||1,y:t.y||1,width:t.width||r.canvas.width,height:t.height||r.canvas.height})},scissor:function(e,t){return e?void e.scissor(t.x,t.y,t.width,t.height):(t=t||{},{x:t.x||0,y:t.y||0,width:t.width||1,height:t.height||1})},clear:function(e,t){if(!e)return t=t||{};var r;t.color&&(r=e.COLOR_BUFFER_BIT),t.depth&&(r|=e.DEPTH_BUFFER_BIT),t.stencil&&(r|=e.STENCIL_BUFFER_BIT)}};SceneJS.Renderer=SceneJS_NodeFactory.createNodeType("renderer"),SceneJS.Renderer.prototype._init=function(e){if(1==this._core.useCount){for(var t in e)e.hasOwnProperty(t)&&(this._core[t]=e[t]);this._core.dirty=!0}},SceneJS.Renderer.prototype.setViewport=function(e){this._core.viewport=e?{x:e.x||1,y:e.y||1,width:e.width||1e3,height:e.height||1e3}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getViewport=function(){return this._core.viewport?{x:this._core.viewport.x,y:this._core.viewport.y,width:this._core.viewport.width,height:this._core.viewport.height}:void 0},SceneJS.Renderer.prototype.setScissor=function(e){this._core.scissor=e?{x:e.x||1,y:e.y||1,width:e.width||1e3,height:e.height||1e3}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getScissor=function(){return this._core.scissor?{x:this._core.scissor.x,y:this._core.scissor.y,width:this._core.scissor.width,height:this._core.scissor.height}:void 0},SceneJS.Renderer.prototype.setClear=function(e){this._core.clear=e?{r:e.r||0,g:e.g||0,b:e.b||0}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getClear=function(){return this._core.clear?{r:this._core.clear.r,g:this._core.clear.g,b:this._core.clear.b}:null},SceneJS.Renderer.prototype.setEnableBlend=function(e){this._core.enableBlend=e,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getEnableBlend=function(){return this._core.enableBlend},SceneJS.Renderer.prototype.setBlendColor=function(e){this._core.blendColor=e?{r:e.r||0,g:e.g||0,b:e.b||0,a:void 0==e.a||null==e.a?1:e.a}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendColor=function(){return this._core.blendColor?{r:this._core.blendColor.r,g:this._core.blendColor.g,b:this._core.blendColor.b,a:this._core.blendColor.a}:void 0},SceneJS.Renderer.prototype.setBlendEquation=function(e){this._core.blendEquation=e,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendEquation=function(){return this._core.blendEquation},SceneJS.Renderer.prototype.setBlendEquationSeparate=function(e){this._core.blendEquationSeparate=e?{rgb:e.rgb||"funcAdd",alpha:e.alpha||"funcAdd"}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendEquationSeparate=function(){return this._core.blendEquationSeparate?{rgb:this._core.rgb,alpha:this._core.alpha}:void 0},SceneJS.Renderer.prototype.setBlendFunc=function(e){this._core.blendFunc=e?{sfactor:e.sfactor||"srcAlpha",dfactor:e.dfactor||"one"}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendFunc=function(){return this._core.blendFunc?{sfactor:this._core.sfactor,dfactor:this._core.dfactor}:void 0},SceneJS.Renderer.prototype.setBlendFuncSeparate=function(e){this._core.blendFuncSeparate=e?{srcRGB:e.srcRGB||"zero",dstRGB:e.dstRGB||"zero",srcAlpha:e.srcAlpha||"zero",dstAlpha:e.dstAlpha||"zero"}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getBlendFuncSeparate=function(){return this._core.blendFuncSeparate?{srcRGB:this._core.blendFuncSeparate.srcRGB,dstRGB:this._core.blendFuncSeparate.dstRGB,srcAlpha:this._core.blendFuncSeparate.srcAlpha,dstAlpha:this._core.blendFuncSeparate.dstAlpha}:void 0},SceneJS.Renderer.prototype.setEnableCullFace=function(e){this._core.enableCullFace=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableCullFace=function(){return this._core.enableCullFace},SceneJS.Renderer.prototype.setCullFace=function(e){this._core.cullFace=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getCullFace=function(){return this._core.cullFace},SceneJS.Renderer.prototype.setEnableDepthTest=function(e){this._core.enableDepthTest=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableDepthTest=function(){return this._core.enableDepthTest},SceneJS.Renderer.prototype.setDepthFunc=function(e){this._core.depthFunc=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getDepthFunc=function(){return this._core.depthFunc},SceneJS.Renderer.prototype.setEnableDepthMask=function(e){this._core.enableDepthMask=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableDepthMask=function(){return this._core.enableDepthMask},SceneJS.Renderer.prototype.setClearDepth=function(e){this._core.clearDepth=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.Renderer.prototype.setDepthRange=function(e){this._core.depthRange=e?{zNear:void 0==e.zNear||null==e.zNear?0:e.zNear,zFar:void 0==e.zFar||null==e.zFar?1:e.zFar}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getDepthRange=function(){return this._core.depthRange?{zNear:this._core.depthRange.zNear,zFar:this._core.depthRange.zFar}:void 0},SceneJS.Renderer.prototype.setFrontFace=function(e){this._core.frontFace=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getFrontFace=function(){return this._core.frontFace},SceneJS.Renderer.prototype.setLineWidth=function(e){this._core.lineWidth=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getLineWidth=function(){return this._core.lineWidth},SceneJS.Renderer.prototype.setEnableScissorTest=function(e){this._core.enableScissorTest=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableScissorTest=function(){return this._core.enableScissorTest},SceneJS.Renderer.prototype.setClearStencil=function(e){this._core.clearStencil=e,this._core.dirty=!0},SceneJS.Renderer.prototype.getClearStencil=function(){return this._core.clearStencil},SceneJS.Renderer.prototype.setColorMask=function(e){this._core.colorMask=e?{r:e.r||0,g:e.g||0,b:e.b||0,a:void 0==e.a||null==e.a?1:e.a}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getColorMask=function(){return this._core.colorMask?{r:this._core.colorMask.r,g:this._core.colorMask.g,b:this._core.colorMask.b,a:this._core.colorMask.a}:void 0},SceneJS.Renderer.prototype._compile=function(t){this._core.dirty&&(this._core.props=e(this._core),this._core.dirty=!1),this._engine.display.renderer=i[o++]=this._core,this._compileNodes(t),this._engine.display.renderer=--o>0?i[o-1]:n}},function(){var e={less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},t={type:"depthBuffer",stateId:SceneJS._baseStateId++,enabled:!0,clearDepth:1,depthFunc:null,_depthFuncName:"less"},r=[],n=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){null===t.depthFunc&&(t.depthFunc=e.engine.canvas.gl.LESS),e.engine.display.depthBuffer=t,n=0}),SceneJS.DepthBuf=SceneJS_NodeFactory.createNodeType("depthBuffer"),SceneJS.DepthBuf.prototype._init=function(e){void 0!=e.enabled?this.setEnabled(e.enabled):1==this._core.useCount&&this.setEnabled(!0),void 0!=e.clearDepth?this.setClearDepth(e.clearDepth):1==this._core.useCount&&this.setClearDepth(1),void 0!=e.depthFunc?this.setDepthFunc(e.depthFunc):1==this._core.useCount&&this.setDepthFunc("less"),void 0!=e.clear?this.setClear(e.clear):1==this._core.useCount&&this.setClear(!0)},SceneJS.DepthBuf.prototype.setEnabled=function(e){return this._core.enabled!=e&&(this._core.enabled=e,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getEnabled=function(){return this._core.enabled},SceneJS.DepthBuf.prototype.setClear=function(e){return this._core.clear!=e&&(this._core.clear=e,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getClear=function(){return this._core.clear},SceneJS.DepthBuf.prototype.setClearDepth=function(e){return this._core.clearDepth!=e&&(this._core.clearDepth=e,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.DepthBuf.prototype.setDepthFunc=function(t){if(this._core._depthFuncName!=t){var r=e[t];if(void 0==r)throw"unsupported value for 'clearFunc' attribute on depthBuffer node: '"+t+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal'";this._core.depthFunc=this._engine.canvas.gl[r],this._core._depthFuncName=t,this._engine.display.imageDirty=!0}return this},SceneJS.DepthBuf.prototype.getDepthFunc=function(){return this._core._depthFuncName},SceneJS.DepthBuf.prototype._compile=function(e){this._engine.display.depthBuffer=r[n++]=this._core,this._compileNodes(e),this._engine.display.depthBuffer=--n>0?r[n-1]:t}}(),function(){var e={type:"colorBuffer",stateId:SceneJS._baseStateId++,blendEnabled:!1,colorMask:{r:!0,g:!0,b:!0,a:!0}},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.colorBuffer=e,r=0}),SceneJS.ColorBuffer=SceneJS_NodeFactory.createNodeType("colorBuffer"),SceneJS.ColorBuffer.prototype._init=function(e){void 0!=e.blendEnabled?this.setBlendEnabled(e.blendEnabled):1==this._core.useCount&&this.setBlendEnabled(!1),this.setColorMask(e)},SceneJS.ColorBuffer.prototype.setBlendEnabled=function(e){this._core.blendEnabled!=e&&(this._core.blendEnabled=e,this._engine.display.imageDirty=!0),this._engine.display.imageDirty=!0},SceneJS.ColorBuffer.prototype.getBlendEnabled=function(){return this._core.blendEnabled},SceneJS.ColorBuffer.prototype.setColorMask=function(e){this._core.colorMask={r:void 0!=e.r&&null!=e.r?e.r:!0,g:void 0!=e.g&&null!=e.g?e.g:!0,b:void 0!=e.b&&null!=e.b?e.b:!0,a:void 0!=e.a&&null!=e.a?e.a:!0},this._engine.display.imageDirty=!0},SceneJS.ColorBuffer.prototype.getColorMask=function(){return this._core.colorMask},SceneJS.ColorBuffer.prototype._compile=function(n){this._engine.display.colorBuffer=t[r++]=this._core,this._compileNodes(n),this._engine.display.colorBuffer=--r>0?t[r-1]:e,this._engine.display.imageDirty=!0}}(),function(){var e={type:"view",stateId:SceneJS._baseStateId++,scissorTestEnabled:!1},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.view=e,r=0}),SceneJS.View=SceneJS_NodeFactory.createNodeType("view"),SceneJS.View.prototype._init=function(e){void 0!=e.scissorTestEnabled?this.setScissorTestEnabled(e.scissorTestEnabled):1==this._core.useCount&&this.setScissorTestEnabled(!1)},SceneJS.View.prototype.setScissorTestEnabled=function(e){return this._core.scissorTestEnabled!=e&&(this._core.scissorTestEnabled=e,this._engine.display.imageDirty=!0),this},SceneJS.View.prototype.getScissorTestEnabled=function(){return this._core.scissorTestEnabled},SceneJS.View.prototype._compile=function(n){this._engine.display.view=t[r++]=this._core,this._compileNodes(n),this._engine.display.view=--r>0?t[r-1]:e}}(),SceneJS.Scene=SceneJS_NodeFactory.createNodeType("scene"),SceneJS.Scene.prototype._init=function(e){e.tagMask&&this.setTagMask(e.tagMask),this._tagSelector=null,this.transparent=e.transparent===!0},SceneJS.Scene.prototype.loseWebGLContext=function(){this._engine.loseWebGLContext()},SceneJS.Scene.prototype.getCanvas=function(){return this._engine.canvas.canvas},SceneJS.Scene.prototype.getGL=function(){return this._engine.canvas.gl},SceneJS.Scene.prototype.getZBufferDepth=function(){var e=this._engine.canvas.gl;return e.getParameter(e.DEPTH_BITS)},SceneJS.Scene.prototype.setTagMask=function(e){e=e||"XXXXXXXXXXXXXXXXXXXXXXXXXX",this._tagSelector||(this._tagSelector={}),this._tagSelector.mask=e,this._tagSelector.regex=e?new RegExp(e):null,this._engine.display.selectTags(this._tagSelector)},SceneJS.Scene.prototype.getTagMask=function(){return this._tagSelector?this._tagSelector.mask:null},SceneJS.Scene.prototype.setNumPasses=function(e){this._engine.setNumPasses(e)},SceneJS.Scene.prototype.renderFrame=function(e){return this._engine.renderFrame(e)},SceneJS.Scene.prototype.needFrame=function(){this._engine.display.imageDirty=!0},SceneJS.Scene.prototype.start=function(e){this._engine.start(e)},SceneJS.Scene.prototype.pause=function(e){this._engine.pause(e)},SceneJS.Scene.prototype.isRunning=function(){return this._engine.running},SceneJS.Scene.prototype.pick=function(e,t,r){var n=this._engine.pick(e,t,r);return this.renderFrame({force:!0}),n?(this.publish("pick",n),n):void this.publish("nopick")},SceneJS.Scene.prototype.readPixels=function(e,t){return this._engine.readPixels(e,t)},SceneJS.Scene.prototype._destroy=function(){this.destroyed||(delete SceneJS._engines[this.id],SceneJS._engineIds.removeItem(this.id),this.destroyed=!0)},SceneJS.Scene.prototype.isActive=function(){return!this._engine.destroyed},SceneJS.Scene.prototype.stop=function(){this._engine.stop()},SceneJS.Scene.prototype.containsNode=function(e){return!!this._engine.findNode(e)},SceneJS.Scene.prototype.findNodes=function(e){return this._engine.findNodes(e)},SceneJS.Scene.prototype.findNode=function(e,t){return this.getNode(e,t)},SceneJS.Scene.prototype.getNode=function(e,t){var r=this._engine.findNode(e);return r?(t&&t(r),r):t?void this.once("nodes/"+e,t):null},SceneJS.Scene.prototype.hasCore=function(e,t){return this._engine.hasCore(e,t)},SceneJS.Scene.prototype.getStatus=function(){var e=SceneJS_sceneStatusModule.sceneStatus[this.id];return e?SceneJS._shallowClone(e):{destroyed:!0}},new function(){function e(e){for(var t,r,n={},i=0;c>i;i++){t=e[i];for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r])}return n}var t={type:"shader",stateId:SceneJS._baseStateId++,hash:"",empty:!0,shader:{}},r=[],n=[],i=[],o=[],a=[],s=[],c=0,h=!0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.shader=t,c=0,h=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(u){if(h){if(c>0){var l={type:"shader",stateId:r[c-1],hash:r.slice(0,c).join("."),shaders:{fragment:{code:o.slice(0,c).join(""),hooks:e(a)},vertex:{code:n.slice(0,c).join(""),hooks:e(i)}},paramsStack:s.slice(0,c)};u.display.shader=l}else u.display.shader=t;h=!1}}),SceneJS.Shader=SceneJS_NodeFactory.createNodeType("shader"),SceneJS.Shader.prototype._init=function(e){1==this._core.useCount&&(this._setShaders(e.shaders),this.setParams(e.params))},SceneJS.Shader.prototype._setShaders=function(e){e=e||[],this._core.shaders={};for(var t,r=0,n=e.length;n>r;r++){if(t=e[r],!t.stage)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"shader 'stage' attribute expected");var i;t.code&&(i=SceneJS._isArray(t.code)?t.code.join(""):t.code),this._core.shaders[t.stage]={code:i,hooks:t.hooks}}},SceneJS.Shader.prototype.setParams=function(e){e=e||{};var t=this._core.params;t||(t=this._core.params={});for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);this._engine.display.imageDirty=!0},SceneJS.Shader.prototype.getParams=function(){var e=this._core.params;if(!e)return{};var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},SceneJS.Shader.prototype._compile=function(e){r[c]=this._core.coreId;var t=this._core.shaders,u=t.fragment||{},l=t.vertex||{};o[c]=u.code||"",a[c]=u.hooks||{},n[c]=l.code||"",i[c]=l.hooks||{},s[c]=this._core.params||{},c++,h=!0,this._compileNodes(e),c--,h=!0}},new function(){var e,t={type:"shaderParams",stateId:SceneJS._baseStateId++,empty:!0},r=[],n=[],i=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(r){r.engine.display.shaderParams=t,i=0,e=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(o){if(e){if(i>0){var a={type:"shaderParams",stateId:r[i-1],paramsStack:n.slice(0,i)};
    o.display.shaderParams=a}else o.display.shaderParams=t;e=!1}}),SceneJS.ShaderParams=SceneJS_NodeFactory.createNodeType("shaderParams"),SceneJS.ShaderParams.prototype._init=function(e){1==this._core.useCount&&this.setParams(e.params)},SceneJS.ShaderParams.prototype.setParams=function(e){e=e||{};var t=this._core;t.params||(t.params={});for(var r in e)e.hasOwnProperty(r)&&(t.params[r]=e[r]);this._engine.display.imageDirty=!0},SceneJS.ShaderParams.prototype.getParams=function(){var e=this._core.params;if(!e)return{};var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},SceneJS.ShaderParams.prototype._compile=function(t){r[i]=this._core.coreId,n[i]=this._core.params,i++,e=!0,this._compileNodes(t),i--,e=!0}},function(){var e={type:"style",stateId:SceneJS._baseStateId++,lineWidth:1},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.style=e,r=0}),SceneJS.Style=SceneJS_NodeFactory.createNodeType("style"),SceneJS.Style.prototype._init=function(e){void 0!=e.lineWidth&&this.setLineWidth(e.lineWidth)},SceneJS.Style.prototype.setLineWidth=function(e){return this._core.lineWidth!=e&&(this._core.lineWidth=e,this._engine.display.imageDirty=!0),this},SceneJS.Style.prototype.getLineWidth=function(){return this._core.lineWidth},SceneJS.Style.prototype._compile=function(n){this._engine.display.style=t[r++]=this._core,this._compileNodes(n),this._engine.display.style=--r>0?t[r-1]:e}}(),function(){var e={type:"tag",stateId:SceneJS._baseStateId++,tag:null},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.tag=e,r=0}),SceneJS.Tag=SceneJS_NodeFactory.createNodeType("tag"),SceneJS.Tag.prototype._init=function(e){if(1==this._core.useCount){if(!e.tag)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"tag node attribute missing : 'tag'");this.setTag(e.tag)}},SceneJS.Tag.prototype.setTag=function(e){var t=this._core;t.tag=e,t.pattern=null,t.matched=!1,this._engine.display.drawListDirty=!0},SceneJS.Tag.prototype.getTag=function(){return this._core.tag},SceneJS.Tag.prototype._compile=function(n){this._engine.display.tag=t[r++]=this._core,this._compileNodes(n),this._engine.display.tag=--r>0?t[r-1]:e}}(),new function(){var e={type:"texture",stateId:SceneJS._baseStateId++,empty:!0,hash:""},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.texture=e,r=0}),SceneJS.Texture=SceneJS_NodeFactory.createNodeType("_texture"),SceneJS.Texture.prototype._init=function(e){if(1==this._core.useCount){this._core.layers=[],this._core.params={};var t=void 0==e.waitForLoad?!0:e.waitForLoad;if(!e.layers)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers missing");if(!SceneJS._isArray(e.layers))throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers should be an array");for(var r,n=this._engine.canvas.gl,i=0;i<e.layers.length;i++){if(r=e.layers[i],!(r.source||r.uri||r.src||r.colorTarget||r.video))throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  has no uri, src, source, colorTarget, video or canvasId specified");if(r.applyFrom&&"uv"!=r.applyFrom&&"uv2"!=r.applyFrom&&"normal"!=r.applyFrom&&"geometry"!=r.applyFrom)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  applyFrom value is unsupported - should be either 'uv', 'uv2', 'normal' or 'geometry'");if(r.applyTo&&"baseColor"!=r.applyTo&&"color"!=r.applyTo&&"specular"!=r.applyTo&&"emit"!=r.applyTo&&"alpha"!=r.applyTo&&"normals"!=r.applyTo&&"shine"!=r.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" applyTo value is unsupported - should be either 'color', 'baseColor', 'specular' or 'normals'");if(r.blendMode&&"add"!=r.blendMode&&"multiply"!=r.blendMode&&"mix"!=r.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" blendMode value is unsupported - should be either 'add', 'multiply' or 'mix'");"color"==r.applyTo&&(r.applyTo="baseColor");var o=SceneJS._apply(r,{waitForLoad:t,texture:null,applyFrom:r.applyFrom||"uv",applyTo:r.applyTo||"baseColor",blendMode:r.blendMode||"multiply",blendFactor:void 0!=r.blendFactor&&null!=r.blendFactor?r.blendFactor:1,translate:{x:0,y:0},scale:{x:1,y:1},rotate:{z:0}});if(this._core.layers.push(o),this._setLayerTransform(r,o),o.colorTarget){var a=this._engine.findNode(o.colorTarget);a&&"colorTarget"==a.type&&(o.texture=a._core.colorTarget.getTexture())}else this._loadLayerTexture(n,o)}var s=this;this._core.webglRestored=function(){for(var e=s._core.layers,t=s._engine.canvas.gl,r=0,n=e.length;n>r;r++)s._loadLayerTexture(t,e[r])}}},SceneJS.Texture.prototype._loadLayerTexture=function(e,t){var r=this,n=t.source;if(n){if(!n.type)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"texture layer config expected: source.type");SceneJS.Plugins.getPlugin("texture",n.type,function(i){if(!i.getSource)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'getSource' method missing on plugin for texture source type '"+n.type+"'.");var o=i.getSource({gl:e});if(!o.subscribe)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'subscribe' method missing on plugin for texture source type '"+n.type+"'");var a=SceneJS_sceneStatusModule.taskStarted(r,"Loading texture");o.subscribe(function(){var n=!1;return function(i){n?r._engine.display.imageDirty=!0:(n=!0,r._setLayerTexture(e,t,i),SceneJS_sceneStatusModule.taskFinished(a))}}()),o.configure&&o.configure(n),t._source=o})}else{var i=t.uri||t.src,o=SceneJS_sceneStatusModule.taskStarted(this,"Loading texture"),a=new Image;a.onload=function(){var n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n);var i=SceneJS_configsModule.configs.maxTextureSize;i&&(a=SceneJS._webgl.clampImageSize(a,i)),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r._ensureImageSizePowerOfTwo(a)),r._setLayerTexture(e,t,n),SceneJS_sceneStatusModule.taskFinished(o),r._engine.display.imageDirty=!0},a.onerror=function(){SceneJS_sceneStatusModule.taskFailed(o)},0==i.indexOf("data")?a.src=i:(a.crossOrigin="Anonymous",a.src=i)}},SceneJS.Texture.prototype._ensureImageSizePowerOfTwo=function(e){if(!this._isPowerOfTwo(e.width)||!this._isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=this._nextHighestPowerOfTwo(e.width),t.height=this._nextHighestPowerOfTwo(e.height);var r=t.getContext("2d");r.drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t,e.crossOrigin=""}return e},SceneJS.Texture.prototype._isPowerOfTwo=function(e){return 0==(e&e-1)},SceneJS.Texture.prototype._nextHighestPowerOfTwo=function(e){--e;for(var t=1;32>t;t<<=1)e|=e>>t;return e+1},SceneJS.Texture.prototype._setLayerTexture=function(e,t,r){t.texture=new SceneJS._webgl.Texture2D(e,{texture:r,minFilter:this._getGLOption("minFilter",e,t,e.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",e,t,e.LINEAR),wrapS:this._getGLOption("wrapS",e,t,e.REPEAT),wrapT:this._getGLOption("wrapT",e,t,e.REPEAT),isDepth:this._getOption(t.isDepth,!1),depthMode:this._getGLOption("depthMode",e,t,e.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",e,t,e.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",e,t,e.LEQUAL),flipY:this._getOption(t.flipY,!0),width:this._getOption(t.width,1),height:this._getOption(t.height,1),internalFormat:this._getGLOption("internalFormat",e,t,e.LEQUAL),sourceFormat:this._getGLOption("sourceType",e,t,e.ALPHA),sourceType:this._getGLOption("sourceType",e,t,e.UNSIGNED_BYTE),update:null}),this.destroyed&&t.texture.destroy(),this._engine.display.imageDirty=!0},SceneJS.Texture.prototype._getGLOption=function(e,t,r,n){var i=r[e];if(void 0==i)return n;var o=SceneJS._webgl.enumMap[i];if(void 0==o)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+e+"' value: '"+i+"'");var a=t[o];return a},SceneJS.Texture.prototype._getOption=function(e,t){return void 0==e?t:e},SceneJS.Texture.prototype.setLayer=function(e){if(void 0==e.index||null==e.index)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index null or undefined");if(e.index<0||e.index>=this._core.layers.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");this._setLayer(parseInt(e.index),e),this._engine.display.imageDirty=!0},SceneJS.Texture.prototype.setLayers=function(e){var t;for(var r in e)if(e.hasOwnProperty(r)&&(void 0!=r||null!=r)){if(t=parseInt(r),0>t||t>=this._core.layers.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");this._setLayer(t,e[r]||{})}this._engine.display.imageDirty=!0},SceneJS.Texture.prototype._setLayer=function(e,t){t=t||{};var r=this._core.layers[e];if(void 0!=t.blendFactor&&null!=t.blendFactor&&(r.blendFactor=t.blendFactor),t.source){var n=r._source;n&&n.configure&&n.configure(t.source)}(t.translate||t.rotate||t.scale)&&this._setLayerTransform(t,r)},SceneJS.Texture.prototype._setLayerTransform=function(e,t){var r,n;if(e.translate){var i=e.translate;void 0!=i.x&&(t.translate.x=i.x),void 0!=i.y&&(t.translate.y=i.y),r=SceneJS_math_translationMat4v([i.x||0,i.y||0,0])}if(e.scale){var o=e.scale;void 0!=o.x&&(t.scale.x=o.x),void 0!=o.y&&(t.scale.y=o.y),n=SceneJS_math_scalingMat4v([o.x||1,o.y||1,1]),r=r?SceneJS_math_mulMat4(r,n):n}if(e.rotate){var a=e.rotate;void 0!=a.z&&(t.rotate.z=a.z||0),n=SceneJS_math_rotationMat4v(.0174532925*a.z,[0,0,1]),r=r?SceneJS_math_mulMat4(r,n):n}r&&(t.matrix=r,t.matrixAsArray?t.matrixAsArray.set(t.matrix):t.matrixAsArray=new Float32Array(t.matrix),t.matrixAsArray=new Float32Array(t.matrix))},SceneJS.Texture.prototype._compile=function(n){this._core.hash||this._makeHash(),this._engine.display.texture=t[r++]=this._core,this._compileNodes(n),this._engine.display.texture=--r>0?t[r-1]:e},SceneJS.Texture.prototype._makeHash=function(){var e,t=this._core;if(t.layers&&t.layers.length>0){for(var r,n=t.layers,i=[],o=0,a=n.length;a>o;o++)r=n[o],i.push("/"),i.push(r.applyFrom),i.push("/"),i.push(r.applyTo),i.push("/"),i.push(r.blendMode),r.matrix&&i.push("/anim");e=i.join("")}else e="";t.hash!=e&&(t.hash=e)},SceneJS.Texture.prototype._destroy=function(){if(1==this._core.useCount)for(var e,t,r=this._core.layers,n=0,i=r.length;i>n;n++)e=r[n],e.texture&&e.texture.destroy(),t=e._source,t&&t.destroy&&t.destroy()}},new function(){function e(){var e,t;(0!=this.translate.x||0!=this.translate.y)&&(e=SceneJS_math_translationMat4v([this.translate.x||0,this.translate.y||0,0])),(1!=this.scale.x||1!=this.scale.y)&&(t=SceneJS_math_scalingMat4v([this.scale.x||1,this.scale.y||1,1]),e=e?SceneJS_math_mulMat4(e,t):t),0!=this.rotate&&(t=SceneJS_math_rotationMat4v(.0174532925*this.rotate,[0,0,1]),e=e?SceneJS_math_mulMat4(e,t):t),e&&(this.matrix=e,this.matrixAsArray?this.matrixAsArray.set(this.matrix):this.matrixAsArray=new Float32Array(this.matrix)),this._matrixDirty=!1}var t={type:"texture",stateId:SceneJS._baseStateId++,empty:!0,hash:""};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(e){e.engine.display.texture=t,n=0});var r=[],n=0;SceneJS.TextureMap=SceneJS_NodeFactory.createNodeType("texture"),SceneJS.TextureMap.prototype._init=function(t){var r=this;if(1==this._core.useCount){if(t.applyFrom&&"uv"!=t.applyFrom&&"uv2"!=t.applyFrom&&"normal"!=t.applyFrom&&"geometry"!=t.applyFrom)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture applyFrom value is unsupported - should be either 'uv', 'uv2', 'normal' or 'geometry'");if(t.applyTo&&"baseColor"!=t.applyTo&&"color"!=t.applyTo&&"specular"!=t.applyTo&&"emit"!=t.applyTo&&"alpha"!=t.applyTo&&"normals"!=t.applyTo&&"shine"!=t.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture applyTo value is unsupported - should be either 'color', 'baseColor', 'specular' or 'normals'");if(t.blendMode&&"add"!=t.blendMode&&"multiply"!=t.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer blendMode value is unsupported - should be either 'add' or 'multiply'");"color"==t.applyTo&&(t.applyTo="baseColor"),SceneJS._apply({waitForLoad:void 0==t.waitForLoad?!0:t.waitForLoad,texture:null,applyFrom:t.applyFrom?t.applyFrom:"uv",applyTo:t.applyTo?t.applyTo:"baseColor",blendMode:t.blendMode?t.blendMode:"multiply",blendFactor:void 0!=t.blendFactor&&null!=t.blendFactor?t.blendFactor:1,translate:t.translate?SceneJS._apply(t.translate,{x:0,y:0}):{x:0,y:0},scale:t.scale?SceneJS._apply(t.scale,{x:1,y:1}):{x:1,y:1},rotate:t.rotate||0,matrix:null,_matrixDirty:!0,buildMatrix:e},this._core),e.call(this._core),t.src?(this._core.src=t.src,this._loadTexture(t.src)):t.image?(this._core.image=t.image,this._initTexture(t.image)):t.target&&this.getScene().getNode(t.target,function(e){r.setTarget(e)}),this._core.webglRestored=function(){r._core.image?r._initTexture(r._core.image):r._core.src?r._loadTexture(r._core.src):r._core.target}}},SceneJS.TextureMap.prototype._loadTexture=function(e){var t=this,r=SceneJS_sceneStatusModule.taskStarted(this,"Loading texture"),n=new Image;n.onload=function(){t._initTexture(n),SceneJS_sceneStatusModule.taskFinished(r),t._engine.display.imageDirty=!0},n.onerror=function(){SceneJS_sceneStatusModule.taskFailed(r)},0==e.indexOf("data")?n.src=e:(n.crossOrigin="Anonymous",n.src=e)},SceneJS.TextureMap.prototype._initTexture=function(e){var t=this._engine.canvas.gl,r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);var n=SceneJS_configsModule.configs.maxTextureSize;n&&(e=SceneJS._webgl.clampImageSize(e,n)),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(e)),this._core.image=e,this._core.texture=new SceneJS._webgl.Texture2D(t,{texture:r,minFilter:this._getGLOption("minFilter",t.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",t.LINEAR),wrapS:this._getGLOption("wrapS",t.REPEAT),wrapT:this._getGLOption("wrapT",t.REPEAT),isDepth:this._getOption(this._core.isDepth,!1),depthMode:this._getGLOption("depthMode",t.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",t.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",t.LEQUAL),flipY:this._getOption(this._core.flipY,!0),width:this._getOption(this._core.width,1),height:this._getOption(this._core.height,1),internalFormat:this._getGLOption("internalFormat",t.ALPHA),sourceFormat:this._getGLOption("sourceFormat",t.ALPHA),sourceType:this._getGLOption("sourceType",t.UNSIGNED_BYTE),update:null}),this.destroyed&&this._core.texture.destroy(),this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype._getGLOption=function(e,t){var r=this._engine.canvas.gl,n=this._core[e];if(void 0==n)return t;var i=SceneJS._webgl.enumMap[n];if(void 0==i)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+e+"' value: '"+n+"'");return r[i]},SceneJS.TextureMap.prototype._getOption=function(e,t){return void 0==e?t:e},SceneJS.TextureMap.prototype.setSrc=function(e){this._core.image=null,this._core.src=e,this._core.target=null,this._loadTexture(e)},SceneJS.TextureMap.prototype.setImage=function(e){this._core.image=e,this._core.src=null,this._core.target=null,this._initTexture(e)},SceneJS.TextureMap.prototype.setTarget=function(e){return"colorTarget"!=e.type&&"depthTarget"!=e.type?void console.log("Target node type not compatible: "+e.type):(delete this._core.src,this._core.target=e,this._core.src=null,this._core.image=null,this._core.texture=e._core.renderBuf.getTexture(),this._core.texture.bufType=e._core.bufType,void(this._engine.display.imageDirty=!0))},SceneJS.TextureMap.prototype.setBlendFactor=function(e){this._core.blendFactor=e,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getBlendFactor=function(){return this._core.blendFactor},SceneJS.TextureMap.prototype.setTranslate=function(e){this._core.translate||(this._core.translate={x:0,y:0}),this._core.translate.x=e.x,this._core.translate.y=e.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getTranslate=function(){return this._core.translate},SceneJS.TextureMap.prototype.setScale=function(e){this._core.scale||(this._core.scale={x:0,y:0}),this._core.scale.x=e.x,this._core.scale.y=e.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getScale=function(){return this._core.scale},SceneJS.TextureMap.prototype.setRotate=function(e){this._core.rotate=e,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getRotate=function(){return this._core.rotate},SceneJS.TextureMap.prototype.getMatrix=function(){return this._core._matrixDirty&&this._core.buildMatrix.call(this.core)(),this.core.matrix},SceneJS.TextureMap.prototype._compile=function(e){this.__core||(this.__core=this._engine._coreFactory.getCore("texture"));var i=this._engine.display.texture;this._core.empty||(this.__core.layers=i&&i.layers?i.layers.concat([this._core]):[this._core]),this._makeHash(this.__core),r[n++]=this.__core,this._engine.display.texture=this.__core,this._compileNodes(e),this._engine.display.texture=--n>0?r[n-1]:t},SceneJS.TextureMap.prototype._makeHash=function(e){var t;if(e.layers&&e.layers.length>0){for(var r,n=e.layers,i=[],o=0,a=n.length;a>o;o++)r=n[o],i.push("/"),i.push(r.applyFrom),i.push("/"),i.push(r.applyTo),i.push("/"),i.push(r.blendMode),r.matrix&&i.push("/anim");t=i.join("")}else t="";e.hash!=t&&(e.hash=t)},SceneJS.TextureMap.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&!this._core.target&&(this._core.texture.destroy(),this._core.texture=null),this._core&&this._engine._coreFactory.putCore(this._core)}},function(){var e={type:"cubemap",stateId:SceneJS._baseStateId++,empty:!0,texture:null,hash:""},t=[],r=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(t){t.engine.display.cubemap=e,r=0}),SceneJS.Reflect=SceneJS_NodeFactory.createNodeType("reflect"),SceneJS.Reflect.prototype._init=function(e){if(1==this._core.useCount){if(this._core.hash="y",e.blendMode&&"add"!=e.blendMode&&"multiply"!=e.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"reflection blendMode value is unsupported - should be either 'add' or 'multiply'");this._core.blendMode=e.blendMode||"multiply",this._core.intensity=void 0!=e.intensity&&null!=e.intensity?e.intensity:1,this._core.applyTo="reflect";for(var t=this,r=this._engine.canvas.gl,n=r.createTexture(),i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z],o=[],a=SceneJS_sceneStatusModule.taskStarted(this,"Loading reflection texture"),s=!1,c=0;c<i.length;c++){var h=new Image;h.onload=function(){var e=h;return function(){if(!s&&(o.push(e),o.length==i.length)){r.bindTexture(r.TEXTURE_CUBE_MAP,n),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1);for(var c=0,h=o.length;h>c;c++)r.texImage2D(i[c],0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(o[c]));t._core.texture=new SceneJS._webgl.Texture2D(r,{texture:n,target:r.TEXTURE_CUBE_MAP,minFilter:r.LINEAR,magFilter:r.LINEAR,wrapS:r.CLAMP_TO_EDGE,wrapT:r.CLAMP_TO_EDGE}),SceneJS_sceneStatusModule.taskFinished(a),t._engine.display.imageDirty=!0}}}(),h.onerror=function(){s=!0,SceneJS_sceneStatusModule.taskFailed(a)},h.src=e.src[c]}}},SceneJS.Reflect.prototype._compile=function(n){this.__core||(this.__core=this._engine._coreFactory.getCore("cubemap"));var i=this._engine.display.cubemap;this._core.empty||(this.__core.layers=i&&i.layers?i.layers.concat([this._core]):[this._core]),this._makeHash(this.__core),t[r++]=this.__core,this._engine.display.cubemap=this.__core,this._compileNodes(n),this._engine.display.cubemap=--r>0?t[r-1]:e},SceneJS.Reflect.prototype._makeHash=function(e){var t;if(e.layers&&e.layers.length>0){for(var r,n=e.layers,i=[],o=0,a=n.length;a>o;o++)r=n[o],i.push("/"),i.push(r.applyTo),i.push("/"),i.push(r.blendMode);t=i.join("")}else t="";e.hash!=t&&(e.hash=t)},SceneJS.Reflect.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&(this._core.texture.destroy(),this._core.texture=null),this._core&&this._coreFactory.putCore(this._core)}}(),SceneJS.XForm=SceneJS_NodeFactory.createNodeType("xform"),SceneJS.XForm.prototype._init=function(e){1==this._core.useCount&&(SceneJS_modelXFormStack.buildCore(this._core),this.setElements(e.elements))},SceneJS.XForm.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.XForm.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.XForm.prototype.setElements=function(e){if(e=e||SceneJS_math_identityMat4(),16!=e.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.XForm elements should number 16");var t=this._core;if(t.matrix)for(var r=0;16>r;r++)t.matrix[r]=e[r];else t.matrix=e;return t.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.XForm.prototype._compile=function(e){SceneJS_modelXFormStack.push(this._core),this._compileNodes(e),SceneJS_modelXFormStack.pop()},SceneJS.Matrix=SceneJS_NodeFactory.createNodeType("matrix"),SceneJS.Matrix.prototype._init=function(e){1==this._core.useCount&&(SceneJS_modelXFormStack.buildCore(this._core),this.setElements(e.elements))},SceneJS.Matrix.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Matrix.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Matrix.prototype.setMatrix=function(e){if(e=e||SceneJS_math_identityMat4(),16!=e.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Matrix elements should number 16");var t=this._core;if(t.matrix)for(var r=0;16>r;r++)t.matrix[r]=e[r];else t.matrix=e;return t.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Matrix.prototype.setElements=SceneJS.Matrix.prototype.setMatrix,SceneJS.Matrix.prototype._compile=function(e){SceneJS_modelXFormStack.push(this._core),this._compileNodes(e),SceneJS_modelXFormStack.pop()},SceneJS.Rotate=SceneJS_NodeFactory.createNodeType("rotate"),SceneJS.Rotate.prototype._init=function(e){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(e.multOrder),this.setAngle(e.angle),this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_rotationMat4v(t.angle*Math.PI/180,[t.x,t.y,t.z])}}},SceneJS.Rotate.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Rotate.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Rotate.prototype.setMultOrder=function(e){if(e=e||"post","post"!=e&&"pre"!=e)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for rotate node - '"+e+"' should be 'pre' or 'post'");this._core.multOrder=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.setAngle=function(e){this._core.angle=e||0,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getAngle=function(){return this._core.angle},SceneJS.Rotate.prototype.setXYZ=function(e){e=e||{},this._core.x=e.x||0,this._core.y=e.y||0,this._core.z=e.z||0,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Rotate.prototype.setX=function(e){this._core.x=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getX=function(){return this._core.x},SceneJS.Rotate.prototype.setY=function(e){this._core.y=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getY=function(){return this._core.y},SceneJS.Rotate.prototype.setZ=function(e){this._core.z=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getZ=function(){return this._core.z},SceneJS.Rotate.prototype.incAngle=function(e){this._core.angle+=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype._compile=function(e){SceneJS_modelXFormStack.push(this._core),this._compileNodes(e),SceneJS_modelXFormStack.pop()},SceneJS.Translate=SceneJS_NodeFactory.createNodeType("translate"),SceneJS.Translate.prototype._init=function(e){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(e.multOrder),this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_translationMat4v([t.x,t.y,t.z],t.matrix)}}},SceneJS.Translate.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Translate.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Translate.prototype.setMultOrder=function(e){if(e=e||"post","post"!=e&&"pre"!=e)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for translate node - '"+e+"' should be 'pre' or 'post'");this._core.multOrder=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Translate.prototype.setXYZ=function(e){return e=e||{},this._core.x=e.x||0,this._core.y=e.y||0,this._core.z=e.z||0,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Translate.prototype.setX=function(e){return this._core.x=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.setY=function(e){return this._core.y=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.setZ=function(e){return this._core.z=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incX=function(e){return this._core.x+=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incY=function(e){return this._core.y+=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incZ=function(e){return this._core.z+=e,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.getX=function(){return this._core.x},SceneJS.Translate.prototype.getY=function(){return this._core.y},SceneJS.Translate.prototype.getZ=function(){return this._core.z},SceneJS.Translate.prototype._compile=function(e){SceneJS_modelXFormStack.push(this._core),this._compileNodes(e),SceneJS_modelXFormStack.pop()},SceneJS.Scale=SceneJS_NodeFactory.createNodeType("scale"),SceneJS.Scale.prototype._init=function(e){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(e.multOrder),this.setXYZ({x:e.x,y:e.y,z:e.z});var t=this._core;this._core.buildMatrix=function(){t.matrix=SceneJS_math_scalingMat4v([t.x,t.y,t.z])}}},SceneJS.Scale.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Scale.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Scale.prototype.setMultOrder=function(e){if(e=e||"post","post"!=e&&"pre"!=e)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for scale node - '"+e+"' should be 'pre' or 'post'");this._core.multOrder=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setXYZ=function(e){e=e||{},this._core.x=void 0==e.x?1:e.x,this._core.y=void 0==e.y?1:e.y,this._core.z=void 0==e.z?1:e.z,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Scale.prototype.setX=function(e){this._core.x=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setY=function(e){this._core.y=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setZ=function(e){this._core.z=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.getX=function(){return this._core.x},SceneJS.Scale.prototype.getY=function(){return this._core.y},SceneJS.Scale.prototype.getZ=function(){return this._core.z},SceneJS.Scale.prototype.incX=function(e){this._core.x+=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.incY=function(e){this._core.y+=e,this._core.matrixDirty=!0},SceneJS.Scale.prototype.incZ=function(e){this._core.z+=e,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype._compile=function(e){SceneJS_modelXFormStack.push(this._core),this._compileNodes(e),SceneJS_modelXFormStack.pop()};var SceneJS_modelXFormStack=new function(){var e=SceneJS_math_identityMat4(),t=new Float32Array(e),r=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4())),n=new Float32Array(r),i={type:"xform",stateId:SceneJS._baseStateId++,matrix:e,mat:t,normalMatrix:r,normalMat:n,parent:null,cores:[],numCores:0,dirty:!1,matrixDirty:!1},o=[],a=0;this.top=i;var s,c=this;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){a=0,c.top=i,s=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(e){s&&(e.display.modelTransform=a>0?o[a-1]:i,s=!1)}),this.buildCore=function(e){function t(e){e.dirty=!0,e.matrixDirty=!0;for(var r=0,n=e.numCores;n>r;r++)t(e.cores[r])}e.parent=null,e.cores=[],e.numCores=0,e.matrixDirty=!1,e.matrix=SceneJS_math_identityMat4(),e.mat=new Float32Array(e.matrix),e.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(e.matrix,SceneJS_math_mat4()))),e.dirty=!1,e.setDirty=function(){e.matrixDirty=!0,e.dirty,t(e)},e.build=function(){e.matrixDirty&&(e.buildMatrix&&e.buildMatrix(),e.matrixDirty=!1);var t,r=e.parent;if(r)for(t=e.matrix.slice(0);r;)r.matrixDirty&&(r.buildMatrix&&r.buildMatrix(),r.mat.set(r.matrix),r.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(r.matrix,SceneJS_math_mat4()))),r.matrixDirty=!1),SceneJS_math_mulMat4(r.matrix,t,t),!r.dirty,r=r.parent;else t=e.matrix;e.mat.set(t),e.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(t,SceneJS_math_mat4()))),e.dirty=!1}},this.push=function(e){o[a++]=e,e.parent=this.top,e.dirty=!0,this.top&&(this.top.cores[this.top.numCores++]=e),e.numCores=0,this.top=e,s=!0},this.pop=function(){this.top=--a>0?o[a-1]:i,s=!0}};SceneJS.Types=new function(){this.addType=function(e,t){SceneJS_NodeFactory.createNodeType(e,t,function(e){var r;for(var n in t)if(t.hasOwnProperty(n))switch(r=t[n],n){case"init":case"construct":!function(){var r=t[n];e.prototype._init=function(e){r.call(this,e)},e.prototype._fromPlugin=!0}();break;case"destroy":case"destruct":e.prototype._destroy=r;break;default:e.prototype[n]=r}})},this.hasType=function(e){return!!SceneJS_NodeFactory.nodeTypes[e]}};var SceneJS_Display=function(e){this._canvas=e.canvas,this._programFactory=new SceneJS_ProgramFactory({canvas:e.canvas}),this._chunkFactory=new SceneJS_ChunkFactory,this.transparent=e.transparent===!0,this.enable=null,this.flags=null,this.layer=null,this.stage=null,this.renderer=null,this.depthBuffer=null,this.colorBuffer=null,this.view=null,this.lights=null,this.material=null,this.texture=null,this.cubemap=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.renderTarget=null,this.clips=null,this.morphGeometry=null,this.name=null,this.tag=null,this.renderListeners=null,this.shader=null,this.shaderParams=null,this.style=null,this.geometry=null,this._objectFactory=new SceneJS_ObjectFactory,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._targetList=[],this._targetListLen=0,this._frameCtx={pickNames:[],canvas:this._canvas,VAO:null},this._frameCtx.renderListenerCtx=new SceneJS.RenderContext(this._frameCtx),this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0,this.pickBufDirty=!0,this.rayPickBufDirty=!0
};SceneJS_Display.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var e=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(e),this.rayPickBuf&&this.rayPickBuf.webglRestored(e),this.imageDirty=!0},SceneJS_Display.prototype.buildObject=function(e){var t=this._objects[e];t||(t=this._objects[e]=this._objectFactory.getObject(e),this.objectListDirty=!0),t.stage=this.stage,t.layer=this.layer,t.renderTarget=this.renderTarget,t.texture=this.texture,t.cubemap=this.cubemap,t.geometry=this.geometry,t.enable=this.enable,t.flags=this.flags,t.tag=this.tag;var r=[this.geometry.hash,this.shader.hash,this.clips.hash,this.morphGeometry.hash,this.texture.hash,this.cubemap.hash,this.lights.hash].join(";");t.program&&r==t.hash||(t.program&&this._programFactory.putProgram(t.program),t.program=this._programFactory.getProgram(r,this),t.hash=r),this._setChunk(t,0,"program"),this._setChunk(t,1,"xform",this.modelTransform),this._setChunk(t,2,"lookAt",this.viewTransform),this._setChunk(t,3,"camera",this.projTransform),this._setChunk(t,4,"flags",this.flags),this._setChunk(t,5,"shader",this.shader),this._setChunk(t,6,"shaderParams",this.shaderParams),this._setChunk(t,7,"style",this.style),this._setChunk(t,8,"depthBuffer",this.depthBuffer),this._setChunk(t,9,"colorBuffer",this.colorBuffer),this._setChunk(t,10,"view",this.view),this._setChunk(t,11,"name",this.name),this._setChunk(t,12,"lights",this.lights),this._setChunk(t,13,"material",this.material),this._setChunk(t,14,"texture",this.texture),this._setChunk(t,15,"cubemap",this.cubemap),this._setChunk(t,16,"clips",this.clips),this._setChunk(t,17,"renderer",this.renderer),this._setChunk(t,18,"geometry",this.morphGeometry,this.geometry),this._setChunk(t,19,"listeners",this.renderListeners),this._setChunk(t,20,"draw",this.geometry)},SceneJS_Display.prototype._setChunk=function(e,t,r,n,i){var o,a=this._chunkFactory.chunkTypes[r];if(n){if(n.empty){var s=e.chunks[t];return s&&this._chunkFactory.putChunk(s),void(e.chunks[t]=null)}o=a.prototype.programGlobal?"_"+n.stateId:"p"+e.program.id+"_"+n.stateId,i&&(o+="__"+i.stateId)}else o="p"+e.program.id;o=t+"__"+o;var s=e.chunks[t];if(s){if(s.id==o)return;this._chunkFactory.putChunk(s)}e.chunks[t]=this._chunkFactory.getChunk(o,r,e.program,n,i),"lights"==r&&this._setAmbient(n)},SceneJS_Display.prototype._setAmbient=function(e){for(var t,r=e.lights,n=0,i=r.length;i>n;n++)t=r[n],"ambient"==t.mode&&(this._ambientColor[0]=t.color[0],this._ambientColor[1]=t.color[1],this._ambientColor[2]=t.color[2])},SceneJS_Display.prototype.removeObject=function(e){var t=this._objects[e];t&&(this._programFactory.putProgram(t.program),t.program=null,t.hash=null,this._objectFactory.putObject(t),delete this._objects[e],this.objectListDirty=!0)},SceneJS_Display.prototype.selectTags=function(e){this._tagSelector=e,this.drawListDirty=!0},SceneJS_Display.prototype.render=function(e){e=e||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||e.force)&&(this._doDrawList({clear:e.clear!==!1}),this.imageDirty=!1,this.pickBufDirty=!0)},SceneJS_Display.prototype._buildObjectList=function(){this._objectListLen=0;for(var e in this._objects)this._objects.hasOwnProperty(e)&&(this._objectList[this._objectListLen++]=this._objects[e])},SceneJS_Display.prototype._makeStateSortKeys=function(){for(var e,t=0,r=this._objectListLen;r>t;t++)e=this._objectList[t],e.sortKey=e.program?1e12*(e.stage.priority+1)+1e9*(e.flags.transparent?2:1)+1e6*(e.layer.priority+1)+1e3*(e.program.id+1)+e.texture.stateId:-1},SceneJS_Display.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(this._stateSortObjects)},SceneJS_Display.prototype._stateSortObjects=function(e,t){return e.sortKey-t.sortKey},SceneJS_Display.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var e=0,t=this._objectListLen;t>e;e++){var r=this._objectList[e];console.log("SceneJS_Display : object["+e+"] sortKey = "+r.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},SceneJS_Display.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[],this._lastPickStateId=this._lastPickStateId||[];for(var e=0;23>e;e++)this._lastStateId[e]=null,this._lastPickStateId[e]=null;this._drawListLen=0,this._pickDrawListLen=0;var t,r,n,i,o,a={},s=[],c=[];this._tagSelector&&(r=this._tagSelector.mask,n=this._tagSelector.regex),this._objectDrawList=this._objectDrawList||[],this._objectDrawListLen=0;for(var e=0,h=this._objectListLen;h>e;e++)if(t=this._objectList[e],t.enable.enabled!==!1&&(o=t.flags,o.enabled!==!1&&t.layer.enabled&&(!r||(i=t.tag,!i.tag||(i.mask!=r&&(i.mask=r,i.matches=n.test(i.tag)),i.matches)))))if(t.renderTarget.targets)for(var u,l,S,p=t.renderTarget.targets,_=0,d=p.length;d>_;_++)u=p[_],l=u.coreId,S=a[l],S||(S=[],a[l]=S,s.push(S),c.push(this._chunkFactory.getChunk(u.stateId,"renderTarget",t.program,u))),S.push(t);else this._objectDrawList[this._objectDrawListLen++]=t;for(var S,u,t,f,e=0,h=s.length;h>e;e++){S=s[e],u=c[e],this._appendRenderTargetChunk(u);for(var _=0,d=S.length;d>_;_++)t=S[_],f=t.stage&&t.stage.pickable,this._appendObjectToDrawLists(t,f)}t&&this._appendRenderTargetChunk(this._chunkFactory.getChunk(-1,"renderTarget",t.program,{}));for(var e=0,h=this._objectDrawListLen;h>e;e++)t=this._objectDrawList[e],f=!t.stage||t.stage&&t.stage.pickable,this._appendObjectToDrawLists(t,f);this.drawListDirty=!1},SceneJS_Display.prototype._appendRenderTargetChunk=function(e){this._drawList[this._drawListLen++]=e},SceneJS_Display.prototype._appendObjectToDrawLists=function(e,t){for(var r,n=e.chunks,i=e.flags.picking,o=0,a=n.length;a>o;o++)r=n[o],r&&(r.draw&&(r.unique||this._lastStateId[o]!=r.id)&&(this._drawList[this._drawListLen++]=r,this._lastStateId[o]=r.id),r.pick&&t!==!1&&i&&(r.unique||this._lastPickStateId[o]!=r.id)&&(this._pickDrawList[this._pickDrawListLen++]=r,this._lastPickStateId[o]=r.id))},SceneJS_Display.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var e=0,t=this._drawListLen;t>e;e++){var r=this._drawList[e];switch(console.log("[chunk "+e+"] type = "+r.type),r.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+r.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},SceneJS_Display.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var e=0,t=this._pickDrawListLen;t>e;e++){var r=this._pickDrawList[e];switch(console.log("[chunk "+e+"] type = "+r.type),r.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+r.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},SceneJS_Display.prototype.pick=function(e){var t=this._canvas.canvas,r=null,n=e.canvasX,i=e.canvasY,o=this.pickBuf;o||(o=this.pickBuf=new SceneJS._webgl.RenderBuffer({canvas:this._canvas}),this.pickBufDirty=!0),this.render(),o.bind(),this.pickBufDirty&&(o.clear(),this._doDrawList({pick:!0,clear:!0}),this._canvas.gl.finish(),this.pickBufDirty=!1,this.rayPickBufDirty=!0);var a=o.read(n,i),s=a[0]+256*a[1]+65536*a[2],c=s>=1?s-1:-1;o.unbind();var h=this._frameCtx.pickNames[c];if(h&&(r={name:h.name,path:h.path,nodeId:h.nodeId,canvasPos:[n,i]},e.rayPick)){var u=this.rayPickBuf;u||(u=this.rayPickBuf=new SceneJS._webgl.RenderBuffer({canvas:this._canvas}),this.rayPickBufDirty=!0),u.bind(),this.rayPickBufDirty&&(u.clear(),this._doDrawList({pick:!0,rayPick:!0,clear:!0}),this.rayPickBufDirty=!1),a=u.read(n,i),u.unbind();var l=this._unpackDepth(a),S=t.width,p=t.height,_=(n-S/2)/(S/2),d=-(i-p/2)/(p/2),f=this._frameCtx.cameraMat,m=this._frameCtx.viewMat,g=SceneJS_math_mulMat4(f,m,[]),y=SceneJS_math_inverseMat4(g,[]),v=SceneJS_math_transformVector4(y,[_,d,-1,1]);v=SceneJS_math_mulVec4Scalar(v,1/v[3]);var J=SceneJS_math_transformVector4(y,[_,d,1,1]);J=SceneJS_math_mulVec4Scalar(J,1/J[3]);var E=SceneJS_math_subVec3(J,v,[]),b=SceneJS_math_addVec3(v,SceneJS_math_mulVec4Scalar(E,l,[]),[]);r.worldPos=b}return r},SceneJS_Display.prototype.readPixels=function(e,t){this._readPixelBuf||(this._readPixelBuf=new SceneJS._webgl.RenderBuffer({canvas:this._canvas})),this._readPixelBuf.bind(),this._readPixelBuf.clear(),this.render({force:!0});for(var r,n,i=0;t>i;i++)r=e[i]||(e[i]={}),n=this._readPixelBuf.read(r.x,r.y),r.r=n[0],r.g=n[1],r.b=n[2],r.a=n[3];this._readPixelBuf.unbind()},SceneJS_Display.prototype._unpackDepth=function(e){var t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],r=[1/16777216,1/65536,1/256,1];return SceneJS_math_dotVector4(t,r)},SceneJS_Display.prototype._doDrawList=function(e){var t=this._canvas.gl,r=this._frameCtx;r.renderTarget=null,r.targetIndex=0,r.renderBuf=null,r.viewMat=null,r.modelMat=null,r.cameraMat=null,r.renderer=null,r.depthbufEnabled=null,r.clearDepth=null,r.depthFunc=t.LESS,r.scissorTestEnabled=!1,r.blendEnabled=!1,r.backfaces=!0,r.frontface="ccw",r.pick=!!e.pick,r.rayPick=!!e.rayPick,r.pickIndex=0,r.textureUnit=0,r.lineWidth=1,r.transparent=!1,r.ambientColor=this._ambientColor,r.aspect=this._canvas.canvas.width/this._canvas.canvas.height;var n=t.getExtension("OES_vertex_array_object");if(r.VAO=n?n:null,r.VAO=null,t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),this.transparent?t.clearColor(0,0,0,0):t.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),e.clear&&t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.disable(t.BLEND),e.pick)for(var i=0,o=this._pickDrawListLen;o>i;i++)this._pickDrawList[i].pick(r);else for(var i=0,o=this._drawListLen;o>i;i++)this._drawList[i].draw(r);if(t.flush(),r.renderBuf&&r.renderBuf.unbind(),r.VAO){r.VAO.bindVertexArrayOES(null);for(var i=0;10>i;i++)t.disableVertexAttribArray(i)}},SceneJS_Display.prototype.destroy=function(){this._programFactory.destroy()};var SceneJS_ProgramSourceFactory=new function(){this._sourceCache={},this.getSource=function(e,t){var r=this._sourceCache[e];return r?(r.useCount++,r):this._sourceCache[e]=new SceneJS_ProgramSource(e,this._composePickingVertexShader(t),this._composePickingFragmentShader(t),this._composeRenderingVertexShader(t),this._composeRenderingFragmentShader(t))},this.putSource=function(e){var t=this._sourceCache[e];t&&0==--t.useCount&&(this._sourceCache[t.hash]=null)},this._composePickingVertexShader=function(e){var t=!!e.morphGeometry.targets,r=["precision mediump float;","attribute vec3 SCENEJS_aVertex;","uniform mat4 SCENEJS_uMMatrix;","uniform mat4 SCENEJS_uVMatrix;","uniform mat4 SCENEJS_uVNMatrix;","uniform mat4 SCENEJS_uPMatrix;"];return r.push("varying vec4 SCENEJS_vWorldVertex;"),r.push("varying vec4 SCENEJS_vViewVertex;"),t&&(r.push("uniform float SCENEJS_uMorphFactor;"),e.morphGeometry.targets[0].vertexBuf&&r.push("attribute vec3 SCENEJS_aMorphVertex;")),r.push("void main(void) {"),r.push("   vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); "),t&&e.morphGeometry.targets[0].vertexBuf&&r.push("  tmpVertex = vec4(mix(tmpVertex.xyz, SCENEJS_aMorphVertex, SCENEJS_uMorphFactor), 1.0); "),r.push("  SCENEJS_vWorldVertex = SCENEJS_uMMatrix * tmpVertex; "),r.push("  SCENEJS_vViewVertex = SCENEJS_uVMatrix * SCENEJS_vWorldVertex;"),r.push("  gl_Position =  SCENEJS_uPMatrix * SCENEJS_vViewVertex;"),r.push("}"),r},this._composePickingFragmentShader=function(e){var t=e.clips.clips.length>0,r=["precision mediump float;"];if(r.push("varying vec4 SCENEJS_vWorldVertex;"),r.push("varying vec4  SCENEJS_vViewVertex;"),r.push("uniform bool  SCENEJS_uRayPickMode;"),r.push("uniform vec3  SCENEJS_uPickColor;"),r.push("uniform float SCENEJS_uZNear;"),r.push("uniform float SCENEJS_uZFar;"),r.push("uniform bool  SCENEJS_uClipping;"),t)for(var n=0;n<e.clips.clips.length;n++)r.push("uniform float SCENEJS_uClipMode"+n+";"),r.push("uniform vec4  SCENEJS_uClipNormalAndDist"+n+";");if(r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),t){r.push("if (SCENEJS_uClipping) {"),r.push("  float   dist;");for(var n=0;n<e.clips.clips.length;n++)r.push("    if (SCENEJS_uClipMode"+n+" != 0.0) {"),r.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+n+".xyz) - SCENEJS_uClipNormalAndDist"+n+".w;"),r.push("        if (SCENEJS_uClipMode"+n+" == 1.0) {"),r.push("            if (dist > 0.0) { discard; }"),r.push("        }"),r.push("        if (SCENEJS_uClipMode"+n+" == 2.0) {"),r.push("            if (dist > 0.0) { discard; }"),r.push("        }"),r.push("    }");r.push("}")}return r.push("    if (SCENEJS_uRayPickMode) {"),r.push("          float zNormalizedDepth = abs((SCENEJS_uZNear + SCENEJS_vViewVertex.z) / (SCENEJS_uZFar - SCENEJS_uZNear));"),r.push("          gl_FragColor = packDepth(zNormalizedDepth); "),r.push("    } else {"),r.push("          gl_FragColor = vec4(SCENEJS_uPickColor.rgb, 1.0);  "),r.push("    }"),r.push("}"),r},this._isTexturing=function(e){if(e.texture.layers&&e.texture.layers.length>0){if(e.geometry.uvBuf||e.geometry.uvBuf2)return!0;if(e.morphGeometry.targets&&(e.morphGeometry.targets[0].uvBuf||e.morphGeometry.targets[0].uvBuf2))return!0}return!1},this._isCubeMapping=function(e){return e.cubemap.layers&&e.cubemap.layers.length>0&&e.geometry.normalBuf},this._hasNormals=function(e){return e.geometry.normalBuf?!0:e.morphGeometry.targets&&e.morphGeometry.targets[0].normalBuf?!0:!1},this._hasTangents=function(e){if(e.texture){var t=e.texture.layers;if(!t)return!1;for(var r=0,n=t.length;n>r;r++)if("normals"==t[r].applyTo)return!0}return!1},this._composeRenderingVertexShader=function(e){var t=e.shader.shaders||{};if(t.vertex&&t.vertex.code&&""!=t.vertex.code&&SceneJS._isEmpty(t.vertex.hooks))return[t.vertex.code];var r=t.vertex||{},n=r.hooks||{},i=t.fragment||{},o=i.hooks||{},a=this._isTexturing(e),s=this._hasNormals(e),c=this._hasTangents(e),h=e.clips.clips.length>0,u=!!e.morphGeometry.targets,l=["precision mediump float;"];if(l.push("uniform mat4 SCENEJS_uMMatrix;"),l.push("uniform mat4 SCENEJS_uVMatrix;"),l.push("uniform mat4 SCENEJS_uPMatrix;"),l.push("attribute vec3 SCENEJS_aVertex;"),l.push("uniform vec3 SCENEJS_uWorldEye;"),l.push("varying vec3 SCENEJS_vViewEyeVec;"),s){l.push("attribute vec3 SCENEJS_aNormal;"),l.push("uniform   mat4 SCENEJS_uMNMatrix;"),l.push("uniform   mat4 SCENEJS_uVNMatrix;"),l.push("varying   vec3 SCENEJS_vViewNormal;"),c&&l.push("attribute vec4 SCENEJS_aTangent;");for(var S=0;S<e.lights.lights.length;S++){var p=e.lights.lights[S];"ambient"!=p.mode&&("dir"==p.mode&&l.push("uniform vec3 SCENEJS_uLightDir"+S+";"),"point"==p.mode&&l.push("uniform vec3 SCENEJS_uLightPos"+S+";"),"spot"==p.mode&&l.push("uniform vec3 SCENEJS_uLightPos"+S+";"),l.push("varying vec4 SCENEJS_vViewLightVecAndDist"+S+";"))}}if(a&&(e.geometry.uvBuf&&l.push("attribute vec2 SCENEJS_aUVCoord;"),e.geometry.uvBuf2&&l.push("attribute vec2 SCENEJS_aUVCoord2;")),e.geometry.colorBuf&&(l.push("attribute vec4 SCENEJS_aVertexColor;"),l.push("varying vec4 SCENEJS_vColor;")),h&&l.push("varying vec4 SCENEJS_vWorldVertex;"),l.push("varying vec4 SCENEJS_vViewVertex;"),a&&(e.geometry.uvBuf&&l.push("varying vec2 SCENEJS_vUVCoord;"),e.geometry.uvBuf2&&l.push("varying vec2 SCENEJS_vUVCoord2;")),u&&(l.push("uniform float SCENEJS_uMorphFactor;"),e.morphGeometry.targets[0].vertexBuf&&l.push("attribute vec3 SCENEJS_aMorphVertex;"),s&&e.morphGeometry.targets[0].normalBuf&&l.push("attribute vec3 SCENEJS_aMorphNormal;")),r.code&&l.push("\n"+r.code+"\n"),l.push("void main(void) {"),l.push("  vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); "),l.push("  vec4 modelVertex = tmpVertex; "),s&&l.push("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); "),u&&(e.morphGeometry.targets[0].vertexBuf&&(l.push("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); "),l.push("  modelVertex = vec4(mix(modelVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")),s&&e.morphGeometry.targets[0].normalBuf&&(l.push("  vec4 vMorphNormal = vec4(SCENEJS_aMorphNormal, 1.0); "),l.push("  modelNormal = vec4( mix(modelNormal.xyz, vMorphNormal.xyz, SCENEJS_uMorphFactor), 1.0); "))),l.push("  vec4 worldVertex = SCENEJS_uMMatrix * modelVertex;"),l.push(n.viewMatrix?"vec4 viewVertex = "+n.viewMatrix+"(SCENEJS_uVMatrix) * worldVertex;":"vec4 viewVertex  = SCENEJS_uVMatrix * worldVertex; "),n.viewPos&&l.push("viewVertex="+n.viewPos+"(viewVertex);"),s&&(l.push("  vec3 worldNormal = (SCENEJS_uMNMatrix * modelNormal).xyz; "),l.push("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")),(h||o.worldPos)&&l.push("  SCENEJS_vWorldVertex = worldVertex;"),l.push("  SCENEJS_vViewVertex = viewVertex;"),l.push(n.projMatrix?"gl_Position = "+n.projMatrix+"(SCENEJS_uPMatrix) * viewVertex;":"  gl_Position = SCENEJS_uPMatrix * viewVertex;"),c&&(l.push("vec3 tangent = normalize((SCENEJS_uVNMatrix * SCENEJS_uMNMatrix * SCENEJS_aTangent).xyz);"),l.push("vec3 bitangent = cross(SCENEJS_vViewNormal, tangent);"),l.push("mat3 TBM = mat3(tangent, bitangent, SCENEJS_vViewNormal);")),l.push("  vec3 tmpVec3;"),s)for(var S=0;S<e.lights.lights.length;S++)p=e.lights.lights[S],"ambient"!=p.mode&&("dir"==p.mode&&("world"==p.space?(l.push("tmpVec3 = normalize(SCENEJS_uLightDir"+S+");"),l.push("tmpVec3 = vec3(SCENEJS_uVMatrix * vec4(tmpVec3, 0.0)).xyz;"),c&&l.push("tmpVec3 *= TBM;")):(l.push("tmpVec3 = normalize(SCENEJS_uLightDir"+S+");"),c&&l.push("tmpVec3 *= TBM;")),l.push("SCENEJS_vViewLightVecAndDist"+S+" = vec4(-tmpVec3, 0.0);")),"point"==p.mode&&("world"==p.space?(l.push("tmpVec3 = SCENEJS_uLightPos"+S+" - worldVertex.xyz;"),l.push("tmpVec3 = vec3(SCENEJS_uVMatrix * vec4(tmpVec3, 0.0)).xyz;"),c&&l.push("tmpVec3 *= TBM;")):(l.push("tmpVec3 = SCENEJS_uLightPos"+S+".xyz - viewVertex.xyz;"),c&&l.push("tmpVec3 *= TBM;")),l.push("SCENEJS_vViewLightVecAndDist"+S+" = vec4(tmpVec3, length( SCENEJS_uLightPos"+S+" - worldVertex.xyz));")));return l.push("SCENEJS_vViewEyeVec = ((SCENEJS_uVMatrix * vec4(SCENEJS_uWorldEye, 0.0)).xyz  - viewVertex.xyz);"),c&&l.push("SCENEJS_vViewEyeVec *= TBM;"),a&&(e.geometry.uvBuf&&l.push("SCENEJS_vUVCoord = SCENEJS_aUVCoord;"),e.geometry.uvBuf2&&l.push("SCENEJS_vUVCoord2 = SCENEJS_aUVCoord2;")),e.geometry.colorBuf&&l.push("SCENEJS_vColor = SCENEJS_aVertexColor;"),l.push("}"),l},this._composeRenderingFragmentShader=function(e){var t=e.shader.shaders||{};if(t.fragment&&t.fragment.code&&""!=t.fragment.code&&SceneJS._isEmpty(t.fragment.hooks))return[t.fragment.code];var r=t.fragment||{},n=r.hooks||{},i=this._isTexturing(e),o=this._isCubeMapping(e),a=this._hasNormals(e),s=this._hasTangents(e),c=e.clips.clips.length>0,h=["\n"];if(h.push("precision mediump float;"),c&&h.push("varying vec4 SCENEJS_vWorldVertex;"),h.push("varying vec4 SCENEJS_vViewVertex;"),h.push("uniform float SCENEJS_uZNear;"),h.push("uniform float SCENEJS_uZFar;"),c)for(var u=0;u<e.clips.clips.length;u++)h.push("uniform float SCENEJS_uClipMode"+u+";"),h.push("uniform vec4  SCENEJS_uClipNormalAndDist"+u+";");if(i){e.geometry.uvBuf&&h.push("varying vec2 SCENEJS_vUVCoord;"),e.geometry.uvBuf2&&h.push("varying vec2 SCENEJS_vUVCoord2;");for(var l,u=0,S=e.texture.layers.length;S>u;u++)l=e.texture.layers[u],h.push("uniform sampler2D SCENEJS_uSampler"+u+";"),l.matrix&&h.push("uniform mat4 SCENEJS_uLayer"+u+"Matrix;"),h.push("uniform float SCENEJS_uLayer"+u+"BlendFactor;")}if(a&&o)for(var l,u=0,S=e.cubemap.layers.length;S>u;u++)l=e.cubemap.layers[u],h.push("uniform samplerCube SCENEJS_uCubeMapSampler"+u+";"),h.push("uniform float SCENEJS_uCubeMapIntensity"+u+";");if(h.push("uniform bool  SCENEJS_uBackfaceTexturing;"),h.push("uniform bool  SCENEJS_uBackfaceLighting;"),h.push("uniform bool  SCENEJS_uSpecularLighting;"),h.push("uniform bool  SCENEJS_uClipping;"),h.push("uniform bool  SCENEJS_uAmbient;"),h.push("uniform bool  SCENEJS_uDiffuse;"),h.push("uniform bool  SCENEJS_uReflection;"),h.push("uniform bool  SCENEJS_uDepthMode;"),h.push("uniform bool  SCENEJS_uTransparent;"),e.geometry.colorBuf&&h.push("varying vec4 SCENEJS_vColor;"),h.push("uniform vec3  SCENEJS_uAmbientColor;"),h.push("uniform vec3  SCENEJS_uMaterialColor;"),h.push("uniform float SCENEJS_uMaterialAlpha;"),h.push("uniform float SCENEJS_uMaterialEmit;"),h.push("uniform vec3  SCENEJS_uMaterialSpecularColor;"),h.push("uniform float SCENEJS_uMaterialSpecular;"),h.push("uniform float SCENEJS_uMaterialShine;"),h.push("varying vec3 SCENEJS_vViewEyeVec;"),a){h.push("varying vec3 SCENEJS_vViewNormal;");for(var p,u=0;u<e.lights.lights.length;u++)p=e.lights.lights[u],"ambient"!=p.mode&&(h.push("uniform vec3  SCENEJS_uLightColor"+u+";"),"point"==p.mode&&h.push("uniform vec3  SCENEJS_uLightAttenuation"+u+";"),h.push("varying vec4  SCENEJS_vViewLightVecAndDist"+u+";"))}if(r.code&&h.push("\n"+r.code+"\n"),h.push("void main(void) {"),c){h.push("if (SCENEJS_uClipping) {"),h.push("  float   dist;");for(var u=0;u<e.clips.clips.length;u++)h.push("    if (SCENEJS_uClipMode"+u+" != 0.0) {"),h.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+u+".xyz) - SCENEJS_uClipNormalAndDist"+u+".w;"),h.push("        if (SCENEJS_uClipMode"+u+" == 1.0) {"),h.push("            if (dist > 0.0) { discard; }"),h.push("        }"),h.push("        if (SCENEJS_uClipMode"+u+" == 2.0) {"),h.push("            if (dist > 0.0) { discard; }"),h.push("        }"),h.push("    }");h.push("}")}h.push("  vec3 ambient= SCENEJS_uAmbient ? SCENEJS_uAmbientColor : vec3(0.0, 0.0, 0.0);"),i&&e.geometry.uvBuf&&n.texturePos&&h.push(n.texturePos+"(SCENEJS_vUVCoord);"),n.viewPos&&h.push(n.viewPos+"(SCENEJS_vViewVertex);"),a&&n.viewNormal&&h.push(n.viewNormal+"(SCENEJS_vViewNormal);"),h.push(e.geometry.colorBuf?"  vec3    color   = SCENEJS_vColor.rgb;":"  vec3    color   = SCENEJS_uMaterialColor;"),h.push("  float alpha         = SCENEJS_uMaterialAlpha;"),h.push("  float emit          = SCENEJS_uMaterialEmit;"),h.push("  float specular      = SCENEJS_uMaterialSpecular;"),h.push("  vec3  specularColor = SCENEJS_uMaterialSpecularColor;"),h.push("  float shine         = SCENEJS_uMaterialShine;"),n.materialBaseColor&&h.push("color="+n.materialBaseColor+"(color);"),n.materialAlpha&&h.push("alpha="+n.materialAlpha+"(alpha);"),n.materialEmit&&h.push("emit="+n.materialEmit+"(emit);"),n.materialSpecular&&h.push("specular="+n.materialSpecular+"(specular);"),n.materialSpecularColor&&h.push("specularColor="+n.materialSpecularColor+"(specularColor);"),n.materialShine&&h.push("shine="+n.materialShine+"(shine);"),a&&(h.push("  float   attenuation = 1.0;"),h.push(s?"  vec3    viewNormalVec = vec3(0.0, 1.0, 0.0);":"  vec3    viewNormalVec = normalize(SCENEJS_vViewNormal);"));var l;if(i){a&&h.push("if (SCENEJS_uBackfaceTexturing || dot(SCENEJS_vViewNormal, SCENEJS_vViewEyeVec) > 0.0) {"),h.push("  vec4    texturePos;"),h.push("  vec2    textureCoord=vec2(0.0,0.0);");for(var u=0,S=e.texture.layers.length;S>u;u++){if(l=e.texture.layers[u],"normal"==l.applyFrom&&a){if(!e.geometry.normalBuf){SceneJS.log.warn("Texture layer applyFrom='normal' but geo has no normal vectors");continue}h.push("texturePos=vec4(viewNormalVec.xyz, 1.0);")}if("uv"==l.applyFrom){if(!e.geometry.uvBuf){SceneJS.log.warn("Texture layer applyTo='uv' but geometry has no UV coordinates");continue}h.push("texturePos = vec4(SCENEJS_vUVCoord.s, SCENEJS_vUVCoord.t, 1.0, 1.0);")}if("uv2"==l.applyFrom){if(!e.geometry.uvBuf2){SceneJS.log.warn("Texture layer applyTo='uv2' but geometry has no UV2 coordinates");continue}h.push("texturePos = vec4(SCENEJS_vUVCoord2.s, SCENEJS_vUVCoord2.t, 1.0, 1.0);")}h.push(l.matrix?"textureCoord=(SCENEJS_uLayer"+u+"Matrix * texturePos).xy;":"textureCoord=texturePos.xy;"),"alpha"==l.applyTo&&("multiply"==l.blendMode?h.push("alpha = alpha * (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);"):"add"==l.blendMode&&h.push("alpha = ((1.0 - SCENEJS_uLayer"+u+"BlendFactor) * alpha) + (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")),"baseColor"==l.applyTo&&h.push("multiply"==l.blendMode?"color = color * (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);":"color = ((1.0 - SCENEJS_uLayer"+u+"BlendFactor) * color) + (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);"),"emit"==l.applyTo&&h.push("multiply"==l.blendMode?"emit  = emit * (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"emit = ((1.0 - SCENEJS_uLayer"+u+"BlendFactor) * emit) + (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"specular"==l.applyTo&&a&&h.push("multiply"==l.blendMode?"specular  = specular * (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"specular = ((1.0 - SCENEJS_uLayer"+u+"BlendFactor) * specular) + (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"shine"==l.applyTo&&h.push("multiply"==l.blendMode?"shine  = shine * (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"shine = ((1.0 - SCENEJS_uLayer"+u+"BlendFactor) * shine) + (SCENEJS_uLayer"+u+"BlendFactor * texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"normals"==l.applyTo&&a&&h.push("viewNormalVec = normalize(texture2D(SCENEJS_uSampler"+u+", vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);")}a&&h.push("}")}if(a&&o){h.push("if (SCENEJS_uReflection) {"),h.push("vec3 envLookup = reflect(SCENEJS_vViewEyeVec, viewNormalVec);"),h.push("envLookup.y = envLookup.y * -1.0;"),h.push("vec4 envColor;");for(var u=0,S=e.cubemap.layers.length;S>u;u++)l=e.cubemap.layers[u],h.push("envColor = textureCube(SCENEJS_uCubeMapSampler"+u+", envLookup);"),h.push("color = mix(color, envColor.rgb, specular * SCENEJS_uCubeMapIntensity"+u+");");h.push("}")}if(h.push("  vec4    fragColor;"),a){h.push("if (SCENEJS_uBackfaceLighting || dot(viewNormalVec, SCENEJS_vViewEyeVec) > 0.0) {"),h.push("  vec3    lightValue      = vec3(0.0, 0.0, 0.0);"),h.push("  vec3    specularValue   = vec3(0.0, 0.0, 0.0);"),h.push("  vec3    viewLightVec;"),h.push("  float   dotN;"),h.push("  float   lightDist;");for(var p,u=0,S=e.lights.lights.length;S>u;u++)p=e.lights.lights[u],"ambient"!=p.mode&&(h.push("viewLightVec = SCENEJS_vViewLightVecAndDist"+u+".xyz;"),"point"==p.mode&&(h.push("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),h.push("lightDist = SCENEJS_vViewLightVecAndDist"+u+".w;"),h.push("attenuation = 1.0 - (  SCENEJS_uLightAttenuation"+u+"[0] +   SCENEJS_uLightAttenuation"+u+"[1] * lightDist +   SCENEJS_uLightAttenuation"+u+"[2] * lightDist * lightDist);"),p.diffuse&&(h.push("if (SCENEJS_uDiffuse) {"),h.push("      lightValue += dotN * SCENEJS_uLightColor"+u+" * attenuation;"),h.push("}")),p.specular&&(h.push("if (SCENEJS_uSpecularLighting) {"),h.push("    specularValue += specularColor * SCENEJS_uLightColor"+u+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-SCENEJS_vViewVertex.xyz)), 0.0), shine) * attenuation;"),h.push("}"))),"dir"==p.mode&&(h.push("dotN = max(dot(normalize(viewNormalVec), normalize(viewLightVec)), 0.0);"),p.diffuse&&(h.push("if (SCENEJS_uDiffuse) {"),h.push("      lightValue += dotN * SCENEJS_uLightColor"+u+";"),h.push("}")),p.specular&&(h.push("if (SCENEJS_uSpecularLighting) {"),h.push("    specularValue += specularColor * SCENEJS_uLightColor"+u+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-SCENEJS_vViewVertex.xyz)), 0.0), shine);"),h.push("}"))));h.push("      fragColor = vec4((specularValue.rgb + color.rgb * (lightValue.rgb + ambient.rgb)) + (emit * color.rgb), alpha);"),h.push("   } else {"),h.push("      fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);"),h.push("   }")}else h.push("fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);");return n.pixelColor&&h.push("fragColor="+n.pixelColor+"(fragColor);"),h.push("    if (SCENEJS_uDepthMode) {"),h.push("          float depth = length(SCENEJS_vViewVertex) / (SCENEJS_uZFar - SCENEJS_uZNear);"),h.push("          const vec4 bias = vec4(1.0 / 255.0,"),h.push("          1.0 / 255.0,"),h.push("          1.0 / 255.0,"),h.push("          0.0);"),h.push("          float r = depth;"),h.push("          float g = fract(r * 255.0);"),h.push("          float b = fract(g * 255.0);"),h.push("          float a = fract(b * 255.0);"),h.push("          vec4 colour = vec4(r, g, b, a);"),h.push("          gl_FragColor = colour - (colour.yzww * bias);"),h.push("    } else {"),h.push("          gl_FragColor = fragColor;"),h.push("    };"),h.push("}"),h}},SceneJS_ProgramSource=function(e,t,r,n,i){this.hash=e,this.pickVertexSrc=t,this.pickFragmentSrc=r,this.drawVertexSrc=n,this.drawFragmentSrc=i,this.useCount=0},SceneJS_ProgramFactory=function(e){this._canvas=e.canvas,this._programs={},this._nextProgramId=0};SceneJS_ProgramFactory.prototype.getProgram=function(e,t){var r=this._programs[e];if(!r){var n=SceneJS_ProgramSourceFactory.getSource(e,t);r=new SceneJS_Program(this._nextProgramId++,e,n,this._canvas.gl),this._programs[e]=r}return r.useCount++,r},SceneJS_ProgramFactory.prototype.putProgram=function(e){--e.useCount<=0&&(e.draw.destroy(),e.pick.destroy(),SceneJS_ProgramSourceFactory.putSource(e.hash),delete this._programs[e.hash])},SceneJS_ProgramFactory.prototype.webglRestored=function(){var e,t=this._canvas.gl;for(var r in this._programs)this._programs.hasOwnProperty(r)&&(e=this._programs[r],e&&e.build&&e.build(t))},SceneJS_ProgramFactory.prototype.destroy=function(){};var SceneJS_Program=function(e,t,r,n){this.id=e,this.hash=r.hash,this.source=r,this.gl=n,this.draw=null,this.pick=null,this.useCount=0,this.build(n)};SceneJS_Program.prototype.build=function(e){this.drawUniformFlags=0,this.gl=e,this.draw=new SceneJS._webgl.Program(e,[this.source.drawVertexSrc.join("\n")],[this.source.drawFragmentSrc.join("\n")]),this.pick=new SceneJS._webgl.Program(e,[this.source.pickVertexSrc.join("\n")],[this.source.pickFragmentSrc.join("\n")])};var SceneJS_ObjectFactory=function(){};SceneJS_ObjectFactory.prototype._freeObjects=[],SceneJS_ObjectFactory.prototype._numFreeObjects=0,SceneJS_ObjectFactory.prototype.getObject=function(e){var t;return this._numFreeObjects>0?(t=this._freeObjects[--this._numFreeObjects],t.id=e,t):new SceneJS_Object(e)},SceneJS_ObjectFactory.prototype.putObject=function(e){this._freeObjects[this._numFreeObjects++]=e};var SceneJS_Object=function(e){this.id=e,this.hash=null,this.sortKey=null,this.chunks=[],this.chunksLen=0,this.program=null,this.layer=null,this.texture=null,this.flags=null,this.tag=null};SceneJS.RenderContext=function(e){this._frameCtx=e
},SceneJS.RenderContext.prototype.getCameraMatrix=function(){return this._frameCtx.cameraMat},SceneJS.RenderContext.prototype.getViewMatrix=function(){return this._frameCtx.viewMat},SceneJS.RenderContext.prototype.getModelMatrix=function(){return this._frameCtx.modelMat},SceneJS.RenderContext.prototype.getCanvasPos=function(e){this.getProjPos(e);var t=this._frameCtx.canvas.canvas,r=t.width,n=t.height,i=this._pc,o=i[0]/i[3]*r*.5,a=i[1]/i[3]*n*.5;return{x:o+.5*r,y:n-a-.5*n}},SceneJS.RenderContext.prototype.getCameraPos=function(e){return this.getProjPos(e),this._camPos=SceneJS_math_normalizeVec3(this._pc,[0,0,0]),{x:this._camPos[0],y:this._camPos[1],z:this._camPos[2]}},SceneJS.RenderContext.prototype.getProjPos=function(e){return this.getViewPos(e),this._pc=SceneJS_math_transformPoint3(this._frameCtx.cameraMat,this._vc),{x:this._pc[0],y:this._pc[1],z:this._pc[2],w:this._pc[3]}},SceneJS.RenderContext.prototype.getViewPos=function(e){return this.getWorldPos(e),this._vc=SceneJS_math_transformPoint3(this._frameCtx.viewMat,this._wc),{x:this._vc[0],y:this._vc[1],z:this._vc[2],w:this._vc[3]}},SceneJS.RenderContext.prototype.getWorldPos=function(e){return this._wc=SceneJS_math_transformPoint3(this._frameCtx.modelMat,e||[0,0,0]),{x:this._wc[0],y:this._wc[1],z:this._wc[2],w:this._wc[3]}};var SceneJS_Chunk=function(){};SceneJS_Chunk.prototype.init=function(e,t,r,n){this.id=e,this.program=t,this.core=r,this.core2=n,this.build&&this.build()};var SceneJS_ChunkFactory=function(){this._chunks={},this.chunkTypes=SceneJS_ChunkFactory.chunkTypes};SceneJS_ChunkFactory.chunkTypes={},SceneJS_ChunkFactory._freeChunks={},SceneJS_ChunkFactory.createChunkType=function(e){if(!e.type)throw"'type' expected in params";var t=SceneJS_Chunk,r=function(){this.useCount=0,this.init.apply(this,arguments)};return r.prototype=new t,r.prototype.constructor=r,e.drawAndPick&&(e.draw=e.pick=e.drawAndPick),SceneJS_ChunkFactory.chunkTypes[e.type]=r,SceneJS._apply(e,r.prototype),SceneJS_ChunkFactory._freeChunks[e.type]={chunks:[],chunksLen:0},r},SceneJS_ChunkFactory.prototype.getChunk=function(e,t,r,n,i){var o=SceneJS_ChunkFactory.chunkTypes[t];if(!o)throw"chunk type not supported: '"+t+"'";var a=this._chunks[e];if(a)return a.useCount++,a;var s=SceneJS_ChunkFactory._freeChunks[t];return s.chunksLen>0&&(a=s.chunks[--s.chunksLen]),a?a.init(e,r,n,i):a=new o(e,r,n,i),a.type=t,a.useCount=1,this._chunks[e]=a,a},SceneJS_ChunkFactory.prototype.putChunk=function(e){if(0!=e.useCount&&--e.useCount<=0){e.recycle&&e.recycle(),delete this._chunks[e.id];var t=SceneJS_ChunkFactory._freeChunks[e.type];t.chunks[t.chunksLen++]=e}},SceneJS_ChunkFactory.prototype.webglRestored=function(){var e;for(var t in this._chunks)this._chunks.hasOwnProperty(t)&&(e=this._chunks[t],e&&e.build&&e.build())},SceneJS_ChunkFactory.createChunkType({type:"camera",build:function(){this._uPMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uPMatrix"),this._uZNearDraw=this.program.draw.getUniformLocation("SCENEJS_uZNear"),this._uZFarDraw=this.program.draw.getUniformLocation("SCENEJS_uZFar"),this._uPMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uPMatrix"),this._uZNearPick=this.program.pick.getUniformLocation("SCENEJS_uZNear"),this._uZFarPick=this.program.pick.getUniformLocation("SCENEJS_uZFar")},draw:function(e){this.core.checkAspect&&this.core.checkAspect(this.core,e.aspect);var t=this.program.gl;this._uPMatrixDraw&&t.uniformMatrix4fv(this._uPMatrixDraw,t.FALSE,this.core.mat),this._uZNearDraw&&t.uniform1f(this._uZNearDraw,this.core.optics.near),this._uZFarDraw&&t.uniform1f(this._uZFarDraw,this.core.optics.far),e.cameraMat=this.core.mat},pick:function(e){this.core.checkAspect&&this.core.checkAspect(this.core,e.aspect);var t=this.program.gl;this._uPMatrixPick&&t.uniformMatrix4fv(this._uPMatrixPick,t.FALSE,this.core.mat),e.rayPick&&(this._uZNearPick&&t.uniform1f(this._uZNearPick,this.core.optics.near),this._uZFarPick&&t.uniform1f(this._uZFarPick,this.core.optics.far)),e.cameraMat=this.core.mat}}),SceneJS_ChunkFactory.createChunkType({type:"clips",build:function(){this._draw=this._draw||[];for(var e=this.program.draw,t=0,r=this.core.clips.length;r>t;t++)this._draw[t]={uClipMode:e.getUniformLocation("SCENEJS_uClipMode"+t),uClipNormalAndDist:e.getUniformLocation("SCENEJS_uClipNormalAndDist"+t)};this._pick=this._pick||[];for(var n=this.program.pick,t=0,r=this.core.clips.length;r>t;t++)this._pick[t]={uClipMode:n.getUniformLocation("SCENEJS_uClipMode"+t),uClipNormalAndDist:n.getUniformLocation("SCENEJS_uClipNormalAndDist"+t)}},drawAndPick:function(e){for(var t,r,n,i=e.pick?this._pick:this._draw,o=this.core.clips,a=this.program.gl,s=0,c=o.length;c>s;s++)e.pick?(t=i[s].uClipMode,r=i[s].uClipNormalAndDist):(t=i[s].uClipMode,r=i[s].uClipNormalAndDist),t&&r&&(n=o[s],"inside"==n.mode?(a.uniform1f(t,2),a.uniform4fv(r,n.normalAndDist)):"outside"==n.mode?(a.uniform1f(t,1),a.uniform4fv(r,n.normalAndDist)):a.uniform1f(t,0))}}),SceneJS_ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._depthModeDraw=this.program.draw.getUniformLocation("SCENEJS_uDepthMode"),this._depthModePick=this.program.pick.getUniformLocation("SCENEJS_uDepthMode")},drawAndPick:function(e){var t=this.program.gl;t.uniform1i(e.pick?this._depthModePick:this._depthModeDraw,e.depthMode),t.drawElements(this.core.primitive,this.core.indexBuf.numItems,t.UNSIGNED_SHORT,0)}}),SceneJS_ChunkFactory.createChunkType({type:"flags",build:function(){var e=this.program.draw;this._uBackfaceTexturingDraw=e.getUniformLocation("SCENEJS_uBackfaceTexturing"),this._uBackfaceLightingDraw=e.getUniformLocation("SCENEJS_uBackfaceLighting"),this._uSpecularLightingDraw=e.getUniformLocation("SCENEJS_uSpecularLighting"),this._uClippingDraw=e.getUniformLocation("SCENEJS_uClipping"),this._uAmbientDraw=e.getUniformLocation("SCENEJS_uAmbient"),this._uDiffuseDraw=e.getUniformLocation("SCENEJS_uDiffuse"),this._uReflectionDraw=e.getUniformLocation("SCENEJS_uReflection");var t=this.program.pick;this._uClippingPick=t.getUniformLocation("SCENEJS_uClipping")},drawAndPick:function(e){var t=this.program.gl,r=this.core.backfaces;e.backfaces!=r&&(r?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),e.backfaces=r);var n=this.core.frontface;e.frontface!=n&&(t.frontFace("ccw"==n?t.CCW:t.CW),e.frontface=n);var i=this.core.transparent;if(e.transparent!=i&&(e.pick||(i?(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),e.blendEnabled=!0):(t.disable(t.BLEND),e.blendEnabled=!1)),e.transparent=i),e.pick)t.uniform1i(this._uClippingPick,this.core.clipping);else{var o=(this.core.backfaceTexturing?1:0)+(this.core.backfaceLighting?2:0)+(this.core.specular?4:0)+(this.core.clipping?8:0)+(this.core.ambient?16:0)+(this.core.diffuse?32:0)+(this.core.reflection?64:0);this.program.drawUniformFlags!=o&&(t.uniform1i(this._uBackfaceTexturingDraw,this.core.backfaceTexturing),t.uniform1i(this._uBackfaceLightingDraw,this.core.backfaceLighting),t.uniform1i(this._uSpecularLightingDraw,this.core.specular),t.uniform1i(this._uClippingDraw,this.core.clipping),t.uniform1i(this._uAmbientDraw,this.core.ambient),t.uniform1i(this._uDiffuseDraw,this.core.diffuse),t.uniform1i(this._uReflectionDraw,this.core.reflection),this.program.drawUniformFlags=o)}}}),SceneJS_ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(e){var t=this.program.gl;e.renderBuf&&(t.flush(),e.renderBuf.unbind(),e.renderBuf=null);var r=this.core.renderBuf;return r?(r.bind(),e.depthMode="depth"===this.core.bufType,e.depthMode||e.blendEnabled&&(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(e.ambientColor[0],e.ambientColor[1],e.ambientColor[2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),void(e.renderBuf=r)):void(e.depthMode=!1)}}),SceneJS_ChunkFactory.createChunkType({type:"geometry",build:function(){var e=this.program.draw;this._aVertexDraw=e.getAttribute("SCENEJS_aVertex"),this._aNormalDraw=e.getAttribute("SCENEJS_aNormal"),this._aUVDraw=e.getAttribute("SCENEJS_aUVCoord"),this._aUV2Draw=e.getAttribute("SCENEJS_aUVCoord2"),this._aTangentDraw=e.getAttribute("SCENEJS_aTangent"),this._aColorDraw=e.getAttribute("SCENEJS_aVertexColor"),this._aMorphVertexDraw=e.getAttribute("SCENEJS_aMorphVertex"),this._aMorphNormalDraw=e.getAttribute("SCENEJS_aMorphNormal"),this._uMorphFactorDraw=e.getUniformLocation("SCENEJS_uMorphFactor");var t=this.program.pick;this._aVertexPick=t.getAttribute("SCENEJS_aVertex"),this._aMorphVertexPick=t.getAttribute("SCENEJS_aMorphVertex"),this._uMorphFactorPick=t.getUniformLocation("SCENEJS_uMorphFactor"),this.VAO=null,this.VAOMorphKey1=0,this.VAOMorphKey2=0,this.VAOHasInterleavedBuf=!1},recycle:function(){if(this.VAO){var e=this.program.gl.getExtension("OES_vertex_array_object");e.deleteVertexArrayOES(this.VAO),this.VAO=null}},morphDraw:function(){this.VAOMorphKey1=this.core.key1,this.VAOMorphKey2=this.core.key2;var e=this.core.targets[this.core.key1],t=this.core.targets[this.core.key2];this._aMorphVertexDraw?(this._aVertexDraw.bindFloatArrayBuffer(e.vertexBuf),this._aMorphVertexDraw.bindFloatArrayBuffer(t.vertexBuf)):this._aVertexDraw&&this._aVertexDraw.bindFloatArrayBuffer(this.core2.vertexBuf),this._aMorphNormalDraw?(this._aNormalDraw.bindFloatArrayBuffer(e.normalBuf),this._aMorphNormalDraw.bindFloatArrayBuffer(t.normalBuf)):this._aNormalDraw&&this._aNormalDraw.bindFloatArrayBuffer(this.core2.normalBuf),this._aUVDraw&&this._aUVDraw.bindFloatArrayBuffer(this.core2.uvBuf),this._aUV2Draw&&this._aUV2Draw.bindFloatArrayBuffer(this.core2.uvBuf2),this._aColorDraw&&this._aColorDraw.bindFloatArrayBuffer(this.core2.colorBuf),this.setDrawMorphFactor()},setDrawMorphFactor:function(){this._uMorphFactorDraw&&this.program.gl.uniform1f(this._uMorphFactorDraw,this.core.factor)},draw:function(e){var t=this.core.targets&&this.core.targets.length,r=this.core2.interleavedBuf&&!this.core2.interleavedBuf.dirty;if(this.VAO){if(e.VAO.bindVertexArrayOES(this.VAO),t){if(this.VAOMorphKey1==this.core.key1&&this.VAOMorphKey2==this.core.key2)return void this.setDrawMorphFactor()}else if(r||!this.VAOHasInterleavedBuf)return}else if(e.VAO){e.VAO.bindVertexArrayOES(null),this.VAO=e.VAO.createVertexArrayOES(),e.VAO.bindVertexArrayOES(this.VAO);{this.program.gl}}t?this.morphDraw():r?(this.VAOHasInterleavedBuf=!0,this.core2.interleavedBuf.bind(),this._aVertexDraw&&this._aVertexDraw.bindInterleavedFloatArrayBuffer(3,this.core2.interleavedStride,this.core2.interleavedPositionOffset),this._aNormalDraw&&this._aNormalDraw.bindInterleavedFloatArrayBuffer(3,this.core2.interleavedStride,this.core2.interleavedNormalOffset),this._aUVDraw&&this._aUVDraw.bindInterleavedFloatArrayBuffer(2,this.core2.interleavedStride,this.core2.interleavedUVOffset),this._aUV2Draw&&this._aUV2Draw.bindInterleavedFloatArrayBuffer(2,this.core2.interleavedStride,this.core2.interleavedUV2Offset),this._aColorDraw&&this._aColorDraw.bindInterleavedFloatArrayBuffer(4,this.core2.interleavedStride,this.core2.interleavedColorOffset),this._aTangentDraw&&this._aTangentDraw.bindFloatArrayBuffer(this.core2.tangentBuf||this.core2.getTangentBuf())):(this.VAOHasInterleavedBuf=!1,this._aVertexDraw&&this._aVertexDraw.bindFloatArrayBuffer(this.core2.vertexBuf),this._aNormalDraw&&this._aNormalDraw.bindFloatArrayBuffer(this.core2.normalBuf),this._aUVDraw&&this._aUVDraw.bindFloatArrayBuffer(this.core2.uvBuf),this._aUV2Draw&&this._aUV2Draw.bindFloatArrayBuffer(this.core2.uvBuf2),this._aColorDraw&&this._aColorDraw.bindFloatArrayBuffer(this.core2.colorBuf),this._aTangentDraw&&this._aTangentDraw.bindFloatArrayBuffer(this.core2.tangentBuf||this.core2.getTangentBuf())),this.core2.indexBuf.bind()},morphPick:function(){var e=this.core.targets[this.core.key1],t=this.core.targets[this.core.key2];this._aMorphVertexPick?(this._aVertexPick.bindFloatArrayBuffer(e.vertexBuf),this._aMorphVertexPick.bindFloatArrayBuffer(t.vertexBuf)):this._aVertexPick&&this._aVertexPick.bindFloatArrayBuffer(this.core2.vertexBuf),this._uMorphFactorPick&&this.program.gl.uniform1f(this._uMorphFactorPick,this.core.factor)},pick:function(){this.core.targets&&this.core.targets.length?this.morphPick():this._aVertexPick&&this._aVertexPick.bindFloatArrayBuffer(this.core2.vertexBuf),this.core2.indexBuf.bind()}}),SceneJS_ChunkFactory.createChunkType({type:"lights",build:function(){this._uAmbientColor=this._uAmbientColor||[],this._uLightColor=this._uLightColor||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightCutOff=this._uLightCutOff||[],this._uLightSpotExp=this._uLightSpotExp||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var e=this.core.lights,t=this.program,r=0,n=e.length;n>r;r++)switch(e[r].mode){case"ambient":this._uAmbientColor[r]=t.draw.getUniformLocation("SCENEJS_uAmbientColor");break;case"dir":this._uLightColor[r]=t.draw.getUniformLocation("SCENEJS_uLightColor"+r),this._uLightPos[r]=null,this._uLightDir[r]=t.draw.getUniformLocation("SCENEJS_uLightDir"+r);break;case"point":this._uLightColor[r]=t.draw.getUniformLocation("SCENEJS_uLightColor"+r),this._uLightPos[r]=t.draw.getUniformLocation("SCENEJS_uLightPos"+r),this._uLightDir[r]=null,this._uLightAttenuation[r]=t.draw.getUniformLocation("SCENEJS_uLightAttenuation"+r)}},draw:function(e){e.dirty&&this.build();for(var t,r=this.core.lights,n=this.program.gl,i=0,o=r.length;o>i;i++)t=r[i],this._uAmbientColor[i]?n.uniform3fv(this._uAmbientColor[i],t.color):(this._uLightColor[i]&&n.uniform3fv(this._uLightColor[i],t.color),this._uLightPos[i]&&(n.uniform3fv(this._uLightPos[i],t.pos),this._uLightAttenuation[i]&&n.uniform3fv(this._uLightAttenuation[i],t.attenuation)),this._uLightDir[i]&&n.uniform3fv(this._uLightDir[i],t.dir))}}),SceneJS_ChunkFactory.createChunkType({type:"listeners",programGlobal:!0,build:function(){},draw:function(e){for(var t=this.core.listeners,r=e.renderListenerCtx,n=t.length-1;n>=0;n--)if(t[n](r)===!0)return!0}}),SceneJS_ChunkFactory.createChunkType({type:"lookAt",build:function(){this._uvMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVMatrix"),this._uVNMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVNMatrix"),this._uWorldEyeDraw=this.program.draw.getUniformLocation("SCENEJS_uWorldEye"),this._uvMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uVMatrix")},draw:function(e){this.core.dirty&&this.core.rebuild();var t=this.program.gl;this._uvMatrixDraw&&t.uniformMatrix4fv(this._uvMatrixDraw,t.FALSE,this.core.mat),this._uVNMatrixDraw&&t.uniformMatrix4fv(this._uVNMatrixDraw,t.FALSE,this.core.normalMat),this._uWorldEyeDraw&&t.uniform3fv(this._uWorldEyeDraw,this.core.lookAt.eye),e.viewMat=this.core.mat},pick:function(e){var t=this.program.gl;this._uvMatrixPick&&t.uniformMatrix4fv(this._uvMatrixPick,t.FALSE,this.core.mat),e.viewMat=this.core.mat}}),SceneJS_ChunkFactory.createChunkType({type:"material",build:function(){var e=this.program.draw;this._uMaterialBaseColor=e.getUniformLocation("SCENEJS_uMaterialColor"),this._uMaterialSpecularColor=e.getUniformLocation("SCENEJS_uMaterialSpecularColor"),this._uMaterialSpecular=e.getUniformLocation("SCENEJS_uMaterialSpecular"),this._uMaterialShine=e.getUniformLocation("SCENEJS_uMaterialShine"),this._uMaterialEmit=e.getUniformLocation("SCENEJS_uMaterialEmit"),this._uMaterialAlpha=e.getUniformLocation("SCENEJS_uMaterialAlpha")},draw:function(){var e=this.program.gl,t=this.program.draw.materialSettings;this._uMaterialBaseColor&&e.uniform3fv(this._uMaterialBaseColor,this.core.baseColor),!this._uMaterialSpecularColor||t.specularColor[0]==this.core.specularColor[0]&&t.specularColor[1]==this.core.specularColor[1]&&t.specularColor[2]==this.core.specularColor[2]||(e.uniform3fv(this._uMaterialSpecularColor,this.core.specularColor),t.specularColor[0]=this.core.specularColor[0],t.specularColor[1]=this.core.specularColor[1],t.specularColor[2]=this.core.specularColor[2]),this._uMaterialSpecular&&t.specular!=this.core.specular&&(e.uniform1f(this._uMaterialSpecular,this.core.specular),t.specular=this.core.specular),this._uMaterialShine&&t.shine!=this.core.shine&&(e.uniform1f(this._uMaterialShine,this.core.shine),t.shine=this.core.shine),this._uMaterialEmit&&t.emit!=this.core.emit&&(e.uniform1f(this._uMaterialEmit,this.core.emit),t.emit=this.core.emit),this._uMaterialAlpha&&t.alpha!=this.core.alpha&&(e.uniform1f(this._uMaterialAlpha,this.core.alpha),t.alpha=this.core.alpha)}}),SceneJS_ChunkFactory.createChunkType({type:"name",build:function(){this._uPickColor=this.program.pick.getUniformLocation("SCENEJS_uPickColor")},pick:function(e){if(this._uPickColor&&this.core.name){e.pickNames[e.pickIndex++]=this.core;var t=e.pickIndex>>16&255,r=e.pickIndex>>8&255,n=255&e.pickIndex;this.program.gl.uniform3fv(this._uPickColor,[n/255,r/255,t/255])}}}),SceneJS_ChunkFactory.createChunkType({type:"program",build:function(){this._depthModeDraw=this.program.draw.getUniformLocation("SCENEJS_uDepthMode"),this._depthModePick=this.program.pick.getUniformLocation("SCENEJS_uDepthMode"),this._rayPickMode=this.program.pick.getUniformLocation("SCENEJS_uRayPickMode")},draw:function(e){var t=this.program.draw;t.bind(),e.textureUnit=0;var r=this.program.gl;if(r.uniform1i(this._depthModeDraw,e.depthMode),!e.VAO)for(var n=0;10>n;n++)r.disableVertexAttribArray(n);e.drawProgram=this.program.draw},pick:function(e){var t=this.program.pick;t.bind();var r=this.program.gl;r.uniform1i(this._rayPickMode,e.rayPick),r.uniform1i(this._depthModePick,e.depthMode),e.textureUnit=0;for(var n=0;10>n;n++)r.disableVertexAttribArray(n)}}),SceneJS_ChunkFactory.createChunkType({type:"renderer",build:function(){},drawAndPick:function(e){if(this.core.props){var t=this.program.gl;e.renderer&&(e.renderer.props.restoreProps(t),e.renderer=this.core),this.core.props.setProps(t)}}}),SceneJS_ChunkFactory.createChunkType({type:"depthBuffer",programGlobal:!0,drawAndPick:function(e){var t=this.program.gl,r=this.core.enabled;e.depthbufEnabled!=r&&(r?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),e.depthbufEnabled=r);var n=this.core.clearDepth;e.clearDepth!=n&&(t.clearDepth(n),e.clearDepth=n);var i=this.core.depthFunc;e.depthFunc!=i&&(t.depthFunc(i),e.depthFunc=i),this.core.clear&&t.clear(t.DEPTH_BUFFER_BIT)}}),SceneJS_ChunkFactory.createChunkType({type:"colorBuffer",programGlobal:!0,build:function(){},drawAndPick:function(e){if(!e.transparent){var t=this.core.blendEnabled,r=this.program.gl;e.blendEnabled!=t&&(t?r.enable(r.BLEND):r.disable(r.BLEND),e.blendEnabled=t);var n=this.core.colorMask;r.colorMask(n.r,n.g,n.b,n.a)}}}),SceneJS_ChunkFactory.createChunkType({type:"view",programGlobal:!0,build:function(){},drawAndPick:function(e){var t=this.core.scissorTestEnabled;if(e.scissorTestEnabled!=t){var r=this.program.gl;t?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),e.scissorTestEnabled=t}}}),SceneJS_ChunkFactory.createChunkType({type:"shader",build:function(){},drawAndPick:function(e){var t=this.core.paramsStack;if(t)for(var r,n,i=e.pick?this.program.pick:this.program.draw,o=0,a=t.length;a>o;o++){r=t[o];for(n in r)r.hasOwnProperty(n)&&i.setUniform(n,r[n])}}}),SceneJS_ChunkFactory.createChunkType({type:"shaderParams",build:function(){},drawAndPick:function(e){var t=this.core.paramsStack;if(t)for(var r,n,i=e.pick?this.program.pick:this.program.draw,o=0,a=t.length;a>o;o++){r=t[o];for(n in r)r.hasOwnProperty(n)&&i.setUniform(n,r[n])}}}),SceneJS_ChunkFactory.createChunkType({type:"style",programGlobal:!0,drawAndPick:function(e){var t=this.core.lineWidth;if(e.lineWidth!=t){var r=this.program.gl;r.lineWidth(t),e.lineWidth=t}}}),SceneJS_ChunkFactory.createChunkType({type:"texture",build:function(){this._uTexSampler=this._uTexSampler||[],this._uTexMatrix=this._uTexMatrix||[],this._uTexBlendFactor=this._uTexBlendFactor||[];var e=this.core.layers;if(e)for(var t,r=this.program.draw,n=0,i=e.length;i>n;n++)t=e[n],this._uTexSampler[n]="SCENEJS_uSampler"+n,this._uTexMatrix[n]=r.getUniform("SCENEJS_uLayer"+n+"Matrix"),this._uTexBlendFactor[n]=r.getUniform("SCENEJS_uLayer"+n+"BlendFactor")},draw:function(e){e.textureUnit=0;var t=this.core.layers;if(t)for(var r,n=this.program.draw,i=0,o=t.length;o>i;i++)r=t[i],this._uTexSampler[i]&&r.texture&&(n.bindTexture(this._uTexSampler[i],r.texture,e.textureUnit++),r._matrixDirty&&r.buildMatrix&&r.buildMatrix.call(r),this._uTexMatrix[i]&&this._uTexMatrix[i].setValue(r.matrixAsArray),this._uTexBlendFactor[i]&&this._uTexBlendFactor[i].setValue(r.blendFactor));e.textureUnit>10&&(e.textureUnit=0)}}),SceneJS_ChunkFactory.createChunkType({type:"cubemap",build:function(){this._uCubeMapSampler=this._uCubeMapSampler||[],this._uCubeMapIntensity=this._uCubeMapIntensity||[];var e=this.core.layers;if(e)for(var t,r=this.program.draw,n=0,i=e.length;i>n;n++)t=e[n],this._uCubeMapSampler[n]="SCENEJS_uCubeMapSampler"+n,this._uCubeMapIntensity[n]=r.getUniform("SCENEJS_uCubeMapIntensity"+n)},draw:function(e){var t=this.core.layers;if(t)for(var r,n=this.program.draw,i=0,o=t.length;o>i;i++)r=t[i],this._uCubeMapSampler[i]&&r.texture&&(n.bindTexture(this._uCubeMapSampler[i],r.texture,e.textureUnit++),this._uCubeMapIntensity[i]&&this._uCubeMapIntensity[i].setValue(r.intensity));e.textureUnit>10&&(e.textureUnit=0)}}),SceneJS_ChunkFactory.createChunkType({type:"xform",build:function(){var e=this.program.draw;this._uMatLocationDraw=e.getUniformLocation("SCENEJS_uMMatrix"),this._uNormalMatLocationDraw=e.getUniformLocation("SCENEJS_uMNMatrix");var t=this.program.pick;this._uMatLocationPick=t.getUniformLocation("SCENEJS_uMMatrix")},draw:function(e){(SceneJS_configsModule.configs.forceXFormCoreRebuild===!0||this.core.dirty&&this.core.build)&&this.core.build();var t=this.program.gl;this._uMatLocationDraw&&t.uniformMatrix4fv(this._uMatLocationDraw,t.FALSE,this.core.mat),this._uNormalMatLocationDraw&&t.uniformMatrix4fv(this._uNormalMatLocationDraw,t.FALSE,this.core.normalMat),e.modelMat=this.core.mat},pick:function(e){this.core.dirty&&this.core.build();var t=this.program.gl;this._uMatLocationPick&&t.uniformMatrix4fv(this._uMatLocationPick,t.FALSE,this.core.mat),e.modelMat=this.core.mat}}),SceneJS.configure({pluginPath:"http://scenejs.org/api/latest/plugins"});